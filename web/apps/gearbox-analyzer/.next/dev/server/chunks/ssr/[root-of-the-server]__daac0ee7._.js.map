{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/stores/drivetrain-store.ts"],"sourcesContent":["\"use client\";\n\nimport { create } from \"zustand\";\nimport {\n  type Node,\n  type Edge,\n  type XYPosition,\n  applyNodeChanges,\n  applyEdgeChanges,\n  type NodeChange,\n  type EdgeChange,\n} from \"@xyflow/react\";\n\n/**\n * Component types available in the palette.\n */\nexport type ComponentType =\n  | \"engine\"\n  | \"motor\"\n  | \"gearbox\"\n  | \"planetary\"\n  | \"battery\"\n  | \"vehicle\";\n\n/**\n * Base node data shared by all component nodes.\n */\nexport interface BaseNodeData {\n  label: string;\n  componentType: ComponentType;\n  params: Record<string, unknown>;\n}\n\n/**\n * Port definition for connection validation.\n */\nexport interface PortDefinition {\n  id: string;\n  type: \"mechanical\" | \"electrical\";\n  position: \"left\" | \"right\" | \"top\" | \"bottom\";\n}\n\n/**\n * Validation result for the topology.\n */\nexport interface ValidationResult {\n  isValid: boolean;\n  errors: string[];\n}\n\n/**\n * Preset configuration names.\n */\nexport type PresetName = \"diesel-793d\" | \"ecvt-split\" | \"ecvt-locked\";\n\ninterface DrivetrainState {\n  nodes: Node<BaseNodeData>[];\n  edges: Edge[];\n  selectedNodeId: string | null;\n\n  // Actions\n  addNode: (type: ComponentType, position: XYPosition) => void;\n  removeNode: (id: string) => void;\n  updateNodeParams: (id: string, params: Record<string, unknown>) => void;\n  setSelectedNode: (id: string | null) => void;\n  onNodesChange: (changes: NodeChange<Node<BaseNodeData>>[]) => void;\n  onEdgesChange: (changes: EdgeChange[]) => void;\n  addEdge: (edge: Edge) => void;\n  removeEdge: (id: string) => void;\n  validateTopology: () => ValidationResult;\n  loadPreset: (name: PresetName) => void;\n  clearAll: () => void;\n}\n\n// Default parameters for each component type\nconst DEFAULT_PARAMS: Record<ComponentType, Record<string, unknown>> = {\n  engine: {\n    rpmIdle: 700,\n    rpmMax: 1800,\n    pRated: 1801000,\n    tPeak: 11220,\n  },\n  motor: {\n    pMax: 200000,\n    tMax: 3000,\n    rpmMax: 6000,\n    eta: 0.92,\n  },\n  gearbox: {\n    ratios: [4.59, 2.95, 1.94, 1.40, 1.0, 0.74, 0.65],\n    efficiencies: [0.97, 0.97, 0.97, 0.97, 0.97, 0.97, 0.97],\n  },\n  planetary: {\n    zSun: 30,\n    zRing: 90,\n  },\n  battery: {\n    capacityKwh: 200,\n    vNom: 700,\n    pMaxDischarge: 1000000,\n    pMaxCharge: 500000,\n    socInit: 0.6,\n  },\n  vehicle: {\n    mEmpty: 159350,\n    mPayload: 190000,\n    rWheel: 1.78,\n    cR: 0.025,\n    vMax: 15.0,\n  },\n};\n\n// Counter for unique node IDs\nlet nodeIdCounter = 1;\n\nexport const useDrivetrainStore = create<DrivetrainState>((set, get) => ({\n  nodes: [],\n  edges: [],\n  selectedNodeId: null,\n\n  addNode: (type, position) => {\n    const id = `${type}-${nodeIdCounter++}`;\n    const newNode: Node<BaseNodeData> = {\n      id,\n      type: `${type}Node`,\n      position,\n      data: {\n        label: `${type.charAt(0).toUpperCase() + type.slice(1)} ${nodeIdCounter - 1}`,\n        componentType: type,\n        params: { ...DEFAULT_PARAMS[type] },\n      },\n    };\n\n    set((state) => ({\n      nodes: [...state.nodes, newNode],\n    }));\n  },\n\n  removeNode: (id) => {\n    set((state) => ({\n      nodes: state.nodes.filter((n) => n.id !== id),\n      edges: state.edges.filter((e) => e.source !== id && e.target !== id),\n      selectedNodeId: state.selectedNodeId === id ? null : state.selectedNodeId,\n    }));\n  },\n\n  updateNodeParams: (id, params) => {\n    set((state) => ({\n      nodes: state.nodes.map((node) =>\n        node.id === id\n          ? { ...node, data: { ...node.data, params: { ...node.data.params, ...params } } }\n          : node\n      ),\n    }));\n  },\n\n  setSelectedNode: (id) => {\n    set({ selectedNodeId: id });\n  },\n\n  onNodesChange: (changes) => {\n    set((state) => ({\n      nodes: applyNodeChanges(changes, state.nodes),\n    }));\n  },\n\n  onEdgesChange: (changes) => {\n    set((state) => ({\n      edges: applyEdgeChanges(changes, state.edges),\n    }));\n  },\n\n  addEdge: (edge) => {\n    set((state) => ({\n      edges: [...state.edges, edge],\n    }));\n  },\n\n  removeEdge: (id) => {\n    set((state) => ({\n      edges: state.edges.filter((e) => e.id !== id),\n    }));\n  },\n\n  validateTopology: () => {\n    const { nodes, edges } = get();\n    const errors: string[] = [];\n\n    // Check for at least one engine or motor\n    const hasActuator = nodes.some(\n      (n) => n.data.componentType === \"engine\" || n.data.componentType === \"motor\"\n    );\n    if (!hasActuator) {\n      errors.push(\"Topology needs at least one engine or motor\");\n    }\n\n    // Check for vehicle component\n    const hasVehicle = nodes.some((n) => n.data.componentType === \"vehicle\");\n    if (!hasVehicle) {\n      errors.push(\"Topology needs a vehicle component\");\n    }\n\n    // Check connectivity (simplified)\n    if (nodes.length > 1 && edges.length < nodes.length - 1) {\n      errors.push(\"Some components are not connected\");\n    }\n\n    return {\n      isValid: errors.length === 0,\n      errors,\n    };\n  },\n\n  loadPreset: (name) => {\n    // Clear current state\n    nodeIdCounter = 1;\n\n    switch (name) {\n      case \"diesel-793d\":\n        set({\n          nodes: [\n            {\n              id: \"engine-1\",\n              type: \"engineNode\",\n              position: { x: 100, y: 200 },\n              data: {\n                label: \"CAT 3516E\",\n                componentType: \"engine\",\n                params: DEFAULT_PARAMS.engine,\n              },\n            },\n            {\n              id: \"gearbox-1\",\n              type: \"gearboxNode\",\n              position: { x: 350, y: 200 },\n              data: {\n                label: \"7-Speed Gearbox\",\n                componentType: \"gearbox\",\n                params: DEFAULT_PARAMS.gearbox,\n              },\n            },\n            {\n              id: \"vehicle-1\",\n              type: \"vehicleNode\",\n              position: { x: 600, y: 200 },\n              data: {\n                label: \"CAT 793D\",\n                componentType: \"vehicle\",\n                params: DEFAULT_PARAMS.vehicle,\n              },\n            },\n          ],\n          edges: [\n            {\n              id: \"e-engine-gearbox\",\n              source: \"engine-1\",\n              target: \"gearbox-1\",\n              sourceHandle: \"shaft\",\n              targetHandle: \"input\",\n              type: \"mechanical\",\n            },\n            {\n              id: \"e-gearbox-vehicle\",\n              source: \"gearbox-1\",\n              target: \"vehicle-1\",\n              sourceHandle: \"output\",\n              targetHandle: \"wheels\",\n              type: \"mechanical\",\n            },\n          ],\n          selectedNodeId: null,\n        });\n        nodeIdCounter = 4;\n        break;\n\n      case \"ecvt-split\":\n        set({\n          nodes: [\n            {\n              id: \"engine-1\",\n              type: \"engineNode\",\n              position: { x: 100, y: 250 },\n              data: {\n                label: \"CAT 3516E\",\n                componentType: \"engine\",\n                params: DEFAULT_PARAMS.engine,\n              },\n            },\n            {\n              id: \"motor-1\",\n              type: \"motorNode\",\n              position: { x: 100, y: 100 },\n              data: {\n                label: \"MG1\",\n                componentType: \"motor\",\n                params: { ...DEFAULT_PARAMS.motor, pMax: 200000, tMax: 3000 },\n              },\n            },\n            {\n              id: \"motor-2\",\n              type: \"motorNode\",\n              position: { x: 500, y: 250 },\n              data: {\n                label: \"MG2\",\n                componentType: \"motor\",\n                params: { ...DEFAULT_PARAMS.motor, pMax: 350000, tMax: 2000, pBoost: 500000 },\n              },\n            },\n            {\n              id: \"planetary-1\",\n              type: \"planetaryNode\",\n              position: { x: 300, y: 175 },\n              data: {\n                label: \"Planetary\",\n                componentType: \"planetary\",\n                params: DEFAULT_PARAMS.planetary,\n              },\n            },\n            {\n              id: \"gearbox-1\",\n              type: \"gearboxNode\",\n              position: { x: 650, y: 250 },\n              data: {\n                label: \"2-Speed\",\n                componentType: \"gearbox\",\n                params: { ratios: [5.0, 0.67], efficiencies: [0.97, 0.97] },\n              },\n            },\n            {\n              id: \"battery-1\",\n              type: \"batteryNode\",\n              position: { x: 300, y: 400 },\n              data: {\n                label: \"Battery\",\n                componentType: \"battery\",\n                params: DEFAULT_PARAMS.battery,\n              },\n            },\n            {\n              id: \"vehicle-1\",\n              type: \"vehicleNode\",\n              position: { x: 850, y: 250 },\n              data: {\n                label: \"CAT 793D\",\n                componentType: \"vehicle\",\n                params: DEFAULT_PARAMS.vehicle,\n              },\n            },\n          ],\n          edges: [\n            { id: \"e1\", source: \"engine-1\", target: \"planetary-1\", sourceHandle: \"shaft\", targetHandle: \"carrier\", type: \"mechanical\" },\n            { id: \"e2\", source: \"motor-1\", target: \"planetary-1\", sourceHandle: \"shaft-out\", targetHandle: \"sun\", type: \"mechanical\" },\n            { id: \"e3\", source: \"planetary-1\", target: \"motor-2\", sourceHandle: \"ring\", targetHandle: \"shaft-in\", type: \"mechanical\" },\n            { id: \"e4\", source: \"motor-2\", target: \"gearbox-1\", sourceHandle: \"shaft-out\", targetHandle: \"input\", type: \"mechanical\" },\n            { id: \"e5\", source: \"gearbox-1\", target: \"vehicle-1\", sourceHandle: \"output\", targetHandle: \"wheels\", type: \"mechanical\" },\n            { id: \"e6\", source: \"motor-1\", target: \"battery-1\", sourceHandle: \"electrical\", targetHandle: \"electrical\", type: \"electrical\" },\n            { id: \"e7\", source: \"motor-2\", target: \"battery-1\", sourceHandle: \"electrical\", targetHandle: \"electrical\", type: \"electrical\" },\n          ],\n          selectedNodeId: null,\n        });\n        nodeIdCounter = 8;\n        break;\n\n      case \"ecvt-locked\":\n        // Similar to split but with fixed ratio instead of planetary\n        set({\n          nodes: [\n            {\n              id: \"engine-1\",\n              type: \"engineNode\",\n              position: { x: 100, y: 200 },\n              data: {\n                label: \"CAT 3516E\",\n                componentType: \"engine\",\n                params: DEFAULT_PARAMS.engine,\n              },\n            },\n            {\n              id: \"motor-2\",\n              type: \"motorNode\",\n              position: { x: 350, y: 200 },\n              data: {\n                label: \"MG2\",\n                componentType: \"motor\",\n                params: { ...DEFAULT_PARAMS.motor, pMax: 350000, tMax: 2000, pBoost: 500000 },\n              },\n            },\n            {\n              id: \"gearbox-1\",\n              type: \"gearboxNode\",\n              position: { x: 550, y: 200 },\n              data: {\n                label: \"2-Speed\",\n                componentType: \"gearbox\",\n                params: { ratios: [5.0, 0.67], efficiencies: [0.97, 0.97] },\n              },\n            },\n            {\n              id: \"battery-1\",\n              type: \"batteryNode\",\n              position: { x: 350, y: 350 },\n              data: {\n                label: \"Battery\",\n                componentType: \"battery\",\n                params: DEFAULT_PARAMS.battery,\n              },\n            },\n            {\n              id: \"vehicle-1\",\n              type: \"vehicleNode\",\n              position: { x: 750, y: 200 },\n              data: {\n                label: \"CAT 793D\",\n                componentType: \"vehicle\",\n                params: DEFAULT_PARAMS.vehicle,\n              },\n            },\n          ],\n          edges: [\n            { id: \"e1\", source: \"engine-1\", target: \"motor-2\", sourceHandle: \"shaft\", targetHandle: \"shaft-in\", type: \"mechanical\" },\n            { id: \"e2\", source: \"motor-2\", target: \"gearbox-1\", sourceHandle: \"shaft-out\", targetHandle: \"input\", type: \"mechanical\" },\n            { id: \"e3\", source: \"gearbox-1\", target: \"vehicle-1\", sourceHandle: \"output\", targetHandle: \"wheels\", type: \"mechanical\" },\n            { id: \"e4\", source: \"motor-2\", target: \"battery-1\", sourceHandle: \"electrical\", targetHandle: \"electrical\", type: \"electrical\" },\n          ],\n          selectedNodeId: null,\n        });\n        nodeIdCounter = 6;\n        break;\n    }\n  },\n\n  clearAll: () => {\n    nodeIdCounter = 1;\n    set({\n      nodes: [],\n      edges: [],\n      selectedNodeId: null,\n    });\n  },\n}));\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 551, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/lib/utils.ts"],"sourcesContent":["import { clsx, type ClassValue } from \"clsx\";\nimport { twMerge } from \"tailwind-merge\";\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs));\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,SAAS,GAAG,GAAG,MAAoB;IACxC,OAAO,IAAA,sKAAO,EAAC,IAAA,6IAAI,EAAC;AACtB","debugId":null}},
    {"offset": {"line": 566, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/components/nodes/BaseNode.tsx"],"sourcesContent":["\"use client\";\n\nimport { Handle, Position, type NodeProps, type Node } from \"@xyflow/react\";\nimport { cn } from \"@/lib/utils\";\nimport { useDrivetrainStore, type BaseNodeData } from \"@/stores/drivetrain-store\";\n\nexport interface NodeHandle {\n  id: string;\n  type: \"mechanical\" | \"electrical\";\n  position: Position;\n  label: string;\n}\n\ninterface BaseNodeProps extends NodeProps<Node<BaseNodeData>> {\n  icon: React.ReactNode;\n  color: string;\n  handles: NodeHandle[];\n  children?: React.ReactNode;\n}\n\nexport function BaseNode({\n  id,\n  data,\n  selected,\n  icon,\n  color,\n  handles,\n  children,\n}: BaseNodeProps) {\n  const setSelectedNode = useDrivetrainStore((s) => s.setSelectedNode);\n\n  return (\n    <div\n      className={cn(\n        \"relative min-w-[140px] rounded-lg border-2 bg-surface p-3 shadow-lg transition-all\",\n        selected ? \"border-accent shadow-accent/20\" : \"border-subtle hover:border-secondary\"\n      )}\n      onClick={() => setSelectedNode(id)}\n    >\n      {/* Handles */}\n      {handles.map((handle) => (\n        <Handle\n          key={handle.id}\n          id={handle.id}\n          type={handle.position === Position.Left || handle.position === Position.Top ? \"target\" : \"source\"}\n          position={handle.position}\n          className={cn(\n            \"!h-3 !w-3 !rounded-full !border-2 !border-dark transition-all hover:!scale-125\",\n            handle.type === \"mechanical\" ? \"!bg-emerald-500\" : \"!bg-amber-500\"\n          )}\n          title={handle.label}\n        />\n      ))}\n\n      {/* Header */}\n      <div className=\"flex items-center gap-2 mb-2\">\n        <div\n          className={cn(\"flex h-8 w-8 items-center justify-center rounded-md\", color)}\n        >\n          {icon}\n        </div>\n        <div className=\"flex-1 min-w-0\">\n          <div className=\"text-sm font-medium text-primary truncate\">{data.label}</div>\n          <div className=\"text-xs text-muted\">{data.componentType}</div>\n        </div>\n      </div>\n\n      {/* Content */}\n      {children && <div className=\"mt-2 text-xs text-secondary\">{children}</div>}\n    </div>\n  );\n}\n"],"names":[],"mappings":";;;;;AAEA;AAAA;AACA;AACA;AAJA;;;;;AAoBO,SAAS,SAAS,EACvB,EAAE,EACF,IAAI,EACJ,QAAQ,EACR,IAAI,EACJ,KAAK,EACL,OAAO,EACP,QAAQ,EACM;IACd,MAAM,kBAAkB,IAAA,kLAAkB,EAAC,CAAC,IAAM,EAAE,eAAe;IAEnE,qBACE,8OAAC;QACC,WAAW,IAAA,iJAAE,EACX,sFACA,WAAW,mCAAmC;QAEhD,SAAS,IAAM,gBAAgB;;YAG9B,QAAQ,GAAG,CAAC,CAAC,uBACZ,8OAAC,mLAAM;oBAEL,IAAI,OAAO,EAAE;oBACb,MAAM,OAAO,QAAQ,KAAK,sKAAQ,CAAC,IAAI,IAAI,OAAO,QAAQ,KAAK,sKAAQ,CAAC,GAAG,GAAG,WAAW;oBACzF,UAAU,OAAO,QAAQ;oBACzB,WAAW,IAAA,iJAAE,EACX,kFACA,OAAO,IAAI,KAAK,eAAe,oBAAoB;oBAErD,OAAO,OAAO,KAAK;mBARd,OAAO,EAAE;;;;;0BAalB,8OAAC;gBAAI,WAAU;;kCACb,8OAAC;wBACC,WAAW,IAAA,iJAAE,EAAC,uDAAuD;kCAEpE;;;;;;kCAEH,8OAAC;wBAAI,WAAU;;0CACb,8OAAC;gCAAI,WAAU;0CAA6C,KAAK,KAAK;;;;;;0CACtE,8OAAC;gCAAI,WAAU;0CAAsB,KAAK,aAAa;;;;;;;;;;;;;;;;;;YAK1D,0BAAY,8OAAC;gBAAI,WAAU;0BAA+B;;;;;;;;;;;;AAGjE","debugId":null}},
    {"offset": {"line": 658, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/components/nodes/EngineNode.tsx"],"sourcesContent":["\"use client\";\n\nimport { Position, type NodeProps, type Node } from \"@xyflow/react\";\nimport { Flame } from \"lucide-react\";\nimport { BaseNode, type NodeHandle } from \"./BaseNode\";\nimport { type BaseNodeData } from \"@/stores/drivetrain-store\";\n\nconst handles: NodeHandle[] = [\n  { id: \"shaft\", type: \"mechanical\", position: Position.Right, label: \"Crankshaft\" },\n];\n\nexport function EngineNode(props: NodeProps<Node<BaseNodeData>>) {\n  const { data } = props;\n  const params = data.params as {\n    rpmIdle?: number;\n    rpmMax?: number;\n    pRated?: number;\n    tPeak?: number;\n  };\n\n  return (\n    <BaseNode\n      {...props}\n      icon={<Flame className=\"h-4 w-4 text-white\" />}\n      color=\"bg-red-600\"\n      handles={handles}\n    >\n      <div className=\"space-y-1\">\n        <div className=\"flex justify-between\">\n          <span>Power:</span>\n          <span className=\"text-primary\">{((params.pRated ?? 1800000) / 1000).toFixed(0)} kW</span>\n        </div>\n        <div className=\"flex justify-between\">\n          <span>Torque:</span>\n          <span className=\"text-primary\">{(params.tPeak ?? 11220).toLocaleString()} N·m</span>\n        </div>\n        <div className=\"flex justify-between\">\n          <span>RPM:</span>\n          <span className=\"text-primary\">{params.rpmIdle ?? 700} - {params.rpmMax ?? 1800}</span>\n        </div>\n      </div>\n    </BaseNode>\n  );\n}\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AAJA;;;;;AAOA,MAAM,UAAwB;IAC5B;QAAE,IAAI;QAAS,MAAM;QAAc,UAAU,sKAAQ,CAAC,KAAK;QAAE,OAAO;IAAa;CAClF;AAEM,SAAS,WAAW,KAAoC;IAC7D,MAAM,EAAE,IAAI,EAAE,GAAG;IACjB,MAAM,SAAS,KAAK,MAAM;IAO1B,qBACE,8OAAC,2KAAQ;QACN,GAAG,KAAK;QACT,oBAAM,8OAAC,6MAAK;YAAC,WAAU;;;;;;QACvB,OAAM;QACN,SAAS;kBAET,cAAA,8OAAC;YAAI,WAAU;;8BACb,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;sCAAK;;;;;;sCACN,8OAAC;4BAAK,WAAU;;gCAAgB,CAAC,CAAC,OAAO,MAAM,IAAI,OAAO,IAAI,IAAI,EAAE,OAAO,CAAC;gCAAG;;;;;;;;;;;;;8BAEjF,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;sCAAK;;;;;;sCACN,8OAAC;4BAAK,WAAU;;gCAAgB,CAAC,OAAO,KAAK,IAAI,KAAK,EAAE,cAAc;gCAAG;;;;;;;;;;;;;8BAE3E,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;sCAAK;;;;;;sCACN,8OAAC;4BAAK,WAAU;;gCAAgB,OAAO,OAAO,IAAI;gCAAI;gCAAI,OAAO,MAAM,IAAI;;;;;;;;;;;;;;;;;;;;;;;;AAKrF","debugId":null}},
    {"offset": {"line": 794, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/components/nodes/MotorNode.tsx"],"sourcesContent":["\"use client\";\n\nimport { Position, type NodeProps, type Node } from \"@xyflow/react\";\nimport { Zap } from \"lucide-react\";\nimport { BaseNode, type NodeHandle } from \"./BaseNode\";\nimport { type BaseNodeData } from \"@/stores/drivetrain-store\";\n\nconst handles: NodeHandle[] = [\n  { id: \"shaft-in\", type: \"mechanical\", position: Position.Left, label: \"Shaft In\" },\n  { id: \"shaft-out\", type: \"mechanical\", position: Position.Right, label: \"Shaft Out\" },\n  { id: \"electrical\", type: \"electrical\", position: Position.Bottom, label: \"Electrical\" },\n];\n\nexport function MotorNode(props: NodeProps<Node<BaseNodeData>>) {\n  const { data } = props;\n  const params = data.params as {\n    pMax?: number;\n    tMax?: number;\n    rpmMax?: number;\n    eta?: number;\n    pBoost?: number;\n  };\n\n  return (\n    <BaseNode\n      {...props}\n      icon={<Zap className=\"h-4 w-4 text-white\" />}\n      color=\"bg-blue-600\"\n      handles={handles}\n    >\n      <div className=\"space-y-1\">\n        <div className=\"flex justify-between\">\n          <span>Power:</span>\n          <span className=\"text-primary\">{((params.pMax ?? 200000) / 1000).toFixed(0)} kW</span>\n        </div>\n        {params.pBoost && (\n          <div className=\"flex justify-between\">\n            <span>Boost:</span>\n            <span className=\"text-accent\">{(params.pBoost / 1000).toFixed(0)} kW</span>\n          </div>\n        )}\n        <div className=\"flex justify-between\">\n          <span>Torque:</span>\n          <span className=\"text-primary\">{(params.tMax ?? 3000).toLocaleString()} N·m</span>\n        </div>\n        <div className=\"flex justify-between\">\n          <span>Efficiency:</span>\n          <span className=\"text-primary\">{((params.eta ?? 0.92) * 100).toFixed(0)}%</span>\n        </div>\n      </div>\n    </BaseNode>\n  );\n}\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AAJA;;;;;AAOA,MAAM,UAAwB;IAC5B;QAAE,IAAI;QAAY,MAAM;QAAc,UAAU,sKAAQ,CAAC,IAAI;QAAE,OAAO;IAAW;IACjF;QAAE,IAAI;QAAa,MAAM;QAAc,UAAU,sKAAQ,CAAC,KAAK;QAAE,OAAO;IAAY;IACpF;QAAE,IAAI;QAAc,MAAM;QAAc,UAAU,sKAAQ,CAAC,MAAM;QAAE,OAAO;IAAa;CACxF;AAEM,SAAS,UAAU,KAAoC;IAC5D,MAAM,EAAE,IAAI,EAAE,GAAG;IACjB,MAAM,SAAS,KAAK,MAAM;IAQ1B,qBACE,8OAAC,2KAAQ;QACN,GAAG,KAAK;QACT,oBAAM,8OAAC,uMAAG;YAAC,WAAU;;;;;;QACrB,OAAM;QACN,SAAS;kBAET,cAAA,8OAAC;YAAI,WAAU;;8BACb,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;sCAAK;;;;;;sCACN,8OAAC;4BAAK,WAAU;;gCAAgB,CAAC,CAAC,OAAO,IAAI,IAAI,MAAM,IAAI,IAAI,EAAE,OAAO,CAAC;gCAAG;;;;;;;;;;;;;gBAE7E,OAAO,MAAM,kBACZ,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;sCAAK;;;;;;sCACN,8OAAC;4BAAK,WAAU;;gCAAe,CAAC,OAAO,MAAM,GAAG,IAAI,EAAE,OAAO,CAAC;gCAAG;;;;;;;;;;;;;8BAGrE,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;sCAAK;;;;;;sCACN,8OAAC;4BAAK,WAAU;;gCAAgB,CAAC,OAAO,IAAI,IAAI,IAAI,EAAE,cAAc;gCAAG;;;;;;;;;;;;;8BAEzE,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;sCAAK;;;;;;sCACN,8OAAC;4BAAK,WAAU;;gCAAgB,CAAC,CAAC,OAAO,GAAG,IAAI,IAAI,IAAI,GAAG,EAAE,OAAO,CAAC;gCAAG;;;;;;;;;;;;;;;;;;;;;;;;AAKlF","debugId":null}},
    {"offset": {"line": 968, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/components/nodes/GearboxNode.tsx"],"sourcesContent":["\"use client\";\n\nimport { Position, type NodeProps, type Node } from \"@xyflow/react\";\nimport { Settings } from \"lucide-react\";\nimport { BaseNode, type NodeHandle } from \"./BaseNode\";\nimport { type BaseNodeData } from \"@/stores/drivetrain-store\";\n\nconst handles: NodeHandle[] = [\n  { id: \"input\", type: \"mechanical\", position: Position.Left, label: \"Input Shaft\" },\n  { id: \"output\", type: \"mechanical\", position: Position.Right, label: \"Output Shaft\" },\n];\n\nexport function GearboxNode(props: NodeProps<Node<BaseNodeData>>) {\n  const { data } = props;\n  const params = data.params as {\n    ratios?: number[];\n    efficiencies?: number[];\n  };\n\n  const ratios = params.ratios ?? [1.0];\n\n  return (\n    <BaseNode\n      {...props}\n      icon={<Settings className=\"h-4 w-4 text-white\" />}\n      color=\"bg-purple-600\"\n      handles={handles}\n    >\n      <div className=\"space-y-1\">\n        <div className=\"flex justify-between\">\n          <span>Gears:</span>\n          <span className=\"text-primary\">{ratios.length}</span>\n        </div>\n        <div className=\"flex justify-between\">\n          <span>Ratios:</span>\n          <span className=\"text-primary text-right truncate max-w-[80px]\" title={ratios.map(r => r.toFixed(2)).join(\", \")}>\n            {ratios[0].toFixed(2)} - {ratios[ratios.length - 1].toFixed(2)}\n          </span>\n        </div>\n      </div>\n    </BaseNode>\n  );\n}\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AAJA;;;;;AAOA,MAAM,UAAwB;IAC5B;QAAE,IAAI;QAAS,MAAM;QAAc,UAAU,sKAAQ,CAAC,IAAI;QAAE,OAAO;IAAc;IACjF;QAAE,IAAI;QAAU,MAAM;QAAc,UAAU,sKAAQ,CAAC,KAAK;QAAE,OAAO;IAAe;CACrF;AAEM,SAAS,YAAY,KAAoC;IAC9D,MAAM,EAAE,IAAI,EAAE,GAAG;IACjB,MAAM,SAAS,KAAK,MAAM;IAK1B,MAAM,SAAS,OAAO,MAAM,IAAI;QAAC;KAAI;IAErC,qBACE,8OAAC,2KAAQ;QACN,GAAG,KAAK;QACT,oBAAM,8OAAC,sNAAQ;YAAC,WAAU;;;;;;QAC1B,OAAM;QACN,SAAS;kBAET,cAAA,8OAAC;YAAI,WAAU;;8BACb,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;sCAAK;;;;;;sCACN,8OAAC;4BAAK,WAAU;sCAAgB,OAAO,MAAM;;;;;;;;;;;;8BAE/C,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;sCAAK;;;;;;sCACN,8OAAC;4BAAK,WAAU;4BAAgD,OAAO,OAAO,GAAG,CAAC,CAAA,IAAK,EAAE,OAAO,CAAC,IAAI,IAAI,CAAC;;gCACvG,MAAM,CAAC,EAAE,CAAC,OAAO,CAAC;gCAAG;gCAAI,MAAM,CAAC,OAAO,MAAM,GAAG,EAAE,CAAC,OAAO,CAAC;;;;;;;;;;;;;;;;;;;;;;;;AAMxE","debugId":null}},
    {"offset": {"line": 1084, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/components/nodes/PlanetaryNode.tsx"],"sourcesContent":["\"use client\";\n\nimport { Position, type NodeProps, type Node } from \"@xyflow/react\";\nimport { Circle } from \"lucide-react\";\nimport { BaseNode, type NodeHandle } from \"./BaseNode\";\nimport { type BaseNodeData } from \"@/stores/drivetrain-store\";\n\nconst handles: NodeHandle[] = [\n  { id: \"sun\", type: \"mechanical\", position: Position.Top, label: \"Sun Gear\" },\n  { id: \"carrier\", type: \"mechanical\", position: Position.Left, label: \"Carrier\" },\n  { id: \"ring\", type: \"mechanical\", position: Position.Right, label: \"Ring Gear\" },\n];\n\nexport function PlanetaryNode(props: NodeProps<Node<BaseNodeData>>) {\n  const { data } = props;\n  const params = data.params as {\n    zSun?: number;\n    zRing?: number;\n  };\n\n  const zSun = params.zSun ?? 30;\n  const zRing = params.zRing ?? 90;\n  const rho = zRing / zSun;\n\n  return (\n    <BaseNode\n      {...props}\n      icon={<Circle className=\"h-4 w-4 text-white\" />}\n      color=\"bg-teal-600\"\n      handles={handles}\n    >\n      <div className=\"space-y-1\">\n        <div className=\"flex justify-between\">\n          <span>Sun:</span>\n          <span className=\"text-primary\">{zSun} teeth</span>\n        </div>\n        <div className=\"flex justify-between\">\n          <span>Ring:</span>\n          <span className=\"text-primary\">{zRing} teeth</span>\n        </div>\n        <div className=\"flex justify-between\">\n          <span>ρ:</span>\n          <span className=\"text-primary\">{rho.toFixed(1)}</span>\n        </div>\n      </div>\n    </BaseNode>\n  );\n}\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AAJA;;;;;AAOA,MAAM,UAAwB;IAC5B;QAAE,IAAI;QAAO,MAAM;QAAc,UAAU,sKAAQ,CAAC,GAAG;QAAE,OAAO;IAAW;IAC3E;QAAE,IAAI;QAAW,MAAM;QAAc,UAAU,sKAAQ,CAAC,IAAI;QAAE,OAAO;IAAU;IAC/E;QAAE,IAAI;QAAQ,MAAM;QAAc,UAAU,sKAAQ,CAAC,KAAK;QAAE,OAAO;IAAY;CAChF;AAEM,SAAS,cAAc,KAAoC;IAChE,MAAM,EAAE,IAAI,EAAE,GAAG;IACjB,MAAM,SAAS,KAAK,MAAM;IAK1B,MAAM,OAAO,OAAO,IAAI,IAAI;IAC5B,MAAM,QAAQ,OAAO,KAAK,IAAI;IAC9B,MAAM,MAAM,QAAQ;IAEpB,qBACE,8OAAC,2KAAQ;QACN,GAAG,KAAK;QACT,oBAAM,8OAAC,gNAAM;YAAC,WAAU;;;;;;QACxB,OAAM;QACN,SAAS;kBAET,cAAA,8OAAC;YAAI,WAAU;;8BACb,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;sCAAK;;;;;;sCACN,8OAAC;4BAAK,WAAU;;gCAAgB;gCAAK;;;;;;;;;;;;;8BAEvC,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;sCAAK;;;;;;sCACN,8OAAC;4BAAK,WAAU;;gCAAgB;gCAAM;;;;;;;;;;;;;8BAExC,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;sCAAK;;;;;;sCACN,8OAAC;4BAAK,WAAU;sCAAgB,IAAI,OAAO,CAAC;;;;;;;;;;;;;;;;;;;;;;;AAKtD","debugId":null}},
    {"offset": {"line": 1231, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/components/nodes/BatteryNode.tsx"],"sourcesContent":["\"use client\";\n\nimport { Position, type NodeProps, type Node } from \"@xyflow/react\";\nimport { Battery } from \"lucide-react\";\nimport { BaseNode, type NodeHandle } from \"./BaseNode\";\nimport { type BaseNodeData } from \"@/stores/drivetrain-store\";\n\nconst handles: NodeHandle[] = [\n  { id: \"electrical\", type: \"electrical\", position: Position.Top, label: \"Electrical\" },\n];\n\nexport function BatteryNode(props: NodeProps<Node<BaseNodeData>>) {\n  const { data } = props;\n  const params = data.params as {\n    capacityKwh?: number;\n    vNom?: number;\n    pMaxDischarge?: number;\n    pMaxCharge?: number;\n    socInit?: number;\n  };\n\n  return (\n    <BaseNode\n      {...props}\n      icon={<Battery className=\"h-4 w-4 text-white\" />}\n      color=\"bg-amber-600\"\n      handles={handles}\n    >\n      <div className=\"space-y-1\">\n        <div className=\"flex justify-between\">\n          <span>Capacity:</span>\n          <span className=\"text-primary\">{params.capacityKwh ?? 200} kWh</span>\n        </div>\n        <div className=\"flex justify-between\">\n          <span>Voltage:</span>\n          <span className=\"text-primary\">{params.vNom ?? 700} V</span>\n        </div>\n        <div className=\"flex justify-between\">\n          <span>P max:</span>\n          <span className=\"text-primary\">{((params.pMaxDischarge ?? 1000000) / 1000).toFixed(0)} kW</span>\n        </div>\n        <div className=\"flex justify-between\">\n          <span>SOC:</span>\n          <span className=\"text-primary\">{((params.socInit ?? 0.6) * 100).toFixed(0)}%</span>\n        </div>\n      </div>\n    </BaseNode>\n  );\n}\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AAJA;;;;;AAOA,MAAM,UAAwB;IAC5B;QAAE,IAAI;QAAc,MAAM;QAAc,UAAU,sKAAQ,CAAC,GAAG;QAAE,OAAO;IAAa;CACrF;AAEM,SAAS,YAAY,KAAoC;IAC9D,MAAM,EAAE,IAAI,EAAE,GAAG;IACjB,MAAM,SAAS,KAAK,MAAM;IAQ1B,qBACE,8OAAC,2KAAQ;QACN,GAAG,KAAK;QACT,oBAAM,8OAAC,mNAAO;YAAC,WAAU;;;;;;QACzB,OAAM;QACN,SAAS;kBAET,cAAA,8OAAC;YAAI,WAAU;;8BACb,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;sCAAK;;;;;;sCACN,8OAAC;4BAAK,WAAU;;gCAAgB,OAAO,WAAW,IAAI;gCAAI;;;;;;;;;;;;;8BAE5D,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;sCAAK;;;;;;sCACN,8OAAC;4BAAK,WAAU;;gCAAgB,OAAO,IAAI,IAAI;gCAAI;;;;;;;;;;;;;8BAErD,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;sCAAK;;;;;;sCACN,8OAAC;4BAAK,WAAU;;gCAAgB,CAAC,CAAC,OAAO,aAAa,IAAI,OAAO,IAAI,IAAI,EAAE,OAAO,CAAC;gCAAG;;;;;;;;;;;;;8BAExF,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;sCAAK;;;;;;sCACN,8OAAC;4BAAK,WAAU;;gCAAgB,CAAC,CAAC,OAAO,OAAO,IAAI,GAAG,IAAI,GAAG,EAAE,OAAO,CAAC;gCAAG;;;;;;;;;;;;;;;;;;;;;;;;AAKrF","debugId":null}},
    {"offset": {"line": 1393, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/components/nodes/VehicleNode.tsx"],"sourcesContent":["\"use client\";\n\nimport { Position, type NodeProps, type Node } from \"@xyflow/react\";\nimport { Truck } from \"lucide-react\";\nimport { BaseNode, type NodeHandle } from \"./BaseNode\";\nimport { type BaseNodeData } from \"@/stores/drivetrain-store\";\n\nconst handles: NodeHandle[] = [\n  { id: \"wheels\", type: \"mechanical\", position: Position.Left, label: \"Wheel Input\" },\n];\n\nexport function VehicleNode(props: NodeProps<Node<BaseNodeData>>) {\n  const { data } = props;\n  const params = data.params as {\n    mEmpty?: number;\n    mPayload?: number;\n    rWheel?: number;\n    cR?: number;\n    vMax?: number;\n  };\n\n  const mTotal = (params.mEmpty ?? 159350) + (params.mPayload ?? 190000);\n\n  return (\n    <BaseNode\n      {...props}\n      icon={<Truck className=\"h-4 w-4 text-white\" />}\n      color=\"bg-green-600\"\n      handles={handles}\n    >\n      <div className=\"space-y-1\">\n        <div className=\"flex justify-between\">\n          <span>Mass:</span>\n          <span className=\"text-primary\">{(mTotal / 1000).toFixed(0)} t</span>\n        </div>\n        <div className=\"flex justify-between\">\n          <span>Wheel R:</span>\n          <span className=\"text-primary\">{params.rWheel ?? 1.78} m</span>\n        </div>\n        <div className=\"flex justify-between\">\n          <span>Rolling:</span>\n          <span className=\"text-primary\">{((params.cR ?? 0.025) * 100).toFixed(1)}%</span>\n        </div>\n        <div className=\"flex justify-between\">\n          <span>V max:</span>\n          <span className=\"text-primary\">{((params.vMax ?? 15) * 3.6).toFixed(0)} km/h</span>\n        </div>\n      </div>\n    </BaseNode>\n  );\n}\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AAJA;;;;;AAOA,MAAM,UAAwB;IAC5B;QAAE,IAAI;QAAU,MAAM;QAAc,UAAU,sKAAQ,CAAC,IAAI;QAAE,OAAO;IAAc;CACnF;AAEM,SAAS,YAAY,KAAoC;IAC9D,MAAM,EAAE,IAAI,EAAE,GAAG;IACjB,MAAM,SAAS,KAAK,MAAM;IAQ1B,MAAM,SAAS,CAAC,OAAO,MAAM,IAAI,MAAM,IAAI,CAAC,OAAO,QAAQ,IAAI,MAAM;IAErE,qBACE,8OAAC,2KAAQ;QACN,GAAG,KAAK;QACT,oBAAM,8OAAC,6MAAK;YAAC,WAAU;;;;;;QACvB,OAAM;QACN,SAAS;kBAET,cAAA,8OAAC;YAAI,WAAU;;8BACb,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;sCAAK;;;;;;sCACN,8OAAC;4BAAK,WAAU;;gCAAgB,CAAC,SAAS,IAAI,EAAE,OAAO,CAAC;gCAAG;;;;;;;;;;;;;8BAE7D,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;sCAAK;;;;;;sCACN,8OAAC;4BAAK,WAAU;;gCAAgB,OAAO,MAAM,IAAI;gCAAK;;;;;;;;;;;;;8BAExD,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;sCAAK;;;;;;sCACN,8OAAC;4BAAK,WAAU;;gCAAgB,CAAC,CAAC,OAAO,EAAE,IAAI,KAAK,IAAI,GAAG,EAAE,OAAO,CAAC;gCAAG;;;;;;;;;;;;;8BAE1E,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;sCAAK;;;;;;sCACN,8OAAC;4BAAK,WAAU;;gCAAgB,CAAC,CAAC,OAAO,IAAI,IAAI,EAAE,IAAI,GAAG,EAAE,OAAO,CAAC;gCAAG;;;;;;;;;;;;;;;;;;;;;;;;AAKjF","debugId":null}},
    {"offset": {"line": 1556, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/components/nodes/index.ts"],"sourcesContent":["export { EngineNode } from \"./EngineNode\";\nexport { MotorNode } from \"./MotorNode\";\nexport { GearboxNode } from \"./GearboxNode\";\nexport { PlanetaryNode } from \"./PlanetaryNode\";\nexport { BatteryNode } from \"./BatteryNode\";\nexport { VehicleNode } from \"./VehicleNode\";\n\nimport { EngineNode } from \"./EngineNode\";\nimport { MotorNode } from \"./MotorNode\";\nimport { GearboxNode } from \"./GearboxNode\";\nimport { PlanetaryNode } from \"./PlanetaryNode\";\nimport { BatteryNode } from \"./BatteryNode\";\nimport { VehicleNode } from \"./VehicleNode\";\n\nexport const nodeTypes = {\n  engineNode: EngineNode,\n  motorNode: MotorNode,\n  gearboxNode: GearboxNode,\n  planetaryNode: PlanetaryNode,\n  batteryNode: BatteryNode,\n  vehicleNode: VehicleNode,\n};\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AASO,MAAM,YAAY;IACvB,YAAY,+KAAU;IACtB,WAAW,6KAAS;IACpB,aAAa,iLAAW;IACxB,eAAe,qLAAa;IAC5B,aAAa,iLAAW;IACxB,aAAa,iLAAW;AAC1B","debugId":null}},
    {"offset": {"line": 1590, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/components/ui/card.tsx"],"sourcesContent":["import * as React from \"react\";\nimport { cn } from \"@/lib/utils\";\n\nfunction Card({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"card\"\n      className={cn(\n        \"bg-card text-card-foreground flex flex-col gap-4 rounded-xl border p-4 shadow-sm\",\n        className\n      )}\n      {...props}\n    />\n  );\n}\n\nfunction CardHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"card-header\"\n      className={cn(\"flex flex-col gap-1\", className)}\n      {...props}\n    />\n  );\n}\n\nfunction CardTitle({ className, ...props }: React.ComponentProps<\"h3\">) {\n  return (\n    <h3\n      data-slot=\"card-title\"\n      className={cn(\"text-lg font-semibold leading-none\", className)}\n      {...props}\n    />\n  );\n}\n\nfunction CardDescription({ className, ...props }: React.ComponentProps<\"p\">) {\n  return (\n    <p\n      data-slot=\"card-description\"\n      className={cn(\"text-muted-foreground text-sm\", className)}\n      {...props}\n    />\n  );\n}\n\nfunction CardContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div data-slot=\"card-content\" className={cn(\"\", className)} {...props} />\n  );\n}\n\nfunction CardFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"card-footer\"\n      className={cn(\"flex items-center gap-2\", className)}\n      {...props}\n    />\n  );\n}\n\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardDescription,\n  CardContent,\n};\n"],"names":[],"mappings":";;;;;;;;;;;;;;;AACA;;;AAEA,SAAS,KAAK,EAAE,SAAS,EAAE,GAAG,OAAoC;IAChE,qBACE,8OAAC;QACC,aAAU;QACV,WAAW,IAAA,iJAAE,EACX,oFACA;QAED,GAAG,KAAK;;;;;;AAGf;AAEA,SAAS,WAAW,EAAE,SAAS,EAAE,GAAG,OAAoC;IACtE,qBACE,8OAAC;QACC,aAAU;QACV,WAAW,IAAA,iJAAE,EAAC,uBAAuB;QACpC,GAAG,KAAK;;;;;;AAGf;AAEA,SAAS,UAAU,EAAE,SAAS,EAAE,GAAG,OAAmC;IACpE,qBACE,8OAAC;QACC,aAAU;QACV,WAAW,IAAA,iJAAE,EAAC,sCAAsC;QACnD,GAAG,KAAK;;;;;;AAGf;AAEA,SAAS,gBAAgB,EAAE,SAAS,EAAE,GAAG,OAAkC;IACzE,qBACE,8OAAC;QACC,aAAU;QACV,WAAW,IAAA,iJAAE,EAAC,iCAAiC;QAC9C,GAAG,KAAK;;;;;;AAGf;AAEA,SAAS,YAAY,EAAE,SAAS,EAAE,GAAG,OAAoC;IACvE,qBACE,8OAAC;QAAI,aAAU;QAAe,WAAW,IAAA,iJAAE,EAAC,IAAI;QAAa,GAAG,KAAK;;;;;;AAEzE;AAEA,SAAS,WAAW,EAAE,SAAS,EAAE,GAAG,OAAoC;IACtE,qBACE,8OAAC;QACC,aAAU;QACV,WAAW,IAAA,iJAAE,EAAC,2BAA2B;QACxC,GAAG,KAAK;;;;;;AAGf","debugId":null}},
    {"offset": {"line": 1679, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/components/ui/button.tsx"],"sourcesContent":["import * as React from \"react\";\nimport { Slot } from \"@radix-ui/react-slot\";\nimport { cva, type VariantProps } from \"class-variance-authority\";\nimport { cn } from \"@/lib/utils\";\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-primary text-primary-foreground hover:bg-primary/90\",\n        destructive: \"bg-destructive text-white hover:bg-destructive/90\",\n        outline: \"border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50\",\n        secondary: \"bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        ghost: \"hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50\",\n        link: \"text-primary underline-offset-4 hover:underline\",\n        accent: \"bg-accent text-accent-foreground hover:bg-accent-hover\",\n      },\n      size: {\n        default: \"h-9 px-4 py-2 has-[>svg]:px-3\",\n        sm: \"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5\",\n        lg: \"h-10 rounded-md px-6 has-[>svg]:px-4\",\n        icon: \"size-9\",\n        \"icon-sm\": \"size-8\",\n        \"icon-lg\": \"size-10\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n);\n\nfunction Button({\n  className,\n  variant,\n  size,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> &\n  VariantProps<typeof buttonVariants> & {\n    asChild?: boolean;\n  }) {\n  const Comp = asChild ? Slot : \"button\";\n\n  return (\n    <Comp\n      data-slot=\"button\"\n      className={cn(buttonVariants({ variant, size, className }))}\n      {...props}\n    />\n  );\n}\n\nexport { Button, buttonVariants };\n"],"names":[],"mappings":";;;;;;;AACA;AACA;AACA;;;;;AAEA,MAAM,iBAAiB,IAAA,uKAAG,EACxB,wVACA;IACE,UAAU;QACR,SAAS;YACP,SAAS;YACT,aAAa;YACb,SAAS;YACT,WAAW;YACX,OAAO;YACP,MAAM;YACN,QAAQ;QACV;QACA,MAAM;YACJ,SAAS;YACT,IAAI;YACJ,IAAI;YACJ,MAAM;YACN,WAAW;YACX,WAAW;QACb;IACF;IACA,iBAAiB;QACf,SAAS;QACT,MAAM;IACR;AACF;AAGF,SAAS,OAAO,EACd,SAAS,EACT,OAAO,EACP,IAAI,EACJ,UAAU,KAAK,EACf,GAAG,OAIF;IACD,MAAM,OAAO,UAAU,wKAAI,GAAG;IAE9B,qBACE,8OAAC;QACC,aAAU;QACV,WAAW,IAAA,iJAAE,EAAC,eAAe;YAAE;YAAS;YAAM;QAAU;QACvD,GAAG,KAAK;;;;;;AAGf","debugId":null}},
    {"offset": {"line": 1739, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/components/panels/ComponentPalette.tsx"],"sourcesContent":["\"use client\";\n\nimport { Flame, Zap, Settings, Circle, Battery, Truck } from \"lucide-react\";\nimport { Card, CardHeader, CardTitle, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { useDrivetrainStore, type ComponentType, type PresetName } from \"@/stores/drivetrain-store\";\nimport { cn } from \"@/lib/utils\";\n\nconst COMPONENT_ITEMS: {\n  type: ComponentType;\n  label: string;\n  icon: React.ReactNode;\n  color: string;\n}[] = [\n  { type: \"engine\", label: \"Engine\", icon: <Flame className=\"h-4 w-4\" />, color: \"bg-red-600\" },\n  { type: \"motor\", label: \"Motor\", icon: <Zap className=\"h-4 w-4\" />, color: \"bg-blue-600\" },\n  { type: \"gearbox\", label: \"Gearbox\", icon: <Settings className=\"h-4 w-4\" />, color: \"bg-purple-600\" },\n  { type: \"planetary\", label: \"Planetary\", icon: <Circle className=\"h-4 w-4\" />, color: \"bg-teal-600\" },\n  { type: \"battery\", label: \"Battery\", icon: <Battery className=\"h-4 w-4\" />, color: \"bg-amber-600\" },\n  { type: \"vehicle\", label: \"Vehicle\", icon: <Truck className=\"h-4 w-4\" />, color: \"bg-green-600\" },\n];\n\nconst PRESETS: { name: PresetName; label: string }[] = [\n  { name: \"diesel-793d\", label: \"CAT 793D Diesel\" },\n  { name: \"ecvt-split\", label: \"eCVT Power Split\" },\n  { name: \"ecvt-locked\", label: \"eCVT Locked Sun\" },\n];\n\nexport function ComponentPalette() {\n  const addNode = useDrivetrainStore((s) => s.addNode);\n  const loadPreset = useDrivetrainStore((s) => s.loadPreset);\n  const clearAll = useDrivetrainStore((s) => s.clearAll);\n\n  const handleDragStart = (e: React.DragEvent, type: ComponentType) => {\n    e.dataTransfer.setData(\"application/reactflow\", type);\n    e.dataTransfer.effectAllowed = \"move\";\n  };\n\n  return (\n    <div className=\"w-64 flex flex-col gap-4 p-4 bg-dark border-r border-subtle overflow-y-auto\">\n      <Card>\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-sm\">Components</CardTitle>\n        </CardHeader>\n        <CardContent className=\"grid grid-cols-2 gap-2\">\n          {COMPONENT_ITEMS.map((item) => (\n            <div\n              key={item.type}\n              draggable\n              onDragStart={(e) => handleDragStart(e, item.type)}\n              className={cn(\n                \"flex flex-col items-center gap-1 p-2 rounded-lg border border-subtle cursor-grab\",\n                \"hover:border-secondary hover:bg-surface/50 transition-all\"\n              )}\n            >\n              <div className={cn(\"p-2 rounded-md text-white\", item.color)}>\n                {item.icon}\n              </div>\n              <span className=\"text-xs text-secondary\">{item.label}</span>\n            </div>\n          ))}\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-sm\">Presets</CardTitle>\n        </CardHeader>\n        <CardContent className=\"flex flex-col gap-2\">\n          {PRESETS.map((preset) => (\n            <Button\n              key={preset.name}\n              variant=\"outline\"\n              size=\"sm\"\n              className=\"justify-start\"\n              onClick={() => loadPreset(preset.name)}\n            >\n              {preset.label}\n            </Button>\n          ))}\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            className=\"justify-start text-destructive hover:text-destructive\"\n            onClick={clearAll}\n          >\n            Clear All\n          </Button>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n"],"names":[],"mappings":";;;;;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AANA;;;;;;;AAQA,MAAM,kBAKA;IACJ;QAAE,MAAM;QAAU,OAAO;QAAU,oBAAM,8OAAC,6MAAK;YAAC,WAAU;;;;;;QAAc,OAAO;IAAa;IAC5F;QAAE,MAAM;QAAS,OAAO;QAAS,oBAAM,8OAAC,uMAAG;YAAC,WAAU;;;;;;QAAc,OAAO;IAAc;IACzF;QAAE,MAAM;QAAW,OAAO;QAAW,oBAAM,8OAAC,sNAAQ;YAAC,WAAU;;;;;;QAAc,OAAO;IAAgB;IACpG;QAAE,MAAM;QAAa,OAAO;QAAa,oBAAM,8OAAC,gNAAM;YAAC,WAAU;;;;;;QAAc,OAAO;IAAc;IACpG;QAAE,MAAM;QAAW,OAAO;QAAW,oBAAM,8OAAC,mNAAO;YAAC,WAAU;;;;;;QAAc,OAAO;IAAe;IAClG;QAAE,MAAM;QAAW,OAAO;QAAW,oBAAM,8OAAC,6MAAK;YAAC,WAAU;;;;;;QAAc,OAAO;IAAe;CACjG;AAED,MAAM,UAAiD;IACrD;QAAE,MAAM;QAAe,OAAO;IAAkB;IAChD;QAAE,MAAM;QAAc,OAAO;IAAmB;IAChD;QAAE,MAAM;QAAe,OAAO;IAAkB;CACjD;AAEM,SAAS;IACd,MAAM,UAAU,IAAA,kLAAkB,EAAC,CAAC,IAAM,EAAE,OAAO;IACnD,MAAM,aAAa,IAAA,kLAAkB,EAAC,CAAC,IAAM,EAAE,UAAU;IACzD,MAAM,WAAW,IAAA,kLAAkB,EAAC,CAAC,IAAM,EAAE,QAAQ;IAErD,MAAM,kBAAkB,CAAC,GAAoB;QAC3C,EAAE,YAAY,CAAC,OAAO,CAAC,yBAAyB;QAChD,EAAE,YAAY,CAAC,aAAa,GAAG;IACjC;IAEA,qBACE,8OAAC;QAAI,WAAU;;0BACb,8OAAC,gKAAI;;kCACH,8OAAC,sKAAU;wBAAC,WAAU;kCACpB,cAAA,8OAAC,qKAAS;4BAAC,WAAU;sCAAU;;;;;;;;;;;kCAEjC,8OAAC,uKAAW;wBAAC,WAAU;kCACpB,gBAAgB,GAAG,CAAC,CAAC,qBACpB,8OAAC;gCAEC,SAAS;gCACT,aAAa,CAAC,IAAM,gBAAgB,GAAG,KAAK,IAAI;gCAChD,WAAW,IAAA,iJAAE,EACX,oFACA;;kDAGF,8OAAC;wCAAI,WAAW,IAAA,iJAAE,EAAC,6BAA6B,KAAK,KAAK;kDACvD,KAAK,IAAI;;;;;;kDAEZ,8OAAC;wCAAK,WAAU;kDAA0B,KAAK,KAAK;;;;;;;+BAX/C,KAAK,IAAI;;;;;;;;;;;;;;;;0BAiBtB,8OAAC,gKAAI;;kCACH,8OAAC,sKAAU;wBAAC,WAAU;kCACpB,cAAA,8OAAC,qKAAS;4BAAC,WAAU;sCAAU;;;;;;;;;;;kCAEjC,8OAAC,uKAAW;wBAAC,WAAU;;4BACpB,QAAQ,GAAG,CAAC,CAAC,uBACZ,8OAAC,oKAAM;oCAEL,SAAQ;oCACR,MAAK;oCACL,WAAU;oCACV,SAAS,IAAM,WAAW,OAAO,IAAI;8CAEpC,OAAO,KAAK;mCANR,OAAO,IAAI;;;;;0CASpB,8OAAC,oKAAM;gCACL,SAAQ;gCACR,MAAK;gCACL,WAAU;gCACV,SAAS;0CACV;;;;;;;;;;;;;;;;;;;;;;;;AAOX","debugId":null}},
    {"offset": {"line": 1982, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/components/ui/input.tsx"],"sourcesContent":["import * as React from \"react\";\nimport { cn } from \"@/lib/utils\";\n\nfunction Input({ className, type, ...props }: React.ComponentProps<\"input\">) {\n  return (\n    <input\n      type={type}\n      data-slot=\"input\"\n      className={cn(\n        \"placeholder:text-muted-foreground dark:bg-input/30 border-input h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-sm shadow-xs transition-[color,box-shadow] outline-none disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50\",\n        \"focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]\",\n        className\n      )}\n      {...props}\n    />\n  );\n}\n\nexport { Input };\n"],"names":[],"mappings":";;;;;AACA;;;AAEA,SAAS,MAAM,EAAE,SAAS,EAAE,IAAI,EAAE,GAAG,OAAsC;IACzE,qBACE,8OAAC;QACC,MAAM;QACN,aAAU;QACV,WAAW,IAAA,iJAAE,EACX,2QACA,iFACA;QAED,GAAG,KAAK;;;;;;AAGf","debugId":null}},
    {"offset": {"line": 2007, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/components/ui/label.tsx"],"sourcesContent":["import * as React from \"react\";\nimport * as LabelPrimitive from \"@radix-ui/react-label\";\nimport { cn } from \"@/lib/utils\";\n\nfunction Label({\n  className,\n  ...props\n}: React.ComponentProps<typeof LabelPrimitive.Root>) {\n  return (\n    <LabelPrimitive.Root\n      data-slot=\"label\"\n      className={cn(\n        \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\",\n        className\n      )}\n      {...props}\n    />\n  );\n}\n\nexport { Label };\n"],"names":[],"mappings":";;;;;AACA;AACA;;;;AAEA,SAAS,MAAM,EACb,SAAS,EACT,GAAG,OAC8C;IACjD,qBACE,8OAAC,yKAAmB;QAClB,aAAU;QACV,WAAW,IAAA,iJAAE,EACX,8FACA;QAED,GAAG,KAAK;;;;;;AAGf","debugId":null}},
    {"offset": {"line": 2033, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/components/ui/separator.tsx"],"sourcesContent":["\"use client\";\n\nimport * as React from \"react\";\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\";\nimport { cn } from \"@/lib/utils\";\n\nfunction Separator({\n  className,\n  orientation = \"horizontal\",\n  decorative = true,\n  ...props\n}: React.ComponentProps<typeof SeparatorPrimitive.Root>) {\n  return (\n    <SeparatorPrimitive.Root\n      data-slot=\"separator\"\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"bg-border shrink-0\",\n        orientation === \"horizontal\" ? \"h-px w-full\" : \"h-full w-px\",\n        className\n      )}\n      {...props}\n    />\n  );\n}\n\nexport { Separator };\n"],"names":[],"mappings":";;;;;AAGA;AACA;AAJA;;;;AAMA,SAAS,UAAU,EACjB,SAAS,EACT,cAAc,YAAY,EAC1B,aAAa,IAAI,EACjB,GAAG,OACkD;IACrD,qBACE,8OAAC,6KAAuB;QACtB,aAAU;QACV,YAAY;QACZ,aAAa;QACb,WAAW,IAAA,iJAAE,EACX,sBACA,gBAAgB,eAAe,gBAAgB,eAC/C;QAED,GAAG,KAAK;;;;;;AAGf","debugId":null}},
    {"offset": {"line": 2062, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/components/panels/PropertiesPanel.tsx"],"sourcesContent":["\"use client\";\n\nimport { Card, CardHeader, CardTitle, CardContent } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Button } from \"@/components/ui/button\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Trash2 } from \"lucide-react\";\nimport { useDrivetrainStore, type ComponentType } from \"@/stores/drivetrain-store\";\n\n// Parameter definitions for each component type\nconst PARAM_DEFS: Record<\n  ComponentType,\n  Array<{ key: string; label: string; unit?: string; step?: number }>\n> = {\n  engine: [\n    { key: \"rpmIdle\", label: \"Idle RPM\", unit: \"rpm\" },\n    { key: \"rpmMax\", label: \"Max RPM\", unit: \"rpm\" },\n    { key: \"pRated\", label: \"Rated Power\", unit: \"W\" },\n    { key: \"tPeak\", label: \"Peak Torque\", unit: \"N·m\" },\n  ],\n  motor: [\n    { key: \"pMax\", label: \"Max Power\", unit: \"W\" },\n    { key: \"pBoost\", label: \"Boost Power\", unit: \"W\" },\n    { key: \"tMax\", label: \"Max Torque\", unit: \"N·m\" },\n    { key: \"rpmMax\", label: \"Max RPM\", unit: \"rpm\" },\n    { key: \"eta\", label: \"Efficiency\", step: 0.01 },\n  ],\n  gearbox: [\n    { key: \"ratios\", label: \"Ratios (comma-sep)\" },\n  ],\n  planetary: [\n    { key: \"zSun\", label: \"Sun Teeth\" },\n    { key: \"zRing\", label: \"Ring Teeth\" },\n  ],\n  battery: [\n    { key: \"capacityKwh\", label: \"Capacity\", unit: \"kWh\" },\n    { key: \"vNom\", label: \"Voltage\", unit: \"V\" },\n    { key: \"pMaxDischarge\", label: \"Max Discharge\", unit: \"W\" },\n    { key: \"pMaxCharge\", label: \"Max Charge\", unit: \"W\" },\n    { key: \"socInit\", label: \"Initial SOC\", step: 0.01 },\n  ],\n  vehicle: [\n    { key: \"mEmpty\", label: \"Empty Mass\", unit: \"kg\" },\n    { key: \"mPayload\", label: \"Payload\", unit: \"kg\" },\n    { key: \"rWheel\", label: \"Wheel Radius\", unit: \"m\", step: 0.01 },\n    { key: \"cR\", label: \"Rolling Coeff\", step: 0.001 },\n    { key: \"vMax\", label: \"Max Speed\", unit: \"m/s\" },\n  ],\n};\n\nexport function PropertiesPanel() {\n  const nodes = useDrivetrainStore((s) => s.nodes);\n  const selectedNodeId = useDrivetrainStore((s) => s.selectedNodeId);\n  const updateNodeParams = useDrivetrainStore((s) => s.updateNodeParams);\n  const removeNode = useDrivetrainStore((s) => s.removeNode);\n  const setSelectedNode = useDrivetrainStore((s) => s.setSelectedNode);\n\n  const selectedNode = nodes.find((n) => n.id === selectedNodeId);\n\n  if (!selectedNode) {\n    return (\n      <div className=\"w-72 p-4 bg-dark border-l border-subtle\">\n        <Card>\n          <CardContent className=\"py-8 text-center text-muted\">\n            Select a component to edit its properties\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  const componentType = selectedNode.data.componentType;\n  const params = selectedNode.data.params;\n  const paramDefs = PARAM_DEFS[componentType] ?? [];\n\n  const handleChange = (key: string, value: string) => {\n    let parsedValue: unknown = value;\n\n    // Special handling for ratios array\n    if (key === \"ratios\") {\n      parsedValue = value.split(\",\").map((v) => parseFloat(v.trim())).filter((v) => !isNaN(v));\n    } else {\n      const num = parseFloat(value);\n      if (!isNaN(num)) {\n        parsedValue = num;\n      }\n    }\n\n    updateNodeParams(selectedNode.id, { [key]: parsedValue });\n  };\n\n  const handleDelete = () => {\n    removeNode(selectedNode.id);\n    setSelectedNode(null);\n  };\n\n  return (\n    <div className=\"w-72 flex flex-col gap-4 p-4 bg-dark border-l border-subtle overflow-y-auto\">\n      <Card>\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-sm flex items-center justify-between\">\n            <span>{selectedNode.data.label}</span>\n            <Button\n              variant=\"ghost\"\n              size=\"icon-sm\"\n              className=\"text-destructive hover:text-destructive hover:bg-destructive/10\"\n              onClick={handleDelete}\n            >\n              <Trash2 className=\"h-4 w-4\" />\n            </Button>\n          </CardTitle>\n          <p className=\"text-xs text-muted capitalize\">{componentType}</p>\n        </CardHeader>\n        <CardContent className=\"space-y-3\">\n          <Separator />\n          {paramDefs.map((def) => {\n            const value = params[def.key];\n            const displayValue = Array.isArray(value)\n              ? value.join(\", \")\n              : String(value ?? \"\");\n\n            return (\n              <div key={def.key} className=\"space-y-1\">\n                <Label htmlFor={def.key} className=\"text-xs\">\n                  {def.label}\n                  {def.unit && <span className=\"text-muted ml-1\">({def.unit})</span>}\n                </Label>\n                <Input\n                  id={def.key}\n                  value={displayValue}\n                  onChange={(e) => handleChange(def.key, e.target.value)}\n                  step={def.step}\n                  className=\"h-8 text-sm\"\n                />\n              </div>\n            );\n          })}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2389, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/components/ui/tabs.tsx"],"sourcesContent":["\"use client\";\n\nimport * as React from \"react\";\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\";\nimport { cn } from \"@/lib/utils\";\n\nfunction Tabs({\n  className,\n  ...props\n}: React.ComponentProps<typeof TabsPrimitive.Root>) {\n  return (\n    <TabsPrimitive.Root\n      data-slot=\"tabs\"\n      className={cn(\"flex flex-col gap-2\", className)}\n      {...props}\n    />\n  );\n}\n\nfunction TabsList({\n  className,\n  ...props\n}: React.ComponentProps<typeof TabsPrimitive.List>) {\n  return (\n    <TabsPrimitive.List\n      data-slot=\"tabs-list\"\n      className={cn(\n        \"bg-muted/30 text-muted-foreground inline-flex h-9 w-fit items-center justify-center rounded-lg p-1\",\n        className\n      )}\n      {...props}\n    />\n  );\n}\n\nfunction TabsTrigger({\n  className,\n  ...props\n}: React.ComponentProps<typeof TabsPrimitive.Trigger>) {\n  return (\n    <TabsPrimitive.Trigger\n      data-slot=\"tabs-trigger\"\n      className={cn(\n        \"inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 text-sm font-medium transition-all\",\n        \"data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n        \"hover:text-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n        className\n      )}\n      {...props}\n    />\n  );\n}\n\nfunction TabsContent({\n  className,\n  ...props\n}: React.ComponentProps<typeof TabsPrimitive.Content>) {\n  return (\n    <TabsPrimitive.Content\n      data-slot=\"tabs-content\"\n      className={cn(\n        \"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n        className\n      )}\n      {...props}\n    />\n  );\n}\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent };\n"],"names":[],"mappings":";;;;;;;;;;;AAGA;AACA;AAJA;;;;AAMA,SAAS,KAAK,EACZ,SAAS,EACT,GAAG,OAC6C;IAChD,qBACE,8OAAC,wKAAkB;QACjB,aAAU;QACV,WAAW,IAAA,iJAAE,EAAC,uBAAuB;QACpC,GAAG,KAAK;;;;;;AAGf;AAEA,SAAS,SAAS,EAChB,SAAS,EACT,GAAG,OAC6C;IAChD,qBACE,8OAAC,wKAAkB;QACjB,aAAU;QACV,WAAW,IAAA,iJAAE,EACX,sGACA;QAED,GAAG,KAAK;;;;;;AAGf;AAEA,SAAS,YAAY,EACnB,SAAS,EACT,GAAG,OACgD;IACnD,qBACE,8OAAC,2KAAqB;QACpB,aAAU;QACV,WAAW,IAAA,iJAAE,EACX,qHACA,uGACA,6HACA;QAED,GAAG,KAAK;;;;;;AAGf;AAEA,SAAS,YAAY,EACnB,SAAS,EACT,GAAG,OACgD;IACnD,qBACE,8OAAC,2KAAqB;QACpB,aAAU;QACV,WAAW,IAAA,iJAAE,EACX,uGACA;QAED,GAAG,KAAK;;;;;;AAGf","debugId":null}},
    {"offset": {"line": 2455, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/stores/simulation-store.ts"],"sourcesContent":["\"use client\";\n\nimport { create } from \"zustand\";\nimport type { PresetName } from \"./drivetrain-store\";\n\n/**\n * Simulation configuration.\n */\nexport interface SimConfig {\n  tEnd: number; // Duration [s]\n  dtOutput: number; // Output step [s]\n  targetVelocity: number; // Target speed [m/s]\n  grade: number; // Road grade [fraction]\n  payloadFraction: number; // Payload [0-1]\n}\n\n/**\n * Simulation result data.\n */\nexport interface SimResult {\n  time: number[];\n  velocity: number[];\n  grade: number[];\n  fuelRate?: number[];\n  soc?: number[];\n  enginePower?: number[];\n  motorPower?: number[];\n}\n\n/**\n * Labeled simulation result for comparison.\n */\nexport interface ComparisonResult {\n  preset: PresetName;\n  label: string;\n  color: string;\n  result: SimResult;\n  rimpullCurves: RimpullCurve[];\n}\n\n/**\n * Rimpull data point.\n */\nexport interface RimpullPoint {\n  velocity: number; // [m/s]\n  force: number; // [N]\n  gear?: number;\n}\n\n/**\n * Rimpull curve for a configuration.\n */\nexport interface RimpullCurve {\n  name: string;\n  points: RimpullPoint[];\n  color: string;\n}\n\ntype SimStatus = \"idle\" | \"running\" | \"completed\" | \"error\";\n\ninterface SimulationState {\n  config: SimConfig;\n  status: SimStatus;\n  progress: number;\n  error: string | null;\n  result: SimResult | null;\n  rimpullCurves: RimpullCurve[];\n\n  // Comparison mode\n  comparisonMode: boolean;\n  comparisonResults: ComparisonResult[];\n  runningPreset: PresetName | null;\n\n  // Actions\n  setConfig: (config: Partial<SimConfig>) => void;\n  setStatus: (status: SimStatus) => void;\n  setProgress: (progress: number) => void;\n  setError: (error: string | null) => void;\n  setResult: (result: SimResult | null) => void;\n  setRimpullCurves: (curves: RimpullCurve[]) => void;\n  reset: () => void;\n\n  // Comparison actions\n  setComparisonMode: (enabled: boolean) => void;\n  addComparisonResult: (result: ComparisonResult) => void;\n  clearComparisonResults: () => void;\n  setRunningPreset: (preset: PresetName | null) => void;\n}\n\nconst DEFAULT_CONFIG: SimConfig = {\n  tEnd: 60,\n  dtOutput: 0.1,\n  targetVelocity: 12, // ~43 km/h\n  grade: 0.0,\n  payloadFraction: 1.0,\n};\n\nexport const PRESET_COLORS: Record<PresetName, string> = {\n  \"diesel-793d\": \"#ef4444\",   // Red\n  \"ecvt-split\": \"#3b82f6\",    // Blue\n  \"ecvt-locked\": \"#22c55e\",   // Green\n};\n\nexport const PRESET_LABELS: Record<PresetName, string> = {\n  \"diesel-793d\": \"Diesel 7-Speed\",\n  \"ecvt-split\": \"eCVT Power-Split\",\n  \"ecvt-locked\": \"eCVT Locked-Sun\",\n};\n\nexport const useSimulationStore = create<SimulationState>((set) => ({\n  config: DEFAULT_CONFIG,\n  status: \"idle\",\n  progress: 0,\n  error: null,\n  result: null,\n  rimpullCurves: [],\n\n  // Comparison mode\n  comparisonMode: false,\n  comparisonResults: [],\n  runningPreset: null,\n\n  setConfig: (config) =>\n    set((state) => ({\n      config: { ...state.config, ...config },\n    })),\n\n  setStatus: (status) => set({ status }),\n\n  setProgress: (progress) => set({ progress }),\n\n  setError: (error) => set({ error, status: error ? \"error\" : \"idle\" }),\n\n  setResult: (result) => set({ result, status: result ? \"completed\" : \"idle\" }),\n\n  setRimpullCurves: (curves) => set({ rimpullCurves: curves }),\n\n  reset: () =>\n    set({\n      status: \"idle\",\n      progress: 0,\n      error: null,\n      result: null,\n    }),\n\n  // Comparison actions\n  setComparisonMode: (enabled) => set({ comparisonMode: enabled }),\n\n  addComparisonResult: (result) =>\n    set((state) => ({\n      comparisonResults: [\n        ...state.comparisonResults.filter((r) => r.preset !== result.preset),\n        result,\n      ],\n    })),\n\n  clearComparisonResults: () => set({ comparisonResults: [] }),\n\n  setRunningPreset: (preset) => set({ runningPreset: preset }),\n}));\n"],"names":[],"mappings":";;;;;;;;AAEA;AAFA;;AAyFA,MAAM,iBAA4B;IAChC,MAAM;IACN,UAAU;IACV,gBAAgB;IAChB,OAAO;IACP,iBAAiB;AACnB;AAEO,MAAM,gBAA4C;IACvD,eAAe;IACf,cAAc;IACd,eAAe;AACjB;AAEO,MAAM,gBAA4C;IACvD,eAAe;IACf,cAAc;IACd,eAAe;AACjB;AAEO,MAAM,qBAAqB,IAAA,kJAAM,EAAkB,CAAC,MAAQ,CAAC;QAClE,QAAQ;QACR,QAAQ;QACR,UAAU;QACV,OAAO;QACP,QAAQ;QACR,eAAe,EAAE;QAEjB,kBAAkB;QAClB,gBAAgB;QAChB,mBAAmB,EAAE;QACrB,eAAe;QAEf,WAAW,CAAC,SACV,IAAI,CAAC,QAAU,CAAC;oBACd,QAAQ;wBAAE,GAAG,MAAM,MAAM;wBAAE,GAAG,MAAM;oBAAC;gBACvC,CAAC;QAEH,WAAW,CAAC,SAAW,IAAI;gBAAE;YAAO;QAEpC,aAAa,CAAC,WAAa,IAAI;gBAAE;YAAS;QAE1C,UAAU,CAAC,QAAU,IAAI;gBAAE;gBAAO,QAAQ,QAAQ,UAAU;YAAO;QAEnE,WAAW,CAAC,SAAW,IAAI;gBAAE;gBAAQ,QAAQ,SAAS,cAAc;YAAO;QAE3E,kBAAkB,CAAC,SAAW,IAAI;gBAAE,eAAe;YAAO;QAE1D,OAAO,IACL,IAAI;gBACF,QAAQ;gBACR,UAAU;gBACV,OAAO;gBACP,QAAQ;YACV;QAEF,qBAAqB;QACrB,mBAAmB,CAAC,UAAY,IAAI;gBAAE,gBAAgB;YAAQ;QAE9D,qBAAqB,CAAC,SACpB,IAAI,CAAC,QAAU,CAAC;oBACd,mBAAmB;2BACd,MAAM,iBAAiB,CAAC,MAAM,CAAC,CAAC,IAAM,EAAE,MAAM,KAAK,OAAO,MAAM;wBACnE;qBACD;gBACH,CAAC;QAEH,wBAAwB,IAAM,IAAI;gBAAE,mBAAmB,EAAE;YAAC;QAE1D,kBAAkB,CAAC,SAAW,IAAI;gBAAE,eAAe;YAAO;IAC5D,CAAC","debugId":null}},
    {"offset": {"line": 2544, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/core/ports.ts"],"sourcesContent":["/**\n * Port types and connection definitions for drivetrain components.\n */\n\nexport enum PortType {\n  /** Rotating shaft: (omega [rad/s], torque [N*m]) */\n  MECHANICAL = 'MECHANICAL',\n  /** Power bus: (voltage [V], current [A]) */\n  ELECTRICAL = 'ELECTRICAL',\n}\n\nexport enum PortDirection {\n  INPUT = 'INPUT',\n  OUTPUT = 'OUTPUT',\n  BIDIRECTIONAL = 'BIDIRECTIONAL',\n}\n\nexport interface Port {\n  readonly name: string;\n  readonly portType: PortType;\n  readonly direction: PortDirection;\n  readonly description?: string;\n}\n\nexport interface Connection {\n  readonly fromComponent: string;\n  readonly fromPort: string;\n  readonly toComponent: string;\n  readonly toPort: string;\n}\n\n/**\n * Create a mechanical port.\n */\nexport function mechanicalPort(\n  name: string,\n  direction: PortDirection,\n  description?: string\n): Port {\n  return {\n    name,\n    portType: PortType.MECHANICAL,\n    direction,\n    description,\n  };\n}\n\n/**\n * Create an electrical port.\n */\nexport function electricalPort(\n  name: string,\n  direction: PortDirection,\n  description?: string\n): Port {\n  return {\n    name,\n    portType: PortType.ELECTRICAL,\n    direction,\n    description,\n  };\n}\n\n/**\n * Check if two ports can be connected.\n */\nexport function canConnect(portA: Port, portB: Port): boolean {\n  // Must be same type\n  if (portA.portType !== portB.portType) {\n    return false;\n  }\n\n  // Check direction compatibility\n  if (portA.direction === PortDirection.BIDIRECTIONAL ||\n      portB.direction === PortDirection.BIDIRECTIONAL) {\n    return true;\n  }\n\n  // OUTPUT can connect to INPUT\n  return (\n    (portA.direction === PortDirection.OUTPUT && portB.direction === PortDirection.INPUT) ||\n    (portA.direction === PortDirection.INPUT && portB.direction === PortDirection.OUTPUT)\n  );\n}\n"],"names":[],"mappings":"AAAA;;CAEC;;;;;;;;;;;;AAEM,IAAA,AAAK,kCAAA;IACV,kDAAkD;IAElD,0CAA0C;WAHhC;;AAOL,IAAA,AAAK,uCAAA;;;;WAAA;;AAuBL,SAAS,eACd,IAAY,EACZ,SAAwB,EACxB,WAAoB;IAEpB,OAAO;QACL;QACA,QAAQ;QACR;QACA;IACF;AACF;AAKO,SAAS,eACd,IAAY,EACZ,SAAwB,EACxB,WAAoB;IAEpB,OAAO;QACL;QACA,QAAQ;QACR;QACA;IACF;AACF;AAKO,SAAS,WAAW,KAAW,EAAE,KAAW;IACjD,oBAAoB;IACpB,IAAI,MAAM,QAAQ,KAAK,MAAM,QAAQ,EAAE;QACrC,OAAO;IACT;IAEA,gCAAgC;IAChC,IAAI,MAAM,SAAS,wBACf,MAAM,SAAS,sBAAkC;QACnD,OAAO;IACT;IAEA,8BAA8B;IAC9B,OACE,AAAC,MAAM,SAAS,iBAA6B,MAAM,SAAS,gBAC3D,MAAM,SAAS,gBAA4B,MAAM,SAAS;AAE/D","debugId":null}},
    {"offset": {"line": 2601, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/core/component.ts"],"sourcesContent":["/**\n * Base class for all drivetrain components.\n */\n\nimport { Port, PortType } from './ports';\nimport { KinematicConstraint } from './constraints';\n\n/**\n * Values at a component's ports.\n */\nexport interface PortValues {\n  [key: string]: number;\n}\n\n/**\n * Abstract base class for drivetrain components.\n *\n * Components represent physical elements like engines, motors, gearboxes, etc.\n * Each component has:\n * - Ports: Connection points (mechanical shafts, electrical buses)\n * - Internal states: Variables that evolve over time (e.g., SOC)\n * - Inertia: Rotational inertia at mechanical ports\n * - Constraints: Internal kinematic relationships (e.g., gear ratios)\n */\nexport abstract class DrivetrainComponent {\n  protected _name: string;\n\n  constructor(name: string = 'component') {\n    this._name = name;\n  }\n\n  get name(): string {\n    return this._name;\n  }\n\n  set name(value: string) {\n    this._name = value;\n  }\n\n  /** Get all ports for this component. */\n  abstract get ports(): Record<string, Port>;\n\n  /** Get names of internal state variables. */\n  abstract get stateNames(): string[];\n\n  /** Get rotational inertia at a mechanical port [kg*m^2]. */\n  abstract getInertia(portName: string): number;\n\n  /** Get kinematic constraints within this component. */\n  abstract getConstraints(): KinematicConstraint[];\n\n  /**\n   * Compute output torques based on port speeds and control inputs.\n   *\n   * @param portSpeeds - Angular velocities at each port [rad/s]\n   * @param controlInputs - Control signals (e.g., torque command)\n   * @param internalStates - Current values of internal states\n   * @returns Torques produced at each port [N*m]\n   */\n  abstract computeTorques(\n    portSpeeds: Record<string, number>,\n    controlInputs: Record<string, number>,\n    internalStates?: Record<string, number>\n  ): Record<string, number>;\n\n  /**\n   * Compute derivatives of internal states.\n   *\n   * @param internalStates - Current values of internal states\n   * @param portValues - Port speeds and torques\n   * @returns Time derivatives of each state\n   */\n  abstract computeStateDerivatives(\n    internalStates: Record<string, number>,\n    portValues: PortValues\n  ): Record<string, number>;\n\n  /** Get a port by name. */\n  getPort(name: string): Port | undefined {\n    return this.ports[name];\n  }\n\n  /** Check if a port exists. */\n  hasPort(name: string): boolean {\n    return name in this.ports;\n  }\n\n  /** Get all mechanical ports. */\n  getMechanicalPorts(): Record<string, Port> {\n    const result: Record<string, Port> = {};\n    for (const [name, port] of Object.entries(this.ports)) {\n      if (port.portType === PortType.MECHANICAL) {\n        result[name] = port;\n      }\n    }\n    return result;\n  }\n\n  /** Get all electrical ports. */\n  getElectricalPorts(): Record<string, Port> {\n    const result: Record<string, Port> = {};\n    for (const [name, port] of Object.entries(this.ports)) {\n      if (port.portType === PortType.ELECTRICAL) {\n        result[name] = port;\n      }\n    }\n    return result;\n  }\n\n  /** Get total inertia across all mechanical ports. */\n  getTotalInertia(): number {\n    let total = 0;\n    for (const portName of Object.keys(this.getMechanicalPorts())) {\n      total += this.getInertia(portName);\n    }\n    return total;\n  }\n\n  /** Validate component configuration. Returns list of error messages. */\n  validate(): string[] {\n    const errors: string[] = [];\n\n    // Check that all ports have valid types\n    for (const [name, port] of Object.entries(this.ports)) {\n      if (!port.portType) {\n        errors.push(`Port '${name}' has no type`);\n      }\n    }\n\n    return errors;\n  }\n}\n"],"names":[],"mappings":"AAAA;;CAEC;;;;AAED;;AAoBO,MAAe;IACV,MAAc;IAExB,YAAY,OAAe,WAAW,CAAE;QACtC,IAAI,CAAC,KAAK,GAAG;IACf;IAEA,IAAI,OAAe;QACjB,OAAO,IAAI,CAAC,KAAK;IACnB;IAEA,IAAI,KAAK,KAAa,EAAE;QACtB,IAAI,CAAC,KAAK,GAAG;IACf;IAwCA,wBAAwB,GACxB,QAAQ,IAAY,EAAoB;QACtC,OAAO,IAAI,CAAC,KAAK,CAAC,KAAK;IACzB;IAEA,4BAA4B,GAC5B,QAAQ,IAAY,EAAW;QAC7B,OAAO,QAAQ,IAAI,CAAC,KAAK;IAC3B;IAEA,8BAA8B,GAC9B,qBAA2C;QACzC,MAAM,SAA+B,CAAC;QACtC,KAAK,MAAM,CAAC,MAAM,KAAK,IAAI,OAAO,OAAO,CAAC,IAAI,CAAC,KAAK,EAAG;YACrD,IAAI,KAAK,QAAQ,KAAK,iKAAQ,CAAC,UAAU,EAAE;gBACzC,MAAM,CAAC,KAAK,GAAG;YACjB;QACF;QACA,OAAO;IACT;IAEA,8BAA8B,GAC9B,qBAA2C;QACzC,MAAM,SAA+B,CAAC;QACtC,KAAK,MAAM,CAAC,MAAM,KAAK,IAAI,OAAO,OAAO,CAAC,IAAI,CAAC,KAAK,EAAG;YACrD,IAAI,KAAK,QAAQ,KAAK,iKAAQ,CAAC,UAAU,EAAE;gBACzC,MAAM,CAAC,KAAK,GAAG;YACjB;QACF;QACA,OAAO;IACT;IAEA,mDAAmD,GACnD,kBAA0B;QACxB,IAAI,QAAQ;QACZ,KAAK,MAAM,YAAY,OAAO,IAAI,CAAC,IAAI,CAAC,kBAAkB,IAAK;YAC7D,SAAS,IAAI,CAAC,UAAU,CAAC;QAC3B;QACA,OAAO;IACT;IAEA,sEAAsE,GACtE,WAAqB;QACnB,MAAM,SAAmB,EAAE;QAE3B,wCAAwC;QACxC,KAAK,MAAM,CAAC,MAAM,KAAK,IAAI,OAAO,OAAO,CAAC,IAAI,CAAC,KAAK,EAAG;YACrD,IAAI,CAAC,KAAK,QAAQ,EAAE;gBAClB,OAAO,IAAI,CAAC,CAAC,MAAM,EAAE,KAAK,aAAa,CAAC;YAC1C;QACF;QAEA,OAAO;IACT;AACF","debugId":null}},
    {"offset": {"line": 2666, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/core/constraints.ts"],"sourcesContent":["/**\n * Kinematic constraints that relate speeds and torques between ports.\n */\n\n/**\n * Speed relation: sum(coeff_i * omega_i) = 0\n * Maps port names to coefficients.\n */\nexport type SpeedRelation = Record<string, number>;\n\n/**\n * Base interface for kinematic constraints.\n */\nexport interface KinematicConstraint {\n  /** Get the speed relation coefficients. */\n  getSpeedRelation(): SpeedRelation;\n\n  /** Get the port whose DOF is eliminated by this constraint. */\n  getDependentPort(): string;\n\n  /** Get the ports that remain independent. */\n  getIndependentPorts(): string[];\n}\n\n/**\n * Gear ratio constraint: omega_out = omega_in / ratio\n *\n * Speed relation: omega_in - ratio * omega_out = 0\n * Torque relation: T_out = T_in * ratio * efficiency\n */\nexport interface GearRatioConstraintConfig {\n  inputPort: string;\n  outputPort: string;\n  ratio: number;\n  efficiency?: number;\n}\n\nexport class GearRatioConstraint implements KinematicConstraint {\n  readonly inputPort: string;\n  readonly outputPort: string;\n  readonly ratio: number;\n  readonly efficiency: number;\n\n  constructor(config: GearRatioConstraintConfig) {\n    this.inputPort = config.inputPort;\n    this.outputPort = config.outputPort;\n    this.ratio = config.ratio;\n    this.efficiency = config.efficiency ?? 1.0;\n  }\n\n  getSpeedRelation(): SpeedRelation {\n    // omega_in - ratio * omega_out = 0\n    return {\n      [this.inputPort]: 1.0,\n      [this.outputPort]: -this.ratio,\n    };\n  }\n\n  getDependentPort(): string {\n    return this.outputPort;\n  }\n\n  getIndependentPorts(): string[] {\n    return [this.inputPort];\n  }\n\n  /** Transform input speed to output speed. */\n  transformSpeed(omegaIn: number): number {\n    return omegaIn / this.ratio;\n  }\n\n  /** Transform output torque to input torque (back-propagation). */\n  transformTorque(torqueOut: number): number {\n    return torqueOut / (this.ratio * this.efficiency);\n  }\n\n  /** Get inertia reflected through the gear ratio. */\n  getReflectedInertia(jOutput: number): number {\n    return jOutput / (this.ratio * this.ratio);\n  }\n}\n\n/**\n * Willis constraint for planetary gear sets.\n *\n * omega_sun = (1 + rho) * omega_carrier - rho * omega_ring\n *\n * where rho = Z_ring / Z_sun (typically 2-4)\n *\n * Torque balance: T_sun : T_carrier : T_ring = 1 : -(1+rho) : rho\n */\nexport interface WillisConstraintConfig {\n  sunPort: string;\n  carrierPort: string;\n  ringPort: string;\n  rho: number;\n}\n\nexport class WillisConstraint implements KinematicConstraint {\n  readonly sunPort: string;\n  readonly carrierPort: string;\n  readonly ringPort: string;\n  readonly rho: number;\n\n  constructor(config: WillisConstraintConfig) {\n    this.sunPort = config.sunPort;\n    this.carrierPort = config.carrierPort;\n    this.ringPort = config.ringPort;\n    this.rho = config.rho;\n  }\n\n  getSpeedRelation(): SpeedRelation {\n    // omega_sun - (1+rho)*omega_carrier + rho*omega_ring = 0\n    return {\n      [this.sunPort]: 1.0,\n      [this.carrierPort]: -(1 + this.rho),\n      [this.ringPort]: this.rho,\n    };\n  }\n\n  getDependentPort(): string {\n    // Sun is typically eliminated (connected to MG1)\n    return this.sunPort;\n  }\n\n  getIndependentPorts(): string[] {\n    return [this.carrierPort, this.ringPort];\n  }\n\n  /** Calculate sun speed from carrier and ring speeds. */\n  calcSunSpeed(omegaCarrier: number, omegaRing: number): number {\n    return (1 + this.rho) * omegaCarrier - this.rho * omegaRing;\n  }\n\n  /** Calculate carrier speed from sun and ring speeds. */\n  calcCarrierSpeed(omegaSun: number, omegaRing: number): number {\n    return (omegaSun + this.rho * omegaRing) / (1 + this.rho);\n  }\n\n  /** Calculate ring speed from carrier and sun speeds. */\n  calcRingSpeed(omegaCarrier: number, omegaSun: number): number {\n    return ((1 + this.rho) * omegaCarrier - omegaSun) / this.rho;\n  }\n\n  /**\n   * Get torque ratios: [sun, carrier, ring]\n   *\n   * T_sun : T_carrier : T_ring = 1 : -(1+rho) : rho\n   *\n   * If sun torque is T_s, then:\n   * - Carrier torque = -(1+rho) * T_s\n   * - Ring torque = rho * T_s\n   */\n  getTorqueRatios(): [number, number, number] {\n    return [1.0, -(1 + this.rho), this.rho];\n  }\n\n  /**\n   * Get inertia coupling coefficients for 2-DOF system (carrier, ring).\n   *\n   * With sun eliminated, the coupled inertia matrix from sun's inertia J_sun is:\n   * J_cc = (1+rho)^2 * J_sun\n   * J_cr = -(1+rho) * rho * J_sun  (off-diagonal)\n   * J_rr = rho^2 * J_sun\n   */\n  getInertiaCoefficients(): {\n    carrierCarrier: number;\n    carrierRing: number;\n    ringRing: number;\n  } {\n    const onePlusRho = 1 + this.rho;\n    return {\n      carrierCarrier: onePlusRho * onePlusRho,\n      carrierRing: -onePlusRho * this.rho,\n      ringRing: this.rho * this.rho,\n    };\n  }\n}\n\n/**\n * Rigid connection constraint: omega_a = omega_b\n *\n * Used for shaft couplings and parallel connections.\n */\nexport class RigidConnectionConstraint implements KinematicConstraint {\n  readonly portA: string;\n  readonly portB: string;\n\n  constructor(portA: string, portB: string) {\n    this.portA = portA;\n    this.portB = portB;\n  }\n\n  getSpeedRelation(): SpeedRelation {\n    // omega_a - omega_b = 0\n    return {\n      [this.portA]: 1.0,\n      [this.portB]: -1.0,\n    };\n  }\n\n  getDependentPort(): string {\n    return this.portB;\n  }\n\n  getIndependentPorts(): string[] {\n    return [this.portA];\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2811, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/math/linalg.ts"],"sourcesContent":["/**\n * Minimal linear algebra utilities for drivetrain simulation.\n */\n\n/**\n * Solve Ax = b using Gaussian elimination with partial pivoting.\n *\n * For small matrices (< 10x10 for drivetrain systems), this is efficient enough.\n *\n * @param A - Coefficient matrix (n x n)\n * @param b - Right-hand side vector (n)\n * @returns Solution vector x (n)\n * @throws Error if matrix is singular\n */\nexport function solveLinear(A: number[][], b: number[]): number[] {\n  const n = A.length;\n\n  if (n === 0) {\n    return [];\n  }\n\n  // Create augmented matrix [A | b]\n  const aug: number[][] = A.map((row, i) => [...row, b[i]]);\n\n  // Forward elimination with partial pivoting\n  for (let k = 0; k < n; k++) {\n    // Find pivot (largest absolute value in column k)\n    let maxIdx = k;\n    let maxVal = Math.abs(aug[k][k]);\n\n    for (let i = k + 1; i < n; i++) {\n      const absVal = Math.abs(aug[i][k]);\n      if (absVal > maxVal) {\n        maxVal = absVal;\n        maxIdx = i;\n      }\n    }\n\n    // Swap rows if needed\n    if (maxIdx !== k) {\n      [aug[k], aug[maxIdx]] = [aug[maxIdx], aug[k]];\n    }\n\n    // Check for singularity\n    const pivot = aug[k][k];\n    if (Math.abs(pivot) < 1e-15) {\n      throw new Error('Singular matrix in solveLinear');\n    }\n\n    // Eliminate column k below pivot\n    for (let i = k + 1; i < n; i++) {\n      const factor = aug[i][k] / pivot;\n      for (let j = k; j <= n; j++) {\n        aug[i][j] -= factor * aug[k][j];\n      }\n    }\n  }\n\n  // Back substitution\n  const x = new Array(n).fill(0);\n  for (let i = n - 1; i >= 0; i--) {\n    let sum = aug[i][n];\n    for (let j = i + 1; j < n; j++) {\n      sum -= aug[i][j] * x[j];\n    }\n    x[i] = sum / aug[i][i];\n  }\n\n  return x;\n}\n\n/**\n * Matrix-vector multiplication: y = A * x\n */\nexport function matVecMul(A: number[][], x: number[]): number[] {\n  return A.map(row => row.reduce((sum, val, j) => sum + val * x[j], 0));\n}\n\n/**\n * Create a zero matrix of size n x m.\n */\nexport function zeros(n: number, m: number): number[][] {\n  return Array.from({ length: n }, () => new Array(m).fill(0));\n}\n\n/**\n * Create an identity matrix of size n.\n */\nexport function eye(n: number): number[][] {\n  const I = zeros(n, n);\n  for (let i = 0; i < n; i++) {\n    I[i][i] = 1;\n  }\n  return I;\n}\n\n/**\n * Add two vectors: c = a + b\n */\nexport function addVectors(a: number[], b: number[]): number[] {\n  return a.map((val, i) => val + b[i]);\n}\n\n/**\n * Subtract two vectors: c = a - b\n */\nexport function subtractVectors(a: number[], b: number[]): number[] {\n  return a.map((val, i) => val - b[i]);\n}\n\n/**\n * Scale a vector: c = scalar * a\n */\nexport function scaleVector(scalar: number, a: number[]): number[] {\n  return a.map(val => scalar * val);\n}\n\n/**\n * Dot product of two vectors.\n */\nexport function dot(a: number[], b: number[]): number {\n  return a.reduce((sum, val, i) => sum + val * b[i], 0);\n}\n\n/**\n * Copy a 2D array (matrix).\n */\nexport function copyMatrix(A: number[][]): number[][] {\n  return A.map(row => [...row]);\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2931, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/core/drivetrain.ts"],"sourcesContent":["/**\n * Compiled drivetrain with automatically-derived dynamics.\n */\n\nimport { DrivetrainTopology } from './topology';\nimport { DrivetrainComponent } from './component';\nimport {\n  KinematicConstraint,\n  RigidConnectionConstraint,\n} from './constraints';\nimport { PortType } from './ports';\nimport { solveLinear } from '../math/linalg';\n\n/**\n * Information about a degree of freedom in the system.\n */\nexport interface DOFInfo {\n  /** e.g., \"engine.shaft\" or \"gearbox.output\" */\n  name: string;\n  component: string;\n  port: string;\n  index: number;\n}\n\n/**\n * Information about an applied constraint.\n */\nexport interface ConstraintInfo {\n  constraint: KinematicConstraint;\n  component: string;\n  /** The DOF that was eliminated */\n  eliminatedDof: string;\n  /** How to compute eliminated DOF from independent DOFs */\n  expression: Record<string, number>;\n}\n\n/**\n * A compiled drivetrain ready for simulation.\n *\n * The Drivetrain class takes a topology and automatically derives:\n * - The independent degrees of freedom (after constraint reduction)\n * - The inertia matrix relating accelerations to torques\n * - Methods for computing dynamics for ODE integration\n *\n * The state vector consists of:\n * 1. Mechanical DOF speeds (omega values for independent shafts)\n * 2. Internal component states (e.g., battery SOC)\n */\nexport class Drivetrain {\n  readonly topology: DrivetrainTopology;\n  private _components: Map<string, DrivetrainComponent>;\n  private _allDofs: DOFInfo[] = [];\n  private _independentDofs: DOFInfo[] = [];\n  private _eliminatedDofs: Map<string, ConstraintInfo> = new Map();\n  private _internalStates: Array<[string, string]> = [];\n  private _controlInputs: string[] = [];\n  private _inertiaMatrix: number[][] | null = null;\n  private _gearState: Map<string, number> = new Map();\n\n  constructor(topology: DrivetrainTopology) {\n    this.topology = topology;\n    this._components = topology.components;\n    this._compile();\n  }\n\n  private _compile(): void {\n    this._identifyDofs();\n    this._applyConstraints();\n    this._collectInternalStates();\n    this._identifyControlInputs();\n    this._buildInertiaMatrix();\n  }\n\n  private _identifyDofs(): void {\n    const allDofs: DOFInfo[] = [];\n    let idx = 0;\n\n    for (const [compName, component] of this._components) {\n      for (const portName of Object.keys(component.getMechanicalPorts())) {\n        const dofName = `${compName}.${portName}`;\n        allDofs.push({ name: dofName, component: compName, port: portName, index: idx });\n        idx++;\n      }\n    }\n\n    this._allDofs = allDofs;\n  }\n\n  private _applyConstraints(): void {\n    // Start with all DOFs as independent\n    const independent = new Map<string, DOFInfo>();\n    for (const dof of this._allDofs) {\n      independent.set(dof.name, dof);\n    }\n    const eliminated = new Map<string, ConstraintInfo>();\n\n    // First, handle connections between components (speed equality constraints)\n    for (const conn of this.topology.connections) {\n      const fromDof = `${conn.fromComponent}.${conn.fromPort}`;\n      const toDof = `${conn.toComponent}.${conn.toPort}`;\n\n      // Check port types\n      const fromPort = this._components.get(conn.fromComponent)!.getPort(conn.fromPort);\n      if (fromPort?.portType !== PortType.MECHANICAL) {\n        continue; // Skip electrical connections\n      }\n\n      // The \"to\" port takes on the \"from\" port's speed\n      if (independent.has(toDof)) {\n        independent.delete(toDof);\n        eliminated.set(toDof, {\n          constraint: new RigidConnectionConstraint(fromDof, toDof),\n          component: 'connection',\n          eliminatedDof: toDof,\n          expression: { [fromDof]: 1.0 },\n        });\n      }\n    }\n\n    // Then, handle component internal constraints\n    for (const [compName, component] of this._components) {\n      for (const constraint of component.getConstraints()) {\n        const dependentPort = constraint.getDependentPort();\n        const dependentDof = `${compName}.${dependentPort}`;\n\n        // Build expression for the dependent DOF\n        const expression: Record<string, number> = {};\n        const relation = constraint.getSpeedRelation();\n\n        // Find the coefficient for the dependent DOF\n        const depCoeff = relation[dependentPort] ?? 0;\n        if (Math.abs(depCoeff) < 1e-12) {\n          continue; // Can't eliminate this DOF\n        }\n\n        // Express dependent DOF in terms of others\n        for (const [portName, coeff] of Object.entries(relation)) {\n          if (portName === dependentPort) {\n            continue;\n          }\n          const fullName = `${compName}.${portName}`;\n\n          // Resolve through any previous eliminations\n          const resolved = this._resolveDof(fullName, independent, eliminated);\n          for (const [dofName, factor] of Object.entries(resolved)) {\n            const current = expression[dofName] ?? 0;\n            expression[dofName] = current - (coeff / depCoeff) * factor;\n          }\n        }\n\n        // If dependent DOF is already eliminated, follow the chain\n        if (!independent.has(dependentDof)) {\n          if (eliminated.has(dependentDof)) {\n            const connInfo = eliminated.get(dependentDof)!;\n            // Only handle 1:1 connections (rigid connections)\n            const exprKeys = Object.keys(connInfo.expression);\n            if (exprKeys.length === 1) {\n              const connectedDof = exprKeys[0];\n              const coeffConnection = connInfo.expression[connectedDof];\n              if (Math.abs(coeffConnection - 1.0) < 1e-12 && independent.has(connectedDof)) {\n                // Eliminate the connected DOF with the constraint expression\n                independent.delete(connectedDof);\n                eliminated.set(connectedDof, {\n                  constraint,\n                  component: compName,\n                  eliminatedDof: connectedDof,\n                  expression,\n                });\n              }\n            }\n          }\n          continue;\n        }\n\n        independent.delete(dependentDof);\n        eliminated.set(dependentDof, {\n          constraint,\n          component: compName,\n          eliminatedDof: dependentDof,\n          expression,\n        });\n      }\n    }\n\n    // Re-index remaining independent DOFs\n    this._independentDofs = [];\n    let idx = 0;\n    for (const [name, dofInfo] of independent) {\n      this._independentDofs.push({\n        name,\n        component: dofInfo.component,\n        port: dofInfo.port,\n        index: idx,\n      });\n      idx++;\n    }\n\n    this._eliminatedDofs = eliminated;\n  }\n\n  private _resolveDof(\n    dofName: string,\n    independent: Map<string, DOFInfo>,\n    eliminated: Map<string, ConstraintInfo>\n  ): Record<string, number> {\n    if (independent.has(dofName)) {\n      return { [dofName]: 1.0 };\n    }\n\n    if (eliminated.has(dofName)) {\n      const info = eliminated.get(dofName)!;\n      const result: Record<string, number> = {};\n      for (const [subDof, coeff] of Object.entries(info.expression)) {\n        const subResolved = this._resolveDof(subDof, independent, eliminated);\n        for (const [finalDof, finalCoeff] of Object.entries(subResolved)) {\n          const current = result[finalDof] ?? 0;\n          result[finalDof] = current + coeff * finalCoeff;\n        }\n      }\n      return result;\n    }\n\n    // DOF not found\n    throw new Error(`DOF '${dofName}' not found in topology`);\n  }\n\n  private _collectInternalStates(): void {\n    this._internalStates = [];\n    for (const [compName, component] of this._components) {\n      for (const stateName of component.stateNames) {\n        this._internalStates.push([compName, stateName]);\n      }\n    }\n  }\n\n  private _identifyControlInputs(): void {\n    this._controlInputs = [];\n\n    for (const [compName, component] of this._components) {\n      const compType = component.constructor.name;\n      if (compType.includes('Engine')) {\n        this._controlInputs.push(`T_${compName}`);\n      } else if (compType.includes('Motor')) {\n        this._controlInputs.push(`T_${compName}`);\n      }\n    }\n\n    // Add gear selection for gearboxes\n    for (const [compName, component] of this._components) {\n      const compType = component.constructor.name;\n      if (compType.includes('Gearbox')) {\n        this._controlInputs.push(`gear_${compName}`);\n        this._gearState.set(compName, 0);\n      }\n    }\n  }\n\n  private _buildInertiaMatrix(): void {\n    const nDof = this._independentDofs.length;\n    const J: number[][] = [];\n    for (let i = 0; i < nDof; i++) {\n      J.push(new Array(nDof).fill(0));\n    }\n\n    for (let i = 0; i < nDof; i++) {\n      for (let j = 0; j < nDof; j++) {\n        J[i][j] = this._computeCoupledInertia(\n          this._independentDofs[i],\n          this._independentDofs[j]\n        );\n      }\n    }\n\n    this._inertiaMatrix = J;\n  }\n\n  private _computeCoupledInertia(dofI: DOFInfo, dofJ: DOFInfo): number {\n    let total = 0;\n\n    const contributionsI = this._getInertiaContributions(dofI.name);\n    const contributionsJ = this._getInertiaContributions(dofJ.name);\n\n    for (const [key, coeffI] of contributionsI) {\n      const coeffJ = contributionsJ.get(key) ?? 0;\n      if (Math.abs(coeffJ) > 1e-12) {\n        const [comp, port] = key.split(':');\n        const jPort = this._components.get(comp)!.getInertia(port);\n        total += jPort * coeffI * coeffJ;\n      }\n    }\n\n    return total;\n  }\n\n  private _getInertiaContributions(dofName: string): Map<string, number> {\n    const contributions = new Map<string, number>();\n\n    // The DOF's own port\n    for (const dof of this._independentDofs) {\n      if (dof.name === dofName) {\n        contributions.set(`${dof.component}:${dof.port}`, 1.0);\n      }\n    }\n\n    // Build resolved expressions for all eliminated DOFs\n    const independentMap = new Map<string, DOFInfo>();\n    for (const dof of this._independentDofs) {\n      independentMap.set(dof.name, dof);\n    }\n\n    const resolvedExpressions = new Map<string, Record<string, number>>();\n    for (const [elimName] of this._eliminatedDofs) {\n      const resolved = this._resolveDof(elimName, independentMap, this._eliminatedDofs);\n      resolvedExpressions.set(elimName, resolved);\n    }\n\n    // Add contributions from eliminated DOFs that depend on dofName\n    for (const [elimName, resolved] of resolvedExpressions) {\n      const coeff = resolved[dofName] ?? 0;\n      if (Math.abs(coeff) > 1e-12) {\n        const parts = elimName.split('.');\n        contributions.set(`${parts[0]}:${parts[1]}`, coeff);\n      }\n    }\n\n    return contributions;\n  }\n\n  /** Names of all state variables. */\n  get stateNames(): string[] {\n    const names = this._independentDofs.map((dof) => dof.name);\n    for (const [comp, state] of this._internalStates) {\n      names.push(`${comp}.${state}`);\n    }\n    return names;\n  }\n\n  /** Number of mechanical degrees of freedom. */\n  get nMechanicalDofs(): number {\n    return this._independentDofs.length;\n  }\n\n  /** Number of internal state variables. */\n  get nInternalStates(): number {\n    return this._internalStates.length;\n  }\n\n  /** Total number of state variables. */\n  get nStates(): number {\n    return this.nMechanicalDofs + this.nInternalStates;\n  }\n\n  /** Names of control inputs. */\n  get controlNames(): string[] {\n    return this._controlInputs;\n  }\n\n  /** The compiled inertia matrix. */\n  get inertiaMatrix(): number[][] {\n    if (this._inertiaMatrix === null) {\n      this._buildInertiaMatrix();\n    }\n    return this._inertiaMatrix!;\n  }\n\n  /** Get a component by name. */\n  getComponent(name: string): DrivetrainComponent | undefined {\n    return this._components.get(name);\n  }\n\n  /** Set the current gear for a gearbox component. */\n  setGear(component: string, gear: number): void {\n    if (this._gearState.has(component)) {\n      this._gearState.set(component, gear);\n      // Rebuild since ratios changed\n      this._applyConstraints();\n      this._buildInertiaMatrix();\n    }\n  }\n\n  /** Convert state dict to array. */\n  stateToArray(state: Record<string, number>): number[] {\n    const x = new Array(this.nStates).fill(0);\n    for (let i = 0; i < this.stateNames.length; i++) {\n      x[i] = state[this.stateNames[i]] ?? 0;\n    }\n    return x;\n  }\n\n  /** Convert state array to dict. */\n  arrayToState(x: number[]): Record<string, number> {\n    const result: Record<string, number> = {};\n    for (let i = 0; i < this.stateNames.length; i++) {\n      result[this.stateNames[i]] = x[i];\n    }\n    return result;\n  }\n\n  /**\n   * Compute all port speeds from state vector.\n   *\n   * Returns speeds for both independent and constrained DOFs.\n   */\n  getAllSpeeds(x: number[]): Record<string, number> {\n    const state = this.arrayToState(x);\n    const speeds: Record<string, number> = {};\n\n    // Independent DOFs have speeds directly in state\n    for (const dof of this._independentDofs) {\n      speeds[dof.name] = state[dof.name] ?? 0;\n    }\n\n    // Constrained DOFs computed from constraints (with recursive resolution)\n    const resolveSpeed = (dofName: string): number => {\n      if (speeds[dofName] !== undefined) {\n        return speeds[dofName];\n      }\n\n      if (this._eliminatedDofs.has(dofName)) {\n        const info = this._eliminatedDofs.get(dofName)!;\n        let omega = 0;\n        for (const [depName, coeff] of Object.entries(info.expression)) {\n          omega += coeff * resolveSpeed(depName);\n        }\n        speeds[dofName] = omega;\n        return omega;\n      }\n\n      return 0;\n    };\n\n    for (const elimName of this._eliminatedDofs.keys()) {\n      resolveSpeed(elimName);\n    }\n\n    return speeds;\n  }\n\n  /**\n   * Compute state derivatives for ODE integration.\n   *\n   * @param t - Current time [s]\n   * @param x - State vector [omega_1, ..., omega_n, state_1, ..., state_m]\n   * @param control - Control inputs (torques, gear selections)\n   * @param disturbance - Disturbance inputs (e.g., grade)\n   * @returns State derivative vector dx/dt\n   */\n  dynamics(\n    t: number,\n    x: number[],\n    control: Record<string, number>,\n    disturbance: Record<string, number>\n  ): number[] {\n    const dx = new Array(x.length).fill(0);\n\n    // Get all port speeds\n    const allSpeeds = this.getAllSpeeds(x);\n\n    // Update gear states from control\n    for (const compName of this._gearState.keys()) {\n      const gearKey = `gear_${compName}`;\n      if (gearKey in control) {\n        const newGear = Math.floor(control[gearKey]);\n        if (newGear !== this._gearState.get(compName)) {\n          this.setGear(compName, newGear);\n        }\n      }\n    }\n\n    // Compute torques from all components\n    const allTorques: Record<string, number> = {};\n\n    for (const [compName, component] of this._components) {\n      // Build port speeds dict for this component\n      const portSpeeds: Record<string, number> = {};\n      for (const portName of Object.keys(component.getMechanicalPorts())) {\n        const dofName = `${compName}.${portName}`;\n        portSpeeds[portName] = allSpeeds[dofName] ?? 0;\n      }\n\n      // Build control inputs for this component\n      const compControl: Record<string, number> = {};\n      const torqueKey = `T_${compName}`;\n      if (torqueKey in control) {\n        compControl.torque = control[torqueKey];\n      }\n\n      // Get internal states for this component\n      const internal: Record<string, number> = {};\n      for (const stateName of component.stateNames) {\n        const fullName = `${compName}.${stateName}`;\n        const idx = this.stateNames.indexOf(fullName);\n        internal[stateName] = x[idx];\n      }\n\n      // Compute torques\n      const torques = component.computeTorques(portSpeeds, compControl, internal);\n      for (const [portName, torque] of Object.entries(torques)) {\n        const dofName = `${compName}.${portName}`;\n        allTorques[dofName] = torque;\n      }\n    }\n\n    // Build generalized force vector\n    const tau = new Array(this.nMechanicalDofs).fill(0);\n\n    // First, resolve all eliminated DOFs to independent DOFs\n    const independentMap = new Map<string, DOFInfo>();\n    for (const dof of this._independentDofs) {\n      independentMap.set(dof.name, dof);\n    }\n\n    const resolvedCoeffs = new Map<string, Record<string, number>>();\n    for (const elimName of this._eliminatedDofs.keys()) {\n      resolvedCoeffs.set(\n        elimName,\n        this._resolveDof(elimName, independentMap, this._eliminatedDofs)\n      );\n    }\n\n    for (let i = 0; i < this._independentDofs.length; i++) {\n      const dof = this._independentDofs[i];\n\n      // Direct torque on this DOF\n      tau[i] += allTorques[dof.name] ?? 0;\n\n      // Add torques from constrained DOFs, using resolved coefficients\n      for (const [elimName, resolved] of resolvedCoeffs) {\n        const coeff = resolved[dof.name] ?? 0;\n        if (Math.abs(coeff) > 1e-12) {\n          tau[i] += coeff * (allTorques[elimName] ?? 0);\n        }\n      }\n    }\n\n    // Add load torque (from vehicle component) with grade\n    const grade = disturbance.grade ?? 0;\n    this._addLoadTorque(tau, allSpeeds, grade);\n\n    // Solve for accelerations: J * omega_dot = tau\n    const J = this.inertiaMatrix;\n    if (this.nMechanicalDofs > 0) {\n      const omegaDot = solveLinear(J, tau);\n      for (let i = 0; i < this.nMechanicalDofs; i++) {\n        dx[i] = omegaDot[i];\n      }\n    }\n\n    // Compute internal state derivatives\n    for (let i = 0; i < this._internalStates.length; i++) {\n      const [compName, stateName] = this._internalStates[i];\n      const component = this._components.get(compName)!;\n\n      // Get port values\n      const portValues: Record<string, number> = {};\n      for (const portName of Object.keys(component.ports)) {\n        const dofName = `${compName}.${portName}`;\n        portValues[`${portName}_speed`] = allSpeeds[dofName] ?? 0;\n        portValues[`${portName}_torque`] = allTorques[dofName] ?? 0;\n      }\n\n      // Get current internal states\n      const internal: Record<string, number> = {};\n      for (const sn of component.stateNames) {\n        const fullName = `${compName}.${sn}`;\n        const idx = this.stateNames.indexOf(fullName);\n        internal[sn] = x[idx];\n      }\n\n      // Compute derivatives\n      const derivs = component.computeStateDerivatives(internal, portValues);\n\n      // Store in dx\n      const stateIdx = this.nMechanicalDofs + i;\n      dx[stateIdx] = derivs[stateName] ?? 0;\n    }\n\n    return dx;\n  }\n\n  private _addLoadTorque(\n    tau: number[],\n    speeds: Record<string, number>,\n    grade: number\n  ): void {\n    if (this.topology.outputComponent === null) {\n      return;\n    }\n\n    const outputComp = this.topology.outputComponent;\n    const outputPort = this.topology.outputPort!;\n    const outputDof = `${outputComp}.${outputPort}`;\n\n    // Get vehicle velocity from wheel speed\n    const component = this._components.get(outputComp)!;\n    const omega = speeds[outputDof] ?? 0;\n\n    // If this is a vehicle component, get load torque\n    if ('computeLoadTorque' in component) {\n      const tLoad = (component as any).computeLoadTorque(omega, grade);\n\n      // Find which independent DOF is affected\n      let found = false;\n      for (let i = 0; i < this._independentDofs.length; i++) {\n        if (this._independentDofs[i].name === outputDof) {\n          tau[i] -= tLoad;\n          found = true;\n          break;\n        }\n      }\n\n      if (!found) {\n        // Output is a constrained DOF - resolve to independent DOFs\n        const independentMap = new Map<string, DOFInfo>();\n        for (const dof of this._independentDofs) {\n          independentMap.set(dof.name, dof);\n        }\n        const resolved = this._resolveDof(\n          outputDof,\n          independentMap,\n          this._eliminatedDofs\n        );\n        for (const [indDof, coeff] of Object.entries(resolved)) {\n          for (let i = 0; i < this._independentDofs.length; i++) {\n            if (this._independentDofs[i].name === indDof) {\n              tau[i] -= coeff * tLoad;\n              break;\n            }\n          }\n        }\n      }\n    }\n  }\n\n  /** Get vehicle velocity from state vector. */\n  getVelocity(x: number[]): number {\n    if (this.topology.outputComponent === null) {\n      return 0;\n    }\n\n    const outputComp = this.topology.outputComponent;\n    const outputPort = this.topology.outputPort!;\n    const outputDof = `${outputComp}.${outputPort}`;\n\n    const speeds = this.getAllSpeeds(x);\n    const omega = speeds[outputDof] ?? 0;\n\n    // Convert wheel speed to velocity\n    const component = this._components.get(outputComp)!;\n    if ('wheelSpeedToVelocity' in component) {\n      return (component as any).wheelSpeedToVelocity(omega);\n    }\n\n    return omega;\n  }\n\n  toString(): string {\n    return `Drivetrain(dofs=${this.nMechanicalDofs}, states=${this.nInternalStates}, controls=${this.controlNames.length})`;\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 3446, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/core/topology.ts"],"sourcesContent":["/**\n * Drivetrain topology builder with fluent API.\n */\n\nimport { DrivetrainComponent } from './component';\nimport { Connection, PortType } from './ports';\n\n/**\n * Error in drivetrain topology configuration.\n */\nexport class TopologyError extends Error {\n  constructor(\n    message: string,\n    public component?: string,\n    public port?: string\n  ) {\n    const location = component\n      ? ` at component '${component}'${port ? `.${port}` : ''}`\n      : '';\n    super(`TopologyError${location}: ${message}`);\n    this.name = 'TopologyError';\n  }\n}\n\n/**\n * Builder for constructing drivetrain topologies.\n *\n * Use the fluent API to add components and connections, then call\n * build() to compile into a simulatable Drivetrain.\n *\n * Example:\n *   const topology = new DrivetrainTopology()\n *     .addComponent(\"engine\", new EngineComponent())\n *     .addComponent(\"gearbox\", new GearboxComponent())\n *     .addComponent(\"vehicle\", new VehicleComponent())\n *     .connect(\"engine\", \"shaft\", \"gearbox\", \"input\")\n *     .connect(\"gearbox\", \"output\", \"vehicle\", \"wheels\")\n *     .setOutput(\"vehicle\", \"wheels\");\n *   const drivetrain = topology.build();\n */\nexport class DrivetrainTopology {\n  readonly components: Map<string, DrivetrainComponent> = new Map();\n  readonly connections: Connection[] = [];\n  outputComponent: string | null = null;\n  outputPort: string | null = null;\n  private _electricalBuses: Map<string, Array<[string, string]>> = new Map();\n\n  /**\n   * Add a component to the topology.\n   *\n   * @param name - Unique identifier for this component\n   * @param component - The component instance\n   * @returns this for method chaining\n   */\n  addComponent(name: string, component: DrivetrainComponent): this {\n    if (this.components.has(name)) {\n      throw new TopologyError(`Component name '${name}' already exists`, name);\n    }\n\n    component.name = name;\n    this.components.set(name, component);\n    return this;\n  }\n\n  /**\n   * Connect two component ports.\n   *\n   * Creates a physical connection between ports. Both ports must be\n   * of the same type (both mechanical or both electrical).\n   */\n  connect(\n    fromComponent: string,\n    fromPort: string,\n    toComponent: string,\n    toPort: string\n  ): this {\n    // Validate components exist\n    if (!this.components.has(fromComponent)) {\n      throw new TopologyError(`Unknown component '${fromComponent}'`, fromComponent);\n    }\n    if (!this.components.has(toComponent)) {\n      throw new TopologyError(`Unknown component '${toComponent}'`, toComponent);\n    }\n\n    const fromComp = this.components.get(fromComponent)!;\n    const toComp = this.components.get(toComponent)!;\n\n    // Validate ports exist\n    if (!fromComp.hasPort(fromPort)) {\n      throw new TopologyError(\n        `No port '${fromPort}' on component`,\n        fromComponent,\n        fromPort\n      );\n    }\n    if (!toComp.hasPort(toPort)) {\n      throw new TopologyError(\n        `No port '${toPort}' on component`,\n        toComponent,\n        toPort\n      );\n    }\n\n    // Validate port types match\n    const fromPortObj = fromComp.getPort(fromPort)!;\n    const toPortObj = toComp.getPort(toPort)!;\n    if (fromPortObj.portType !== toPortObj.portType) {\n      throw new TopologyError(\n        `Port type mismatch: ${fromPortObj.portType} != ${toPortObj.portType}`,\n        fromComponent,\n        fromPort\n      );\n    }\n\n    // Check for duplicate connections\n    const conn: Connection = {\n      fromComponent,\n      fromPort,\n      toComponent,\n      toPort,\n    };\n\n    for (const existing of this.connections) {\n      if (\n        (existing.fromComponent === conn.fromComponent &&\n          existing.fromPort === conn.fromPort) ||\n        (existing.toComponent === conn.toComponent &&\n          existing.toPort === conn.toPort)\n      ) {\n        throw new TopologyError(\n          `Port already connected`,\n          fromComponent,\n          fromPort\n        );\n      }\n    }\n\n    this.connections.push(conn);\n    return this;\n  }\n\n  /**\n   * Set the output port (connected to vehicle/ground).\n   *\n   * The output port is where the drivetrain connects to the vehicle\n   * road load. This is typically the wheels port on the vehicle component.\n   */\n  setOutput(component: string, port: string): this {\n    if (!this.components.has(component)) {\n      throw new TopologyError(`Unknown component '${component}'`, component);\n    }\n\n    const comp = this.components.get(component)!;\n    if (!comp.hasPort(port)) {\n      throw new TopologyError(\n        `No port '${port}' on component`,\n        component,\n        port\n      );\n    }\n\n    this.outputComponent = component;\n    this.outputPort = port;\n    return this;\n  }\n\n  /**\n   * Create a named electrical bus for power sharing.\n   */\n  createElectricalBus(busName: string): this {\n    if (this._electricalBuses.has(busName)) {\n      throw new TopologyError(`Electrical bus '${busName}' already exists`);\n    }\n    this._electricalBuses.set(busName, []);\n    return this;\n  }\n\n  /**\n   * Connect a component's electrical port to a bus.\n   */\n  connectToBus(busName: string, component: string, port: string): this {\n    if (!this._electricalBuses.has(busName)) {\n      throw new TopologyError(`Unknown electrical bus '${busName}'`);\n    }\n\n    if (!this.components.has(component)) {\n      throw new TopologyError(`Unknown component '${component}'`, component);\n    }\n\n    const comp = this.components.get(component)!;\n    if (!comp.hasPort(port)) {\n      throw new TopologyError(\n        `No port '${port}' on component`,\n        component,\n        port\n      );\n    }\n\n    const portObj = comp.getPort(port)!;\n    if (portObj.portType !== PortType.ELECTRICAL) {\n      throw new TopologyError(\n        `Port '${port}' is not electrical`,\n        component,\n        port\n      );\n    }\n\n    this._electricalBuses.get(busName)!.push([component, port]);\n    return this;\n  }\n\n  /**\n   * Get all connections involving a component.\n   */\n  getConnectionsFor(component: string): Connection[] {\n    return this.connections.filter(\n      (c) => c.fromComponent === component || c.toComponent === component\n    );\n  }\n\n  /**\n   * Find what a port is connected to.\n   *\n   * @returns [component_name, port_name] or null if not connected\n   */\n  getConnectedPort(component: string, port: string): [string, string] | null {\n    for (const conn of this.connections) {\n      if (conn.fromComponent === component && conn.fromPort === port) {\n        return [conn.toComponent, conn.toPort];\n      }\n      if (conn.toComponent === component && conn.toPort === port) {\n        return [conn.fromComponent, conn.fromPort];\n      }\n    }\n    return null;\n  }\n\n  /**\n   * Validate the topology configuration.\n   *\n   * @returns List of validation error messages (empty if valid)\n   */\n  validate(): string[] {\n    const errors: string[] = [];\n\n    // Check that we have at least one component\n    if (this.components.size === 0) {\n      errors.push('Topology has no components');\n    }\n\n    // Validate each component\n    for (const [name, component] of this.components) {\n      const compErrors = component.validate();\n      for (const err of compErrors) {\n        errors.push(`Component '${name}': ${err}`);\n      }\n    }\n\n    // Check that output is set\n    if (this.outputComponent === null) {\n      errors.push('No output port set (use setOutput())');\n    }\n\n    // Check for disconnected components\n    const connectedComponents = new Set<string>();\n    for (const conn of this.connections) {\n      connectedComponents.add(conn.fromComponent);\n      connectedComponents.add(conn.toComponent);\n    }\n\n    for (const [name, component] of this.components) {\n      if (!connectedComponents.has(name) && this.components.size > 1) {\n        // Allow if component only has electrical ports\n        const mechPorts = component.getMechanicalPorts();\n        if (Object.keys(mechPorts).length > 0) {\n          errors.push(`Component '${name}' is not connected to anything`);\n        }\n      }\n    }\n\n    // Check electrical bus connections\n    for (const [busName, members] of this._electricalBuses) {\n      if (members.length < 2) {\n        errors.push(\n          `Electrical bus '${busName}' has fewer than 2 connections`\n        );\n      }\n    }\n\n    return errors;\n  }\n\n  /**\n   * Compile the topology into a simulatable Drivetrain.\n   */\n  build(): import('./drivetrain').Drivetrain {\n    const errors = this.validate();\n    if (errors.length > 0) {\n      throw new TopologyError('Invalid topology: ' + errors.join('; '));\n    }\n\n    // Dynamic import to avoid circular dependency\n    const { Drivetrain } = require('./drivetrain');\n    return new Drivetrain(this);\n  }\n\n  toString(): string {\n    const compNames = Array.from(this.components.keys());\n    return `DrivetrainTopology(components=[${compNames.join(', ')}], connections=${this.connections.length})`;\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 3667, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/core/index.ts"],"sourcesContent":["/**\n * Core module exports.\n */\n\nexport { DrivetrainComponent } from './component';\nexport type { PortValues } from './component';\n\nexport { PortType, PortDirection, mechanicalPort, electricalPort, canConnect } from './ports';\nexport type { Port, Connection } from './ports';\n\nexport {\n  GearRatioConstraint,\n  WillisConstraint,\n  RigidConnectionConstraint,\n} from './constraints';\nexport type { KinematicConstraint, SpeedRelation } from './constraints';\n\nexport { DrivetrainTopology, TopologyError } from './topology';\n\nexport { Drivetrain } from './drivetrain';\nexport type { DOFInfo, ConstraintInfo } from './drivetrain';\n"],"names":[],"mappings":"AAAA;;CAEC;AAED;AAGA;AAGA;AAOA;AAEA","debugId":null}},
    {"offset": {"line": 3684, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/math/interpolate.ts"],"sourcesContent":["/**\n * Interpolation utilities for drivetrain simulation.\n */\n\n/**\n * Linear interpolation.\n *\n * @param x - Value to interpolate at\n * @param xp - X coordinates of data points (must be increasing)\n * @param fp - Y coordinates of data points\n * @returns Interpolated value at x\n */\nexport function interp(x: number, xp: number[], fp: number[]): number {\n  if (xp.length !== fp.length || xp.length === 0) {\n    throw new Error('xp and fp must have the same non-zero length');\n  }\n\n  // Clamp to range\n  if (x <= xp[0]) {\n    return fp[0];\n  }\n  if (x >= xp[xp.length - 1]) {\n    return fp[fp.length - 1];\n  }\n\n  // Find interval\n  let i = 0;\n  while (i < xp.length - 1 && xp[i + 1] < x) {\n    i++;\n  }\n\n  // Linear interpolation\n  const x0 = xp[i];\n  const x1 = xp[i + 1];\n  const y0 = fp[i];\n  const y1 = fp[i + 1];\n\n  const t = (x - x0) / (x1 - x0);\n  return y0 + t * (y1 - y0);\n}\n\n/**\n * Bilinear interpolation for 2D lookup tables.\n *\n * @param x - First coordinate\n * @param y - Second coordinate\n * @param xp - X grid points\n * @param yp - Y grid points\n * @param zp - Z values at grid points (2D array)\n * @returns Interpolated value at (x, y)\n */\nexport function interp2d(\n  x: number,\n  y: number,\n  xp: number[],\n  yp: number[],\n  zp: number[][]\n): number {\n  // Clamp x\n  const xClamped = Math.max(xp[0], Math.min(x, xp[xp.length - 1]));\n  const yClamped = Math.max(yp[0], Math.min(y, yp[yp.length - 1]));\n\n  // Find x interval\n  let i = 0;\n  while (i < xp.length - 2 && xp[i + 1] < xClamped) {\n    i++;\n  }\n\n  // Find y interval\n  let j = 0;\n  while (j < yp.length - 2 && yp[j + 1] < yClamped) {\n    j++;\n  }\n\n  // Get corners\n  const x0 = xp[i];\n  const x1 = xp[i + 1];\n  const y0 = yp[j];\n  const y1 = yp[j + 1];\n\n  const z00 = zp[j][i];\n  const z01 = zp[j][i + 1];\n  const z10 = zp[j + 1][i];\n  const z11 = zp[j + 1][i + 1];\n\n  // Bilinear interpolation\n  const tx = (xClamped - x0) / (x1 - x0);\n  const ty = (yClamped - y0) / (y1 - y0);\n\n  const z0 = z00 + tx * (z01 - z00);\n  const z1 = z10 + tx * (z11 - z10);\n\n  return z0 + ty * (z1 - z0);\n}\n\n/**\n * Find the interval index for a value in a sorted array.\n *\n * @param x - Value to search for\n * @param xp - Sorted array\n * @returns Index i such that xp[i] <= x < xp[i+1], or boundary indices\n */\nexport function searchSorted(x: number, xp: number[]): number {\n  if (x <= xp[0]) return 0;\n  if (x >= xp[xp.length - 1]) return xp.length - 2;\n\n  let low = 0;\n  let high = xp.length - 1;\n\n  while (low < high - 1) {\n    const mid = Math.floor((low + high) / 2);\n    if (xp[mid] <= x) {\n      low = mid;\n    } else {\n      high = mid;\n    }\n  }\n\n  return low;\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 3774, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/components/engine.ts"],"sourcesContent":["/**\n * Engine component for drivetrain simulation.\n */\n\nimport { DrivetrainComponent, PortValues } from '../core/component';\nimport { Port, PortDirection, PortType } from '../core/ports';\nimport { KinematicConstraint } from '../core/constraints';\nimport { interp } from '../math/interpolate';\n\n/**\n * Engine parameters.\n */\nexport interface EngineParams {\n  /** Low idle speed [rpm] */\n  rpmIdle?: number;\n  /** Minimum operating speed [rpm] */\n  rpmMin?: number;\n  /** Maximum operating speed [rpm] */\n  rpmMax?: number;\n  /** Rated power [W] */\n  pRated?: number;\n  /** Speed at rated power [rpm] */\n  rpmRated?: number;\n  /** Peak torque [N*m] */\n  tPeak?: number;\n  /** Speed at peak torque [rpm] */\n  rpmPeakTorque?: number;\n  /** Rotational inertia [kg*m^2] */\n  jEngine?: number;\n  /** Brake-specific fuel consumption [kg/J] (default 200 g/kWh) */\n  bsfc?: number;\n  /** Torque curve: [[rpm, torque], ...] */\n  torqueCurve?: [number, number][];\n}\n\n/** Default CAT 3516E engine parameters */\nexport const CAT_3516E_PARAMS: EngineParams = {\n  rpmIdle: 700,\n  rpmMin: 700,\n  rpmMax: 1800,\n  pRated: 1_801_000,\n  rpmRated: 1650,\n  tPeak: 11_220,\n  rpmPeakTorque: 1200,\n  jEngine: 25,\n  bsfc: 200e-9, // 200 g/kWh in kg/J\n  torqueCurve: [\n    [700, 9_500],\n    [1000, 10_800],\n    [1200, 11_220],\n    [1400, 10_900],\n    [1650, 10_420],\n    [1800, 9_800],\n  ],\n};\n\n/**\n * Internal combustion engine component.\n *\n * Provides a single mechanical output shaft with torque determined by\n * a torque curve and commanded throttle/torque.\n */\nexport class EngineComponent extends DrivetrainComponent {\n  readonly params: Required<EngineParams>;\n  private _rpmPoints: number[];\n  private _torquePoints: number[];\n\n  constructor(params: EngineParams = {}, name: string = 'engine') {\n    super(name);\n\n    // Merge with defaults\n    this.params = {\n      rpmIdle: params.rpmIdle ?? 700,\n      rpmMin: params.rpmMin ?? 700,\n      rpmMax: params.rpmMax ?? 1800,\n      pRated: params.pRated ?? 1_801_000,\n      rpmRated: params.rpmRated ?? 1650,\n      tPeak: params.tPeak ?? 11_220,\n      rpmPeakTorque: params.rpmPeakTorque ?? 1200,\n      jEngine: params.jEngine ?? 25,\n      bsfc: params.bsfc ?? 200e-9,\n      torqueCurve: params.torqueCurve ?? [\n        [700, 9_500],\n        [1000, 10_800],\n        [1200, 11_220],\n        [1400, 10_900],\n        [1650, 10_420],\n        [1800, 9_800],\n      ],\n    };\n\n    // Build interpolation arrays\n    this._rpmPoints = this.params.torqueCurve.map(p => p[0]);\n    this._torquePoints = this.params.torqueCurve.map(p => p[1]);\n  }\n\n  get ports(): Record<string, Port> {\n    return {\n      shaft: {\n        name: 'shaft',\n        portType: PortType.MECHANICAL,\n        direction: PortDirection.OUTPUT,\n        description: 'Engine crankshaft output',\n      },\n    };\n  }\n\n  get stateNames(): string[] {\n    // Engine has no internal states in this model\n    return [];\n  }\n\n  getInertia(portName: string): number {\n    if (portName === 'shaft') {\n      return this.params.jEngine;\n    }\n    throw new Error(`Unknown port: ${portName}`);\n  }\n\n  getConstraints(): KinematicConstraint[] {\n    // Engine has no internal kinematic constraints\n    return [];\n  }\n\n  /**\n   * Get maximum available torque at given engine speed.\n   *\n   * Returns 0 below idle, interpolates curve in normal range,\n   * and linearly tapers to 0 above max RPM.\n   */\n  getMaxTorque(rpm: number): number {\n    if (rpm < this.params.rpmMin) {\n      return 0;\n    }\n    if (rpm <= this.params.rpmMax) {\n      return interp(rpm, this._rpmPoints, this._torquePoints);\n    }\n    // Above max RPM: linearly taper torque to zero over 200 RPM\n    const tAtMax = interp(this.params.rpmMax, this._rpmPoints, this._torquePoints);\n    const overspeedMargin = 200;\n    const taperFactor = Math.max(0, 1 - (rpm - this.params.rpmMax) / overspeedMargin);\n    return tAtMax * taperFactor;\n  }\n\n  /**\n   * Get maximum torque at given angular velocity [rad/s].\n   */\n  getMaxTorqueRads(omega: number): number {\n    const rpm = (omega * 30) / Math.PI;\n    return this.getMaxTorque(rpm);\n  }\n\n  /**\n   * Clip torque command to valid range.\n   */\n  clipTorque(rpm: number, torqueCmd: number): number {\n    const tMax = this.getMaxTorque(rpm);\n    return Math.max(0, Math.min(torqueCmd, tMax));\n  }\n\n  /**\n   * Get fuel consumption rate [kg/s].\n   */\n  getFuelRate(torque: number, omega: number): number {\n    if (torque <= 0 || omega <= 0) {\n      return 0;\n    }\n    const power = torque * omega;\n    return power * this.params.bsfc;\n  }\n\n  /**\n   * Check if operating point is within valid envelope.\n   */\n  isValidOperatingPoint(rpm: number, torque: number): boolean {\n    if (rpm < this.params.rpmMin || rpm > this.params.rpmMax) {\n      return false;\n    }\n    const tMax = this.getMaxTorque(rpm);\n    return torque >= 0 && torque <= tMax;\n  }\n\n  computeTorques(\n    portSpeeds: Record<string, number>,\n    controlInputs: Record<string, number>,\n    _internalStates?: Record<string, number>\n  ): Record<string, number> {\n    const omega = Math.abs(portSpeeds.shaft ?? 0);\n    const rpm = (omega * 30) / Math.PI;\n\n    // Get torque command\n    const torqueCmd = controlInputs.torque ?? 0;\n\n    // Clip to available torque\n    const torque = this.clipTorque(rpm, torqueCmd);\n\n    return { shaft: torque };\n  }\n\n  computeStateDerivatives(\n    _internalStates: Record<string, number>,\n    _portValues: PortValues\n  ): Record<string, number> {\n    // No internal states\n    return {};\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 3965, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/components/motor.ts"],"sourcesContent":["/**\n * Electric motor/generator component for drivetrain simulation.\n */\n\nimport { DrivetrainComponent, PortValues } from '../core/component';\nimport { Port, PortDirection, PortType } from '../core/ports';\nimport { KinematicConstraint } from '../core/constraints';\n\n/**\n * Motor parameters.\n */\nexport interface MotorParams {\n  /** Maximum continuous power [W] */\n  pMax?: number;\n  /** Boost power [W] for short duration */\n  pBoost?: number;\n  /** Maximum torque [N*m] */\n  tMax?: number;\n  /** Maximum speed [rpm] */\n  rpmMax?: number;\n  /** Base speed [rpm] (computed if not provided) */\n  rpmBase?: number;\n  /** Rotor inertia [kg*m^2] */\n  jRotor?: number;\n  /** Efficiency (0-1) for both motoring and generating */\n  eta?: number;\n}\n\n/** MG1 motor parameters for CAT 793D */\nexport const MG1_PARAMS: MotorParams = {\n  pMax: 200_000, // 200 kW\n  tMax: 3_000, // 3,000 N*m\n  rpmMax: 6_000,\n  jRotor: 2.0,\n  eta: 0.92,\n};\n\n/** MG2 motor parameters for CAT 793D */\nexport const MG2_PARAMS: MotorParams = {\n  pMax: 350_000, // 350 kW continuous\n  pBoost: 500_000, // 500 kW boost\n  tMax: 2_000, // 2,000 N*m\n  rpmMax: 4_000,\n  jRotor: 4.0,\n  eta: 0.92,\n};\n\n/**\n * Electric motor/generator component.\n *\n * Operates in two regions:\n * - Constant torque (0 to base speed): T = T_max\n * - Constant power (base speed to max speed): T = P_max / ω\n *\n * Can operate in all four quadrants (motoring/generating in both directions).\n */\nexport class MotorComponent extends DrivetrainComponent {\n  readonly params: Required<Omit<MotorParams, 'pBoost'>> & { pBoost: number | null };\n  private _omegaBase: number;\n  private _omegaMax: number;\n\n  constructor(params: MotorParams = {}, name: string = 'motor') {\n    super(name);\n\n    const pMax = params.pMax ?? 200_000;\n    const tMax = params.tMax ?? 3_000;\n\n    // Compute base speed if not provided: P_max / T_max (in rad/s)\n    const computedRpmBase = (pMax / tMax) * (30 / Math.PI);\n\n    this.params = {\n      pMax,\n      pBoost: params.pBoost ?? null,\n      tMax,\n      rpmMax: params.rpmMax ?? 6_000,\n      rpmBase: params.rpmBase ?? computedRpmBase,\n      jRotor: params.jRotor ?? 2.0,\n      eta: params.eta ?? 0.92,\n    };\n\n    this._omegaBase = this.params.rpmBase * Math.PI / 30;\n    this._omegaMax = this.params.rpmMax * Math.PI / 30;\n  }\n\n  get ports(): Record<string, Port> {\n    return {\n      shaft: {\n        name: 'shaft',\n        portType: PortType.MECHANICAL,\n        direction: PortDirection.BIDIRECTIONAL,\n        description: 'Motor/generator shaft',\n      },\n      electrical: {\n        name: 'electrical',\n        portType: PortType.ELECTRICAL,\n        direction: PortDirection.BIDIRECTIONAL,\n        description: 'Electrical power connection',\n      },\n    };\n  }\n\n  get stateNames(): string[] {\n    return [];\n  }\n\n  getInertia(portName: string): number {\n    if (portName === 'shaft') {\n      return this.params.jRotor;\n    }\n    if (portName === 'electrical') {\n      return 0; // Electrical port has no inertia\n    }\n    throw new Error(`Unknown port: ${portName}`);\n  }\n\n  getConstraints(): KinematicConstraint[] {\n    return [];\n  }\n\n  /**\n   * Get maximum available torque at given speed.\n   *\n   * @param rpm - Motor speed [rpm] (absolute value used)\n   * @param useBoost - If true, use boost power in constant power region\n   * @returns Maximum torque [N*m]\n   */\n  getMaxTorque(rpm: number, useBoost: boolean = false): number {\n    rpm = Math.abs(rpm);\n    if (rpm > this.params.rpmMax) {\n      return 0;\n    }\n\n    const omega = rpm * Math.PI / 30;\n    const pMax = (useBoost && this.params.pBoost) ? this.params.pBoost : this.params.pMax;\n\n    if (rpm <= this.params.rpmBase) {\n      // Constant torque region\n      return this.params.tMax;\n    } else {\n      // Constant power region: T = P / ω\n      if (omega > 0) {\n        return Math.min(pMax / omega, this.params.tMax);\n      }\n      return this.params.tMax;\n    }\n  }\n\n  /**\n   * Get maximum torque at given angular velocity.\n   */\n  getMaxTorqueRads(omega: number, useBoost: boolean = false): number {\n    const rpm = Math.abs(omega) * 30 / Math.PI;\n    return this.getMaxTorque(rpm, useBoost);\n  }\n\n  /**\n   * Get torque limits for 4-quadrant operation.\n   *\n   * @returns Tuple of [T_min, T_max] [N*m]\n   */\n  getTorqueLimits(rpm: number, useBoost: boolean = false): [number, number] {\n    const tMax = this.getMaxTorque(rpm, useBoost);\n    return [-tMax, tMax];\n  }\n\n  /**\n   * Clip torque command to valid range.\n   */\n  clipTorque(rpm: number, torqueCmd: number, useBoost: boolean = false): number {\n    const [tMin, tMax] = this.getTorqueLimits(rpm, useBoost);\n    return Math.max(tMin, Math.min(torqueCmd, tMax));\n  }\n\n  /**\n   * Calculate electrical power consumed/generated.\n   *\n   * Sign convention:\n   * - Positive power: consuming from battery (motoring)\n   * - Negative power: supplying to battery (generating)\n   */\n  getElectricalPower(torque: number, omega: number): number {\n    const pMech = torque * omega;\n\n    if (pMech > 0) {\n      // Motoring: electrical power = mechanical / efficiency\n      return pMech / this.params.eta;\n    } else {\n      // Generating: electrical power = mechanical * efficiency\n      return pMech * this.params.eta;\n    }\n  }\n\n  /**\n   * Check if operating point is within motor envelope.\n   */\n  isValidOperatingPoint(rpm: number, torque: number): boolean {\n    const [tMin, tMax] = this.getTorqueLimits(rpm);\n    return torque >= tMin && torque <= tMax;\n  }\n\n  computeTorques(\n    portSpeeds: Record<string, number>,\n    controlInputs: Record<string, number>,\n    _internalStates?: Record<string, number>\n  ): Record<string, number> {\n    const omega = portSpeeds.shaft ?? 0;\n    const rpm = Math.abs(omega) * 30 / Math.PI;\n    const torqueCmd = controlInputs.torque ?? 0;\n    const useBoost = Boolean(controlInputs.boost);\n\n    // Clip to valid operating range\n    const torque = this.clipTorque(rpm, torqueCmd, useBoost);\n\n    return { shaft: torque };\n  }\n\n  computeStateDerivatives(\n    _internalStates: Record<string, number>,\n    _portValues: PortValues\n  ): Record<string, number> {\n    return {};\n  }\n}\n\n/** Create MG1 motor with CAT 793D parameters. */\nexport function createMG1(): MotorComponent {\n  return new MotorComponent(MG1_PARAMS, 'MG1');\n}\n\n/** Create MG2 motor with CAT 793D parameters. */\nexport function createMG2(): MotorComponent {\n  return new MotorComponent(MG2_PARAMS, 'MG2');\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 4145, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/components/gearbox.ts"],"sourcesContent":["/**\n * N-speed gearbox component for drivetrain simulation.\n */\n\nimport { DrivetrainComponent, PortValues } from '../core/component';\nimport { Port, PortDirection, PortType } from '../core/ports';\nimport { GearRatioConstraint, KinematicConstraint } from '../core/constraints';\n\n/**\n * Gearbox parameters.\n */\nexport interface GearboxParams {\n  /** List of gear ratios [K1, K2, ..., Kn] where K = omega_in / omega_out */\n  ratios?: number[];\n  /** Efficiency for each gear (same length as ratios) */\n  efficiencies?: number[];\n  /** Input shaft inertia [kg*m^2] */\n  jInput?: number;\n  /** Output shaft inertia [kg*m^2] */\n  jOutput?: number;\n  /** Time to complete a gear shift [s] */\n  shiftTime?: number;\n}\n\n/** CAT 793D eCVT 2-speed */\nexport const ECVT_GEARBOX_PARAMS: GearboxParams = {\n  ratios: [5.0, 0.67], // Low and overdrive\n  efficiencies: [0.97, 0.97],\n  jInput: 5.0,\n  jOutput: 5.0,\n};\n\n/** Typical 7-speed automatic for conventional diesel */\nexport const DIESEL_7SPEED_PARAMS: GearboxParams = {\n  ratios: [4.59, 2.95, 1.94, 1.40, 1.0, 0.74, 0.65],\n  efficiencies: [0.97, 0.97, 0.97, 0.97, 0.97, 0.97, 0.97],\n  jInput: 5.0,\n  jOutput: 5.0,\n};\n\n/** Single-speed reduction for EVs */\nexport const SINGLE_SPEED_PARAMS: GearboxParams = {\n  ratios: [10.0],\n  efficiencies: [0.98],\n  jInput: 2.0,\n  jOutput: 5.0,\n};\n\n/**\n * N-speed discrete gearbox component.\n *\n * Converts between input and output shafts with selectable gear ratios.\n * Speed: omega_out = omega_in / K\n * Torque: T_out = T_in * K * eta\n */\nexport class NSpeedGearboxComponent extends DrivetrainComponent {\n  readonly params: Required<GearboxParams>;\n  private _currentGear: number;\n\n  constructor(params: GearboxParams = {}, name: string = 'gearbox') {\n    super(name);\n\n    const ratios = params.ratios ?? [3.5, 2.0, 1.0];\n    const efficiencies = params.efficiencies ?? ratios.map(() => 0.97);\n\n    // Ensure efficiencies list matches ratios\n    const finalEfficiencies = efficiencies.length === ratios.length\n      ? efficiencies\n      : ratios.map(() => 0.97);\n\n    this.params = {\n      ratios,\n      efficiencies: finalEfficiencies,\n      jInput: params.jInput ?? 5.0,\n      jOutput: params.jOutput ?? 5.0,\n      shiftTime: params.shiftTime ?? 0.5,\n    };\n\n    this._currentGear = 0;\n  }\n\n  get nGears(): number {\n    return this.params.ratios.length;\n  }\n\n  get gear(): number {\n    return this._currentGear;\n  }\n\n  set gear(value: number) {\n    this._currentGear = Math.max(0, Math.min(value, this.nGears - 1));\n  }\n\n  get currentRatio(): number {\n    return this.params.ratios[this._currentGear];\n  }\n\n  get currentEfficiency(): number {\n    return this.params.efficiencies[this._currentGear];\n  }\n\n  get ports(): Record<string, Port> {\n    return {\n      input: {\n        name: 'input',\n        portType: PortType.MECHANICAL,\n        direction: PortDirection.INPUT,\n        description: 'High-speed input shaft',\n      },\n      output: {\n        name: 'output',\n        portType: PortType.MECHANICAL,\n        direction: PortDirection.OUTPUT,\n        description: 'Low-speed output shaft',\n      },\n    };\n  }\n\n  get stateNames(): string[] {\n    return [];\n  }\n\n  getInertia(portName: string): number {\n    if (portName === 'input') {\n      return this.params.jInput;\n    }\n    if (portName === 'output') {\n      return this.params.jOutput;\n    }\n    throw new Error(`Unknown port: ${portName}`);\n  }\n\n  getConstraints(): KinematicConstraint[] {\n    return [\n      new GearRatioConstraint({\n        inputPort: 'input',\n        outputPort: 'output',\n        ratio: this.currentRatio,\n        efficiency: this.currentEfficiency,\n      }),\n    ];\n  }\n\n  /**\n   * Get gear ratio for specified gear.\n   */\n  getRatio(gear?: number): number {\n    const g = gear ?? this._currentGear;\n    return this.params.ratios[Math.max(0, Math.min(g, this.nGears - 1))];\n  }\n\n  /**\n   * Get efficiency for specified gear.\n   */\n  getEfficiency(gear?: number): number {\n    const g = gear ?? this._currentGear;\n    return this.params.efficiencies[Math.max(0, Math.min(g, this.nGears - 1))];\n  }\n\n  /**\n   * Convert input speed to output speed.\n   */\n  inputToOutputSpeed(omegaIn: number, gear?: number): number {\n    return omegaIn / this.getRatio(gear);\n  }\n\n  /**\n   * Convert output speed to input speed.\n   */\n  outputToInputSpeed(omegaOut: number, gear?: number): number {\n    return omegaOut * this.getRatio(gear);\n  }\n\n  /**\n   * Convert input torque to output torque.\n   */\n  inputToOutputTorque(tIn: number, gear?: number): number {\n    const K = this.getRatio(gear);\n    const eta = this.getEfficiency(gear);\n    return tIn * K * eta;\n  }\n\n  /**\n   * Convert output torque to input torque.\n   */\n  outputToInputTorque(tOut: number, gear?: number): number {\n    const K = this.getRatio(gear);\n    const eta = this.getEfficiency(gear);\n    return tOut / (K * eta);\n  }\n\n  /**\n   * Calculate inertia reflected to input side.\n   */\n  getReflectedInertia(jOutput: number, gear?: number): number {\n    const K = this.getRatio(gear);\n    return jOutput / (K * K);\n  }\n\n  computeTorques(\n    _portSpeeds: Record<string, number>,\n    controlInputs: Record<string, number>,\n    _internalStates?: Record<string, number>\n  ): Record<string, number> {\n    // Update gear selection from control\n    if ('gear' in controlInputs) {\n      this.gear = Math.floor(controlInputs.gear);\n    }\n\n    // Gearbox itself doesn't produce torque, it transforms it\n    return {};\n  }\n\n  computeStateDerivatives(\n    _internalStates: Record<string, number>,\n    _portValues: PortValues\n  ): Record<string, number> {\n    return {};\n  }\n}\n\n/**\n * Final drive (fixed-ratio) component.\n */\nexport class FinalDriveComponent extends NSpeedGearboxComponent {\n  constructor(\n    ratio: number = 16.0,\n    efficiency: number = 0.96,\n    name: string = 'final_drive'\n  ) {\n    super(\n      {\n        ratios: [ratio],\n        efficiencies: [efficiency],\n        jInput: 2.0,\n        jOutput: 10.0,\n      },\n      name\n    );\n  }\n\n  get ratio(): number {\n    return this.params.ratios[0];\n  }\n}\n\n/**\n * Fixed-ratio gear component with configurable inertias.\n *\n * Use for modeling fixed ratio gear sets like:\n * - Locked planetary gear (sun or ring brake engaged)\n * - Simple reduction/overdrive stages\n * - Transfer cases\n */\nexport class FixedRatioGearComponent extends NSpeedGearboxComponent {\n  constructor(\n    ratio: number = 1.0,\n    efficiency: number = 0.98,\n    jInput: number = 1.0,\n    jOutput: number = 1.0,\n    name: string = 'gear'\n  ) {\n    super(\n      {\n        ratios: [ratio],\n        efficiencies: [efficiency],\n        jInput,\n        jOutput,\n      },\n      name\n    );\n  }\n\n  get ratio(): number {\n    return this.params.ratios[0];\n  }\n\n  get efficiency(): number {\n    return this.params.efficiencies[0];\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 4381, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/components/planetary.ts"],"sourcesContent":["/**\n * Planetary gear component for power-split drivetrains.\n */\n\nimport { DrivetrainComponent, PortValues } from '../core/component';\nimport { Port, PortDirection, PortType } from '../core/ports';\nimport { KinematicConstraint, WillisConstraint } from '../core/constraints';\n\n/**\n * Planetary gear set parameters.\n */\nexport interface PlanetaryGearParams {\n  /** Number of teeth on sun gear */\n  zSun?: number;\n  /** Number of teeth on ring gear */\n  zRing?: number;\n  /** Sun gear inertia [kg*m^2] */\n  jSun?: number;\n  /** Carrier inertia [kg*m^2] */\n  jCarrier?: number;\n  /** Ring gear inertia [kg*m^2] */\n  jRing?: number;\n  /** Efficiency (mesh losses) */\n  eta?: number;\n}\n\n/** CAT 793D planetary gear (ρ = 3.0) */\nexport const CAT_793D_PLANETARY_PARAMS: PlanetaryGearParams = {\n  zSun: 30,\n  zRing: 90,\n  jSun: 0.5,\n  jCarrier: 1.0,\n  jRing: 0.5,\n};\n\n/**\n * Planetary gear set implementing Willis equation.\n *\n * A planetary gear set has three rotating members:\n * - Sun gear: Center gear, typically connected to MG1\n * - Carrier: Holds planet gears, typically connected to engine\n * - Ring gear: Outer ring, typically connected to output/MG2\n *\n * Willis equation: ω_sun = (1 + ρ) × ω_carrier - ρ × ω_ring\n *\n * Torque balance: τ_sun : τ_carrier : τ_ring = 1 : -(1+ρ) : ρ\n */\nexport class PlanetaryGearComponent extends DrivetrainComponent {\n  readonly params: Required<PlanetaryGearParams>;\n  private _rho: number;\n\n  constructor(params: PlanetaryGearParams = {}, name: string = 'planetary') {\n    super(name);\n\n    this.params = {\n      zSun: params.zSun ?? 30,\n      zRing: params.zRing ?? 90,\n      jSun: params.jSun ?? 0.5,\n      jCarrier: params.jCarrier ?? 1.0,\n      jRing: params.jRing ?? 0.5,\n      eta: params.eta ?? 0.98,\n    };\n\n    this._rho = this.params.zRing / this.params.zSun;\n  }\n\n  /** Planetary ratio ρ = Z_ring / Z_sun. */\n  get rho(): number {\n    return this._rho;\n  }\n\n  get ports(): Record<string, Port> {\n    return {\n      sun: {\n        name: 'sun',\n        portType: PortType.MECHANICAL,\n        direction: PortDirection.BIDIRECTIONAL,\n        description: 'Sun gear (typically MG1)',\n      },\n      carrier: {\n        name: 'carrier',\n        portType: PortType.MECHANICAL,\n        direction: PortDirection.BIDIRECTIONAL,\n        description: 'Carrier (typically engine)',\n      },\n      ring: {\n        name: 'ring',\n        portType: PortType.MECHANICAL,\n        direction: PortDirection.BIDIRECTIONAL,\n        description: 'Ring gear (typically output)',\n      },\n    };\n  }\n\n  get stateNames(): string[] {\n    return [];\n  }\n\n  getInertia(portName: string): number {\n    if (portName === 'sun') {\n      return this.params.jSun;\n    }\n    if (portName === 'carrier') {\n      return this.params.jCarrier;\n    }\n    if (portName === 'ring') {\n      return this.params.jRing;\n    }\n    throw new Error(`Unknown port: ${portName}`);\n  }\n\n  getConstraints(): KinematicConstraint[] {\n    return [\n      new WillisConstraint({\n        sunPort: 'sun',\n        carrierPort: 'carrier',\n        ringPort: 'ring',\n        rho: this._rho,\n      }),\n    ];\n  }\n\n  /**\n   * Calculate sun gear speed from Willis equation.\n   *\n   * ω_sun = (1 + ρ) × ω_carrier - ρ × ω_ring\n   */\n  calcSunSpeed(omegaCarrier: number, omegaRing: number): number {\n    return (1 + this._rho) * omegaCarrier - this._rho * omegaRing;\n  }\n\n  /**\n   * Calculate carrier speed from sun and ring speeds.\n   */\n  calcCarrierSpeed(omegaSun: number, omegaRing: number): number {\n    return (omegaSun + this._rho * omegaRing) / (1 + this._rho);\n  }\n\n  /**\n   * Calculate ring speed from carrier and sun speeds.\n   */\n  calcRingSpeed(omegaCarrier: number, omegaSun: number): number {\n    return ((1 + this._rho) * omegaCarrier - omegaSun) / this._rho;\n  }\n\n  /**\n   * Get torque balance ratios (sun : carrier : ring).\n   *\n   * For a planetary gear in static equilibrium:\n   * τ_sun + τ_carrier + τ_ring = 0\n   */\n  getTorqueRatios(): [number, number, number] {\n    return [1.0, -(1 + this._rho), this._rho];\n  }\n\n  /**\n   * Calculate sun and ring torques from carrier torque.\n   *\n   * Based on torque ratios 1 : -(1+ρ) : ρ\n   */\n  calcTorqueSplit(tCarrier: number): [number, number] {\n    // From T_carrier and ratio τ_carrier = -(1+ρ)\n    const tSun = -tCarrier / (1 + this._rho);\n    const tRing = tSun * this._rho;\n    return [tSun, tRing];\n  }\n\n  /**\n   * Get inertia coupling coefficients for 2-DOF reduction.\n   *\n   * When reducing from 3-DOF to 2-DOF using Willis constraint:\n   *\n   * J = [J_c + (1+ρ)² × J_s,     -(1+ρ)×ρ × J_s    ]\n   *     [-(1+ρ)×ρ × J_s,          J_r + ρ² × J_s    ]\n   *\n   * @param jSun - Sun gear inertia (including attached motor)\n   * @returns [J_carrier_add, J_coupling, J_ring_add]\n   */\n  getInertiaCoefficients(jSun: number): [number, number, number] {\n    const jCarrierAdd = (1 + this._rho) ** 2 * jSun;\n    const jCoupling = -(1 + this._rho) * this._rho * jSun;\n    const jRingAdd = this._rho ** 2 * jSun;\n    return [jCarrierAdd, jCoupling, jRingAdd];\n  }\n\n  computeTorques(\n    _portSpeeds: Record<string, number>,\n    _controlInputs: Record<string, number>,\n    _internalStates?: Record<string, number>\n  ): Record<string, number> {\n    // Planetary gear doesn't generate torque, it distributes it\n    return {};\n  }\n\n  computeStateDerivatives(\n    _internalStates: Record<string, number>,\n    _portValues: PortValues\n  ): Record<string, number> {\n    return {};\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 4541, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/components/battery.ts"],"sourcesContent":["/**\n * Battery component for hybrid and electric drivetrains.\n */\n\nimport { DrivetrainComponent, PortValues } from '../core/component';\nimport { Port, PortDirection, PortType } from '../core/ports';\nimport { KinematicConstraint } from '../core/constraints';\n\n/**\n * Battery parameters.\n */\nexport interface BatteryParams {\n  /** Energy capacity [kWh] */\n  capacityKwh?: number;\n  /** Open circuit voltage [V] */\n  vOc?: number;\n  /** Nominal voltage [V] */\n  vNom?: number;\n  /** Internal resistance [Ω] */\n  rInt?: number;\n  /** Maximum discharge power [W] */\n  pMaxDischarge?: number;\n  /** Maximum charge power [W] */\n  pMaxCharge?: number;\n  /** Minimum operating SOC */\n  socMin?: number;\n  /** Maximum operating SOC */\n  socMax?: number;\n  /** Initial SOC */\n  socInit?: number;\n}\n\n/** CAT 793D battery parameters */\nexport const CAT_793D_BATTERY_PARAMS: BatteryParams = {\n  capacityKwh: 200.0,\n  vOc: 750.0,\n  vNom: 700.0,\n  rInt: 0.05,\n  pMaxDischarge: 1_000_000.0,\n  pMaxCharge: 500_000.0,\n  socMin: 0.3,\n  socMax: 0.8,\n  socInit: 0.6,\n};\n\n/** Larger battery for series hybrid */\nexport const SERIES_HYBRID_BATTERY_PARAMS: BatteryParams = {\n  capacityKwh: 400.0,\n  vOc: 750.0,\n  vNom: 700.0,\n  rInt: 0.03,\n  pMaxDischarge: 1_500_000.0,\n  pMaxCharge: 800_000.0,\n  socMin: 0.2,\n  socMax: 0.9,\n  socInit: 0.6,\n};\n\n/** Large battery for pure EV */\nexport const EV_BATTERY_PARAMS: BatteryParams = {\n  capacityKwh: 600.0,\n  vOc: 800.0,\n  vNom: 750.0,\n  rInt: 0.02,\n  pMaxDischarge: 2_000_000.0,\n  pMaxCharge: 1_000_000.0,\n  socMin: 0.1,\n  socMax: 0.95,\n  socInit: 0.8,\n};\n\n/**\n * Battery energy storage component.\n *\n * Uses simple equivalent circuit model:\n * V_terminal = V_oc - I × R_int\n *\n * Power limits are derated near SOC boundaries to protect the battery.\n */\nexport class BatteryComponent extends DrivetrainComponent {\n  readonly params: Required<BatteryParams>;\n  private _soc: number;\n\n  constructor(params: BatteryParams = {}, name: string = 'battery') {\n    super(name);\n\n    this.params = {\n      capacityKwh: params.capacityKwh ?? 200.0,\n      vOc: params.vOc ?? 750.0,\n      vNom: params.vNom ?? 700.0,\n      rInt: params.rInt ?? 0.05,\n      pMaxDischarge: params.pMaxDischarge ?? 1_000_000.0,\n      pMaxCharge: params.pMaxCharge ?? 500_000.0,\n      socMin: params.socMin ?? 0.3,\n      socMax: params.socMax ?? 0.8,\n      socInit: params.socInit ?? 0.6,\n    };\n\n    this._soc = this.params.socInit;\n  }\n\n  /** Capacity in Joules. */\n  get qCapacity(): number {\n    return this.params.capacityKwh * 3600 * 1000;\n  }\n\n  /** Capacity in Amp-hours. */\n  get qAh(): number {\n    return this.qCapacity / (this.params.vNom * 3600);\n  }\n\n  /** Current state of charge [0-1]. */\n  get soc(): number {\n    return this._soc;\n  }\n\n  set soc(value: number) {\n    this._soc = Math.max(0, Math.min(1, value));\n  }\n\n  get ports(): Record<string, Port> {\n    return {\n      electrical: {\n        name: 'electrical',\n        portType: PortType.ELECTRICAL,\n        direction: PortDirection.BIDIRECTIONAL,\n        description: 'Electrical power connection',\n      },\n    };\n  }\n\n  get stateNames(): string[] {\n    return ['SOC'];\n  }\n\n  getInertia(_portName: string): number {\n    return 0; // Battery has no mechanical inertia\n  }\n\n  getConstraints(): KinematicConstraint[] {\n    return [];\n  }\n\n  /**\n   * Get open circuit voltage (could be SOC-dependent).\n   */\n  getOpenCircuitVoltage(_soc?: number): number {\n    // Simple model: constant V_oc\n    return this.params.vOc;\n  }\n\n  /**\n   * Calculate current from power demand.\n   *\n   * Solves: P = V_oc × I - R_int × I²\n   *\n   * @param power - Electrical power [W] (positive = discharge)\n   * @returns Current [A] (positive = discharge)\n   */\n  getCurrentFromPower(power: number, soc?: number): number {\n    const currentSoc = soc ?? this._soc;\n    const vOc = this.getOpenCircuitVoltage(currentSoc);\n    const R = this.params.rInt;\n\n    if (Math.abs(power) < 1e-6) {\n      return 0;\n    }\n\n    // Quadratic: R × I² - V_oc × I + P = 0\n    // I = (V_oc - sqrt(V_oc² - 4RP)) / (2R)\n    const discriminant = vOc * vOc - 4 * R * power;\n\n    if (discriminant < 0) {\n      // Power exceeds capability - return limiting current\n      return power > 0 ? vOc / (2 * R) : -vOc / (2 * R);\n    }\n\n    // Use solution that gives smaller magnitude current\n    return (vOc - Math.sqrt(discriminant)) / (2 * R);\n  }\n\n  /**\n   * Get terminal voltage at given current.\n   */\n  getTerminalVoltage(current: number, soc?: number): number {\n    const currentSoc = soc ?? this._soc;\n    const vOc = this.getOpenCircuitVoltage(currentSoc);\n    return vOc - current * this.params.rInt;\n  }\n\n  /**\n   * Get power limits with SOC-based derating.\n   *\n   * @returns [P_min, P_max] [W]\n   *   P_min is negative (max charging), P_max is positive (max discharging)\n   */\n  getPowerLimits(soc?: number): [number, number] {\n    const currentSoc = soc ?? this._soc;\n\n    let pDischarge = this.params.pMaxDischarge;\n    let pCharge = this.params.pMaxCharge;\n\n    // Derate discharge at low SOC\n    if (currentSoc < this.params.socMin + 0.1) {\n      const factor = Math.max(0, (currentSoc - this.params.socMin) / 0.1);\n      pDischarge *= factor;\n    }\n\n    // Derate charge at high SOC\n    if (currentSoc > this.params.socMax - 0.1) {\n      const factor = Math.max(0, (this.params.socMax - currentSoc) / 0.1);\n      pCharge *= factor;\n    }\n\n    return [-pCharge, pDischarge];\n  }\n\n  /**\n   * Clip power to valid range.\n   */\n  clipPower(power: number, soc?: number): number {\n    const [pMin, pMax] = this.getPowerLimits(soc);\n    return Math.max(pMin, Math.min(power, pMax));\n  }\n\n  /**\n   * Calculate SOC rate of change.\n   *\n   * dSOC/dt = -I / Q_capacity\n   */\n  getSocDerivative(power: number, soc?: number): number {\n    const currentSoc = soc ?? this._soc;\n    const current = this.getCurrentFromPower(power, currentSoc);\n    // Q_capacity is in Coulombs (A·s)\n    const Q = this.qCapacity / this.params.vNom;\n    return -current / Q;\n  }\n\n  /**\n   * Check if battery can provide requested power.\n   */\n  canProvidePower(power: number, soc?: number): boolean {\n    const [pMin, pMax] = this.getPowerLimits(soc);\n    return power >= pMin && power <= pMax;\n  }\n\n  /**\n   * Get remaining usable energy [J].\n   */\n  getEnergyRemaining(soc?: number): number {\n    const currentSoc = soc ?? this._soc;\n    const usableSoc = Math.max(0, currentSoc - this.params.socMin);\n    return usableSoc * this.qCapacity;\n  }\n\n  computeTorques(\n    _portSpeeds: Record<string, number>,\n    _controlInputs: Record<string, number>,\n    _internalStates?: Record<string, number>\n  ): Record<string, number> {\n    return {}; // Battery doesn't produce torque\n  }\n\n  computeStateDerivatives(\n    internalStates: Record<string, number>,\n    portValues: PortValues\n  ): Record<string, number> {\n    const soc = internalStates.SOC ?? this._soc;\n    const power = portValues.electrical_power ?? 0;\n\n    const dSoc = this.getSocDerivative(power, soc);\n    return { SOC: dSoc };\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 4748, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/components/vehicle.ts"],"sourcesContent":["/**\n * Vehicle component with road load model.\n */\n\nimport { DrivetrainComponent, PortValues } from '../core/component';\nimport { Port, PortDirection, PortType } from '../core/ports';\nimport { KinematicConstraint } from '../core/constraints';\n\n/**\n * Vehicle parameters.\n */\nexport interface VehicleParams {\n  /** Empty mass [kg] */\n  mEmpty?: number;\n  /** Payload capacity [kg] */\n  mPayload?: number;\n  /** Wheel radius [m] */\n  rWheel?: number;\n  /** Frontal area [m^2] */\n  aFrontal?: number;\n  /** Drag coefficient */\n  cD?: number;\n  /** Rolling resistance coefficient */\n  cR?: number;\n  /** Maximum speed [m/s] */\n  vMax?: number;\n  /** Total wheel inertia [kg*m^2] */\n  jWheels?: number;\n  /** Air density [kg/m^3] */\n  rhoAir?: number;\n  /** Gravitational acceleration [m/s^2] */\n  g?: number;\n}\n\n/** Default CAT 793D vehicle parameters */\nexport const CAT_793D_PARAMS: VehicleParams = {\n  mEmpty: 159_350,\n  mPayload: 190_000,\n  rWheel: 1.78,\n  aFrontal: 45.0,\n  cD: 0.9,\n  cR: 0.025,\n  vMax: 54.2 / 3.6, // 54.2 km/h in m/s\n  jWheels: 500,\n  rhoAir: 1.225,\n  g: 9.81,\n};\n\n/** Good haul road conditions */\nexport const CAT_793D_GOOD_ROAD: VehicleParams = {\n  ...CAT_793D_PARAMS,\n  cR: 0.015,\n};\n\n/** Poor haul road conditions */\nexport const CAT_793D_POOR_ROAD: VehicleParams = {\n  ...CAT_793D_PARAMS,\n  cR: 0.035,\n};\n\n/**\n * Vehicle road load component.\n *\n * Represents the vehicle mass, wheels, and road resistances.\n * This is the \"ground\" reference for the drivetrain.\n *\n * Road loads:\n * - Grade: F_grade = m * g * sin(theta)\n * - Rolling: F_roll = m * g * C_r * cos(theta)\n * - Aero: F_aero = 0.5 * rho * C_d * A * v^2\n */\nexport class VehicleComponent extends DrivetrainComponent {\n  readonly params: Required<VehicleParams>;\n  private _payloadFraction: number;\n  private _mass: number;\n\n  constructor(\n    params: VehicleParams = {},\n    payloadFraction: number = 1.0,\n    name: string = 'vehicle'\n  ) {\n    super(name);\n\n    // Merge with defaults\n    this.params = {\n      mEmpty: params.mEmpty ?? 159_350,\n      mPayload: params.mPayload ?? 190_000,\n      rWheel: params.rWheel ?? 1.78,\n      aFrontal: params.aFrontal ?? 45.0,\n      cD: params.cD ?? 0.9,\n      cR: params.cR ?? 0.025,\n      vMax: params.vMax ?? 54.2 / 3.6,\n      jWheels: params.jWheels ?? 500,\n      rhoAir: params.rhoAir ?? 1.225,\n      g: params.g ?? 9.81,\n    };\n\n    this._payloadFraction = Math.max(0, Math.min(1, payloadFraction));\n    this._mass = this.params.mEmpty + this._payloadFraction * this.params.mPayload;\n  }\n\n  get mass(): number {\n    return this._mass;\n  }\n\n  get payloadFraction(): number {\n    return this._payloadFraction;\n  }\n\n  set payloadFraction(value: number) {\n    this._payloadFraction = Math.max(0, Math.min(1, value));\n    this._mass = this.params.mEmpty + this._payloadFraction * this.params.mPayload;\n  }\n\n  get ports(): Record<string, Port> {\n    return {\n      wheels: {\n        name: 'wheels',\n        portType: PortType.MECHANICAL,\n        direction: PortDirection.INPUT,\n        description: 'Wheel input (driven by final drive)',\n      },\n    };\n  }\n\n  get stateNames(): string[] {\n    // Vehicle has no internal states in this model\n    return [];\n  }\n\n  getInertia(portName: string): number {\n    if (portName === 'wheels') {\n      // Effective inertia: wheel inertia + translational mass reflected\n      return this.params.jWheels + this._mass * this.params.rWheel * this.params.rWheel;\n    }\n    throw new Error(`Unknown port: ${portName}`);\n  }\n\n  getConstraints(): KinematicConstraint[] {\n    return [];\n  }\n\n  /**\n   * Calculate total road load force [N].\n   *\n   * @param velocity - Vehicle velocity [m/s]\n   * @param grade - Road grade (fraction, e.g., 0.05 for 5%)\n   * @returns Total resistance force [N]\n   */\n  calcTotalRoadLoad(velocity: number, grade: number): number {\n    const theta = Math.atan(grade);\n    const cosTheta = Math.cos(theta);\n    const sinTheta = Math.sin(theta);\n\n    // Grade resistance (always acts in direction of gravity)\n    const fGrade = this._mass * this.params.g * sinTheta;\n\n    // Rolling resistance (always positive, opposes motion)\n    const fRoll = this.params.cR * this._mass * this.params.g * cosTheta;\n\n    // Aerodynamic drag (opposes motion direction)\n    const v = Math.abs(velocity);\n    const fAero = 0.5 * this.params.rhoAir * this.params.cD * this.params.aFrontal * v * v;\n    const signV = velocity >= 0 ? 1 : -1;\n\n    // Match Python: F_grade + F_roll + F_aero * sign(v)\n    // Grade and rolling resistance don't depend on direction,\n    // only aero drag opposes the actual motion direction\n    return fGrade + fRoll + fAero * signV;\n  }\n\n  /**\n   * Calculate wheel torque demand for road load [N*m].\n   */\n  calcWheelTorqueDemand(velocity: number, grade: number): number {\n    const force = this.calcTotalRoadLoad(velocity, grade);\n    return force * this.params.rWheel;\n  }\n\n  /**\n   * Compute load torque at the wheels for dynamics simulation.\n   *\n   * @param omegaWheel - Wheel angular velocity [rad/s]\n   * @param grade - Road grade (fraction)\n   * @returns Load torque [N*m]\n   */\n  computeLoadTorque(omegaWheel: number, grade: number): number {\n    const velocity = omegaWheel * this.params.rWheel;\n    return this.calcWheelTorqueDemand(velocity, grade);\n  }\n\n  /**\n   * Convert wheel speed to vehicle velocity [m/s].\n   */\n  wheelSpeedToVelocity(omegaWheel: number): number {\n    return omegaWheel * this.params.rWheel;\n  }\n\n  /**\n   * Convert vehicle velocity to wheel speed [rad/s].\n   */\n  velocityToWheelSpeed(velocity: number): number {\n    return velocity / this.params.rWheel;\n  }\n\n  /**\n   * Get effective mass including rotational inertia contribution.\n   */\n  getEffectiveMass(): number {\n    // m_eff = m + J_wheels / r^2\n    return this._mass + this.params.jWheels / (this.params.rWheel * this.params.rWheel);\n  }\n\n  computeTorques(\n    _portSpeeds: Record<string, number>,\n    _controlInputs: Record<string, number>,\n    _internalStates?: Record<string, number>\n  ): Record<string, number> {\n    // Vehicle doesn't produce torque, only consumes it\n    return {};\n  }\n\n  computeStateDerivatives(\n    _internalStates: Record<string, number>,\n    _portValues: PortValues\n  ): Record<string, number> {\n    return {};\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 4907, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/components/index.ts"],"sourcesContent":["/**\n * Component exports.\n */\n\nexport { EngineComponent, CAT_3516E_PARAMS } from './engine';\nexport type { EngineParams } from './engine';\n\nexport { MotorComponent, MG1_PARAMS, MG2_PARAMS, createMG1, createMG2 } from './motor';\nexport type { MotorParams } from './motor';\n\nexport {\n  NSpeedGearboxComponent,\n  FinalDriveComponent,\n  FixedRatioGearComponent,\n  ECVT_GEARBOX_PARAMS,\n  DIESEL_7SPEED_PARAMS,\n  SINGLE_SPEED_PARAMS,\n} from './gearbox';\nexport type { GearboxParams } from './gearbox';\n\nexport { PlanetaryGearComponent, CAT_793D_PLANETARY_PARAMS } from './planetary';\nexport type { PlanetaryGearParams } from './planetary';\n\nexport {\n  BatteryComponent,\n  CAT_793D_BATTERY_PARAMS,\n  SERIES_HYBRID_BATTERY_PARAMS,\n  EV_BATTERY_PARAMS,\n} from './battery';\nexport type { BatteryParams } from './battery';\n\nexport {\n  VehicleComponent,\n  CAT_793D_PARAMS,\n  CAT_793D_GOOD_ROAD,\n  CAT_793D_POOR_ROAD,\n} from './vehicle';\nexport type { VehicleParams } from './vehicle';\n"],"names":[],"mappings":"AAAA;;CAEC;AAED;AAGA;AAGA;AAUA;AAGA;AAQA","debugId":null}},
    {"offset": {"line": 4926, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/math/index.ts"],"sourcesContent":["/**\n * Math utilities exports.\n */\n\nexport {\n  solveLinear,\n  matVecMul,\n  zeros,\n  eye,\n  addVectors,\n  subtractVectors,\n  scaleVector,\n  dot,\n  copyMatrix,\n} from './linalg';\n\nexport { interp, interp2d, searchSorted } from './interpolate';\n"],"names":[],"mappings":"AAAA;;CAEC;AAED;AAYA","debugId":null}},
    {"offset": {"line": 4937, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/simulation/config.ts"],"sourcesContent":["/**\n * Simulation configuration.\n */\n\n/**\n * Configuration for drivetrain simulation.\n */\nexport interface SimulationConfig {\n  /** Start time [s] */\n  tStart: number;\n  /** End time [s] */\n  tEnd: number;\n  /** Output time step [s] */\n  dtOutput: number;\n  /** ODE solver method */\n  method: 'RK4' | 'RK45' | 'Euler';\n  /** Relative tolerance for ODE solver */\n  rtol: number;\n  /** Absolute tolerance for ODE solver */\n  atol: number;\n  /** Maximum step size for ODE solver [s] */\n  maxStep: number | null;\n}\n\n/** Default simulation configuration */\nexport const DEFAULT_CONFIG: SimulationConfig = {\n  tStart: 0.0,\n  tEnd: 60.0,\n  dtOutput: 0.1,\n  method: 'RK4',\n  rtol: 1e-6,\n  atol: 1e-8,\n  maxStep: 0.01,\n};\n\n/** Short simulation profile */\nexport const SHORT_SIM: SimulationConfig = {\n  ...DEFAULT_CONFIG,\n  tEnd: 10.0,\n  dtOutput: 0.05,\n};\n\n/** Medium simulation profile */\nexport const MEDIUM_SIM: SimulationConfig = {\n  ...DEFAULT_CONFIG,\n  tEnd: 60.0,\n  dtOutput: 0.1,\n};\n\n/** Long simulation profile */\nexport const LONG_SIM: SimulationConfig = {\n  ...DEFAULT_CONFIG,\n  tEnd: 300.0,\n  dtOutput: 0.5,\n};\n\n/** High fidelity simulation profile */\nexport const HIGH_FIDELITY_SIM: SimulationConfig = {\n  ...DEFAULT_CONFIG,\n  tEnd: 60.0,\n  dtOutput: 0.01,\n  rtol: 1e-8,\n  atol: 1e-11,\n};\n\n/**\n * Get number of output points for a config.\n */\nexport function getNumOutputPoints(config: SimulationConfig): number {\n  return Math.floor((config.tEnd - config.tStart) / config.dtOutput) + 1;\n}\n\n/**\n * Get array of output time points for a config.\n */\nexport function getOutputTimes(config: SimulationConfig): number[] {\n  const n = getNumOutputPoints(config);\n  const times: number[] = [];\n  for (let i = 0; i < n; i++) {\n    times.push(config.tStart + i * config.dtOutput);\n  }\n  return times;\n}\n\n/**\n * Create a custom simulation config.\n */\nexport function createConfig(options: Partial<SimulationConfig> = {}): SimulationConfig {\n  const config = { ...DEFAULT_CONFIG, ...options };\n\n  if (config.tEnd <= config.tStart) {\n    throw new Error('tEnd must be greater than tStart');\n  }\n  if (config.dtOutput <= 0) {\n    throw new Error('dtOutput must be positive');\n  }\n\n  return config;\n}\n"],"names":[],"mappings":"AAAA;;CAEC,GAED;;CAEC;;;;;;;;;;;;;;;;;;AAmBM,MAAM,iBAAmC;IAC9C,QAAQ;IACR,MAAM;IACN,UAAU;IACV,QAAQ;IACR,MAAM;IACN,MAAM;IACN,SAAS;AACX;AAGO,MAAM,YAA8B;IACzC,GAAG,cAAc;IACjB,MAAM;IACN,UAAU;AACZ;AAGO,MAAM,aAA+B;IAC1C,GAAG,cAAc;IACjB,MAAM;IACN,UAAU;AACZ;AAGO,MAAM,WAA6B;IACxC,GAAG,cAAc;IACjB,MAAM;IACN,UAAU;AACZ;AAGO,MAAM,oBAAsC;IACjD,GAAG,cAAc;IACjB,MAAM;IACN,UAAU;IACV,MAAM;IACN,MAAM;AACR;AAKO,SAAS,mBAAmB,MAAwB;IACzD,OAAO,KAAK,KAAK,CAAC,CAAC,OAAO,IAAI,GAAG,OAAO,MAAM,IAAI,OAAO,QAAQ,IAAI;AACvE;AAKO,SAAS,eAAe,MAAwB;IACrD,MAAM,IAAI,mBAAmB;IAC7B,MAAM,QAAkB,EAAE;IAC1B,IAAK,IAAI,IAAI,GAAG,IAAI,GAAG,IAAK;QAC1B,MAAM,IAAI,CAAC,OAAO,MAAM,GAAG,IAAI,OAAO,QAAQ;IAChD;IACA,OAAO;AACT;AAKO,SAAS,aAAa,UAAqC,CAAC,CAAC;IAClE,MAAM,SAAS;QAAE,GAAG,cAAc;QAAE,GAAG,OAAO;IAAC;IAE/C,IAAI,OAAO,IAAI,IAAI,OAAO,MAAM,EAAE;QAChC,MAAM,IAAI,MAAM;IAClB;IACA,IAAI,OAAO,QAAQ,IAAI,GAAG;QACxB,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO;AACT","debugId":null}},
    {"offset": {"line": 5018, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/simulation/result.ts"],"sourcesContent":["/**\n * Simulation result container.\n */\n\nimport { interp } from '../math/interpolate';\n\n/**\n * Container for simulation results.\n *\n * All time series are arrays with length n_time_points.\n */\nexport interface SimulationResult {\n  /** Time points [s] */\n  time: number[];\n  /** State variables over time {name: array} */\n  states: Record<string, number[]>;\n  /** Control inputs over time {name: array} */\n  controls: Record<string, number[]>;\n  /** Derived outputs over time {name: array} */\n  outputs: Record<string, number[]>;\n  /** Additional simulation metadata */\n  metadata: Record<string, unknown>;\n}\n\n/**\n * Create an empty simulation result.\n */\nexport function createResult(): SimulationResult {\n  return {\n    time: [],\n    states: {},\n    controls: {},\n    outputs: {},\n    metadata: {},\n  };\n}\n\n/**\n * Get number of time points.\n */\nexport function getNumPoints(result: SimulationResult): number {\n  return result.time.length;\n}\n\n/**\n * Get simulation duration [s].\n */\nexport function getDuration(result: SimulationResult): number {\n  const n = result.time.length;\n  return n > 1 ? result.time[n - 1] - result.time[0] : 0;\n}\n\n/**\n * Get average time step [s].\n */\nexport function getAverageDt(result: SimulationResult): number {\n  const n = result.time.length;\n  return n > 1 ? getDuration(result) / (n - 1) : 0;\n}\n\n/**\n * Get a state variable by name.\n */\nexport function getState(result: SimulationResult, name: string): number[] | null {\n  return result.states[name] ?? null;\n}\n\n/**\n * Get a control input by name.\n */\nexport function getControl(result: SimulationResult, name: string): number[] | null {\n  return result.controls[name] ?? null;\n}\n\n/**\n * Get a derived output by name.\n */\nexport function getOutput(result: SimulationResult, name: string): number[] | null {\n  return result.outputs[name] ?? null;\n}\n\n/**\n * Get vehicle velocity [m/s].\n */\nexport function getVelocity(result: SimulationResult): number[] | null {\n  return result.outputs.velocity ?? null;\n}\n\n/**\n * Get vehicle velocity [km/h].\n */\nexport function getVelocityKmh(result: SimulationResult): number[] | null {\n  const v = getVelocity(result);\n  return v ? v.map((val) => val * 3.6) : null;\n}\n\n/**\n * Get battery state of charge [0-1].\n */\nexport function getSoc(result: SimulationResult): number[] | null {\n  // Look for SOC in states (component.SOC format)\n  for (const [name, values] of Object.entries(result.states)) {\n    if (name.endsWith('.SOC') || name === 'SOC') {\n      return values;\n    }\n  }\n  return null;\n}\n\n/**\n * Get engine power [W].\n */\nexport function getEnginePower(result: SimulationResult): number[] | null {\n  return result.outputs.P_engine ?? null;\n}\n\n/**\n * Get fuel consumption rate [kg/s].\n */\nexport function getFuelRate(result: SimulationResult): number[] | null {\n  return result.outputs.fuel_rate ?? null;\n}\n\n/**\n * Get total fuel consumed [kg] using trapezoidal integration.\n */\nexport function getFuelTotal(result: SimulationResult): number | null {\n  const rate = getFuelRate(result);\n  if (!rate || result.time.length < 2) {\n    return null;\n  }\n\n  // Trapezoidal integration\n  let total = 0;\n  for (let i = 1; i < result.time.length; i++) {\n    const dt = result.time[i] - result.time[i - 1];\n    total += 0.5 * (rate[i - 1] + rate[i]) * dt;\n  }\n  return total;\n}\n\n/**\n * Get final values of all states.\n */\nexport function getFinalState(result: SimulationResult): Record<string, number> {\n  const final: Record<string, number> = {};\n  for (const [name, values] of Object.entries(result.states)) {\n    final[name] = values[values.length - 1];\n  }\n  return final;\n}\n\n/**\n * Get maximum value of a variable.\n */\nexport function getMax(result: SimulationResult, name: string): number | null {\n  for (const source of [result.states, result.controls, result.outputs]) {\n    if (name in source) {\n      return Math.max(...source[name]);\n    }\n  }\n  return null;\n}\n\n/**\n * Get minimum value of a variable.\n */\nexport function getMin(result: SimulationResult, name: string): number | null {\n  for (const source of [result.states, result.controls, result.outputs]) {\n    if (name in source) {\n      return Math.min(...source[name]);\n    }\n  }\n  return null;\n}\n\n/**\n * Get mean value of a variable.\n */\nexport function getMean(result: SimulationResult, name: string): number | null {\n  for (const source of [result.states, result.controls, result.outputs]) {\n    if (name in source) {\n      const arr = source[name];\n      return arr.reduce((a, b) => a + b, 0) / arr.length;\n    }\n  }\n  return null;\n}\n\n/**\n * Extract a time slice of the results.\n */\nexport function sliceResult(\n  result: SimulationResult,\n  tStart: number,\n  tEnd: number\n): SimulationResult {\n  const indices: number[] = [];\n  for (let i = 0; i < result.time.length; i++) {\n    if (result.time[i] >= tStart && result.time[i] <= tEnd) {\n      indices.push(i);\n    }\n  }\n\n  const sliceArray = (arr: number[]) => indices.map((i) => arr[i]);\n\n  return {\n    time: sliceArray(result.time),\n    states: Object.fromEntries(\n      Object.entries(result.states).map(([k, v]) => [k, sliceArray(v)])\n    ),\n    controls: Object.fromEntries(\n      Object.entries(result.controls).map(([k, v]) => [k, sliceArray(v)])\n    ),\n    outputs: Object.fromEntries(\n      Object.entries(result.outputs).map(([k, v]) => [k, sliceArray(v)])\n    ),\n    metadata: { ...result.metadata },\n  };\n}\n\n/**\n * Resample results to a new time step.\n */\nexport function resampleResult(result: SimulationResult, dt: number): SimulationResult {\n  const newTime: number[] = [];\n  for (let t = result.time[0]; t <= result.time[result.time.length - 1]; t += dt) {\n    newTime.push(t);\n  }\n\n  const interpArray = (arr: number[]) =>\n    newTime.map((t) => interp(t, result.time, arr));\n\n  return {\n    time: newTime,\n    states: Object.fromEntries(\n      Object.entries(result.states).map(([k, v]) => [k, interpArray(v)])\n    ),\n    controls: Object.fromEntries(\n      Object.entries(result.controls).map(([k, v]) => [k, interpArray(v)])\n    ),\n    outputs: Object.fromEntries(\n      Object.entries(result.outputs).map(([k, v]) => [k, interpArray(v)])\n    ),\n    metadata: { ...result.metadata },\n  };\n}\n\n/**\n * Generate a text summary of results.\n */\nexport function summarizeResult(result: SimulationResult): string {\n  const lines = [\n    'Simulation Results',\n    `  Duration: ${getDuration(result).toFixed(1)} s (${getNumPoints(result)} points)`,\n    `  States: ${Object.keys(result.states).join(', ')}`,\n    `  Controls: ${Object.keys(result.controls).join(', ')}`,\n    `  Outputs: ${Object.keys(result.outputs).join(', ')}`,\n  ];\n\n  const v = getVelocity(result);\n  if (v) {\n    const vKmh = v.map((val) => val * 3.6);\n    lines.push(\n      `  Velocity: ${vKmh[0].toFixed(1)} -> ${vKmh[vKmh.length - 1].toFixed(1)} km/h ` +\n        `(max ${Math.max(...vKmh).toFixed(1)} km/h)`\n    );\n  }\n\n  const soc = getSoc(result);\n  if (soc) {\n    lines.push(\n      `  SOC: ${(soc[0] * 100).toFixed(1)}% -> ${(soc[soc.length - 1] * 100).toFixed(1)}%`\n    );\n  }\n\n  const fuel = getFuelTotal(result);\n  if (fuel !== null) {\n    lines.push(`  Fuel consumed: ${fuel.toFixed(2)} kg`);\n  }\n\n  return lines.join('\\n');\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 5251, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/simulation/integrator.ts"],"sourcesContent":["/**\n * ODE integration utilities.\n *\n * Provides simple numerical integrators for drivetrain simulation.\n * For production use with stiff problems, consider using odex.js.\n */\n\n/**\n * Dynamics function signature.\n */\nexport type DynamicsFunction = (t: number, x: number[]) => number[];\n\n/**\n * Integration result.\n */\nexport interface IntegrationResult {\n  /** Time points */\n  t: number[];\n  /** State values at each time point (column-major: y[stateIdx][timeIdx]) */\n  y: number[][];\n  /** Whether integration succeeded */\n  success: boolean;\n  /** Error message if failed */\n  message?: string;\n  /** Number of function evaluations */\n  nfev: number;\n}\n\n/**\n * Simple Euler integration step.\n */\nexport function eulerStep(\n  f: DynamicsFunction,\n  t: number,\n  x: number[],\n  h: number\n): number[] {\n  const dx = f(t, x);\n  return x.map((xi, i) => xi + h * dx[i]);\n}\n\n/**\n * Fourth-order Runge-Kutta integration step (RK4).\n */\nexport function rk4Step(\n  f: DynamicsFunction,\n  t: number,\n  x: number[],\n  h: number\n): number[] {\n  const k1 = f(t, x);\n  const k2 = f(t + h / 2, x.map((xi, i) => xi + (h / 2) * k1[i]));\n  const k3 = f(t + h / 2, x.map((xi, i) => xi + (h / 2) * k2[i]));\n  const k4 = f(t + h, x.map((xi, i) => xi + h * k3[i]));\n\n  return x.map(\n    (xi, i) => xi + (h / 6) * (k1[i] + 2 * k2[i] + 2 * k3[i] + k4[i])\n  );\n}\n\n/**\n * Adaptive Runge-Kutta-Fehlberg (RK45) integration step.\n *\n * Returns both the new state and an error estimate.\n */\nexport function rk45Step(\n  f: DynamicsFunction,\n  t: number,\n  x: number[],\n  h: number\n): { xNew: number[]; error: number } {\n  // Butcher tableau coefficients for RK45\n  const k1 = f(t, x);\n  const k2 = f(\n    t + h / 4,\n    x.map((xi, i) => xi + (h / 4) * k1[i])\n  );\n  const k3 = f(\n    t + (3 * h) / 8,\n    x.map((xi, i) => xi + (3 * h / 32) * k1[i] + (9 * h / 32) * k2[i])\n  );\n  const k4 = f(\n    t + (12 * h) / 13,\n    x.map(\n      (xi, i) =>\n        xi +\n        (1932 * h / 2197) * k1[i] -\n        (7200 * h / 2197) * k2[i] +\n        (7296 * h / 2197) * k3[i]\n    )\n  );\n  const k5 = f(\n    t + h,\n    x.map(\n      (xi, i) =>\n        xi +\n        (439 * h / 216) * k1[i] -\n        8 * h * k2[i] +\n        (3680 * h / 513) * k3[i] -\n        (845 * h / 4104) * k4[i]\n    )\n  );\n  const k6 = f(\n    t + h / 2,\n    x.map(\n      (xi, i) =>\n        xi -\n        (8 * h / 27) * k1[i] +\n        2 * h * k2[i] -\n        (3544 * h / 2565) * k3[i] +\n        (1859 * h / 4104) * k4[i] -\n        (11 * h / 40) * k5[i]\n    )\n  );\n\n  // Fifth-order solution\n  const xNew = x.map(\n    (xi, i) =>\n      xi +\n      h *\n        ((16 / 135) * k1[i] +\n          (6656 / 12825) * k3[i] +\n          (28561 / 56430) * k4[i] -\n          (9 / 50) * k5[i] +\n          (2 / 55) * k6[i])\n  );\n\n  // Fourth-order solution for error estimation\n  const x4 = x.map(\n    (xi, i) =>\n      xi +\n      h *\n        ((25 / 216) * k1[i] +\n          (1408 / 2565) * k3[i] +\n          (2197 / 4104) * k4[i] -\n          (1 / 5) * k5[i])\n  );\n\n  // Error estimate (max norm)\n  let error = 0;\n  for (let i = 0; i < x.length; i++) {\n    error = Math.max(error, Math.abs(xNew[i] - x4[i]));\n  }\n\n  return { xNew, error };\n}\n\n/**\n * Solve ODE initial value problem using RK4.\n *\n * @param f - Dynamics function dx/dt = f(t, x)\n * @param tSpan - [t_start, t_end]\n * @param x0 - Initial state\n * @param options - Integration options\n * @returns Integration result\n */\nexport function solveIVP(\n  f: DynamicsFunction,\n  tSpan: [number, number],\n  x0: number[],\n  options: {\n    method?: 'RK4' | 'RK45' | 'Euler';\n    tEval?: number[];\n    rtol?: number;\n    atol?: number;\n    maxStep?: number;\n  } = {}\n): IntegrationResult {\n  const { method = 'RK4', tEval, rtol = 1e-6, atol = 1e-8, maxStep = 0.01 } = options;\n\n  const [tStart, tEnd] = tSpan;\n  let t = tStart;\n  let x = [...x0];\n  let nfev = 0;\n\n  // Store results at evaluation points or at step points\n  const outputTimes = tEval ?? [];\n  const useOutputTimes = outputTimes.length > 0;\n  let outputIdx = 0;\n\n  const tResult: number[] = [];\n  const yResult: number[][] = x0.map(() => []);\n\n  // Helper to record state\n  const recordState = (time: number, state: number[]) => {\n    tResult.push(time);\n    for (let i = 0; i < state.length; i++) {\n      yResult[i].push(state[i]);\n    }\n  };\n\n  // Record initial state\n  if (!useOutputTimes || (outputTimes.length > 0 && outputTimes[0] <= tStart)) {\n    recordState(t, x);\n    if (useOutputTimes) outputIdx++;\n  }\n\n  // Wrapped dynamics that counts evaluations\n  const wrappedF: DynamicsFunction = (time, state) => {\n    nfev++;\n    return f(time, state);\n  };\n\n  // Integration loop\n  const h = maxStep ?? 0.01;\n  let stepFn: (fn: DynamicsFunction, time: number, state: number[], dt: number) => number[];\n\n  switch (method) {\n    case 'Euler':\n      stepFn = eulerStep;\n      break;\n    case 'RK45':\n    case 'RK4':\n    default:\n      stepFn = rk4Step;\n      break;\n  }\n\n  try {\n    while (t < tEnd) {\n      // Determine step size (don't overshoot tEnd or next output time)\n      let dt = h;\n      if (t + dt > tEnd) {\n        dt = tEnd - t;\n      }\n      if (useOutputTimes && outputIdx < outputTimes.length && t + dt > outputTimes[outputIdx]) {\n        dt = outputTimes[outputIdx] - t;\n      }\n\n      // Take a step\n      x = stepFn(wrappedF, t, x, dt);\n      t += dt;\n\n      // Record at output times\n      if (useOutputTimes) {\n        while (outputIdx < outputTimes.length && Math.abs(t - outputTimes[outputIdx]) < 1e-12) {\n          recordState(t, x);\n          outputIdx++;\n        }\n      } else {\n        recordState(t, x);\n      }\n    }\n\n    return {\n      t: tResult,\n      y: yResult,\n      success: true,\n      nfev,\n    };\n  } catch (error) {\n    return {\n      t: tResult,\n      y: yResult,\n      success: false,\n      message: error instanceof Error ? error.message : 'Unknown error',\n      nfev,\n    };\n  }\n}\n\n/**\n * Simple fixed-step integration (no adaptive stepping).\n *\n * Useful for guaranteed output at specific times.\n */\nexport function integrateFixed(\n  f: DynamicsFunction,\n  tEval: number[],\n  x0: number[],\n  method: 'RK4' | 'Euler' = 'RK4'\n): IntegrationResult {\n  const stepFn = method === 'Euler' ? eulerStep : rk4Step;\n  let nfev = 0;\n\n  const wrappedF: DynamicsFunction = (t, x) => {\n    nfev++;\n    return f(t, x);\n  };\n\n  const yResult: number[][] = x0.map(() => []);\n  let x = [...x0];\n\n  // Record initial state\n  for (let i = 0; i < x.length; i++) {\n    yResult[i].push(x[i]);\n  }\n\n  try {\n    for (let k = 1; k < tEval.length; k++) {\n      const dt = tEval[k] - tEval[k - 1];\n      x = stepFn(wrappedF, tEval[k - 1], x, dt);\n\n      for (let i = 0; i < x.length; i++) {\n        yResult[i].push(x[i]);\n      }\n    }\n\n    return {\n      t: tEval,\n      y: yResult,\n      success: true,\n      nfev,\n    };\n  } catch (error) {\n    return {\n      t: tEval,\n      y: yResult,\n      success: false,\n      message: error instanceof Error ? error.message : 'Unknown error',\n      nfev,\n    };\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 5429, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/simulation/simulator.ts"],"sourcesContent":["/**\n * Drivetrain simulator with ODE integration.\n */\n\nimport { Drivetrain } from '../core/drivetrain';\nimport { interp } from '../math/interpolate';\nimport {\n  SimulationConfig,\n  DEFAULT_CONFIG,\n  getOutputTimes,\n} from './config';\nimport { SimulationResult, createResult } from './result';\nimport { solveIVP, integrateFixed } from './integrator';\n\n/**\n * Control function type.\n * Takes time, state dict, and grade, returns control dict.\n */\nexport type ControlFunction = (\n  t: number,\n  state: Record<string, number>,\n  grade: number\n) => Record<string, number>;\n\n/**\n * Grade function type.\n * Takes time, returns grade (fraction, e.g., 0.05 for 5%).\n */\nexport type GradeFunction = (t: number) => number;\n\n/**\n * Drivetrain controller interface.\n */\nexport interface DrivetrainController {\n  compute(state: Record<string, number>, grade: number): Record<string, number>;\n}\n\n/**\n * Simulator for any drivetrain topology.\n *\n * Wraps the Drivetrain dynamics with ODE integration and result processing.\n */\nexport class DrivetrainSimulator {\n  readonly drivetrain: Drivetrain;\n  private _controlLog: Array<[number, Record<string, number>]> = [];\n  private _gradeLog: Array<[number, number]> = [];\n\n  constructor(drivetrain: Drivetrain) {\n    this.drivetrain = drivetrain;\n  }\n\n  /**\n   * Run a time-domain simulation.\n   *\n   * @param x0 - Initial state {state_name: value}\n   * @param controller - Control function or controller object\n   * @param gradeProfile - Road grade as constant or function of time\n   * @param config - Simulation configuration\n   * @returns SimulationResult with all time series data\n   */\n  simulate(\n    x0: Record<string, number>,\n    controller: ControlFunction | DrivetrainController,\n    gradeProfile: number | GradeFunction = 0.0,\n    config: SimulationConfig = DEFAULT_CONFIG\n  ): SimulationResult {\n    this._controlLog = [];\n    this._gradeLog = [];\n\n    // Convert initial state to array\n    const x0Arr = this.drivetrain.stateToArray(x0);\n\n    // Wrap grade profile as function\n    const gradeFn: GradeFunction =\n      typeof gradeProfile === 'function'\n        ? gradeProfile\n        : () => gradeProfile as number;\n\n    // Wrap controller\n    const controlFn: ControlFunction =\n      'compute' in controller\n        ? (t, state, grade) => (controller as DrivetrainController).compute(state, grade)\n        : (controller as ControlFunction);\n\n    // Define dynamics wrapper for ODE solver\n    const dynamicsWrapper = (t: number, x: number[]): number[] => {\n      // Get current state as dict\n      const state = this.drivetrain.arrayToState(x);\n\n      // Get grade\n      const grade = gradeFn(t);\n\n      // Get control inputs\n      const control = controlFn(t, state, grade);\n\n      // Log for post-processing\n      this._controlLog.push([t, { ...control }]);\n      this._gradeLog.push([t, grade]);\n\n      // Compute dynamics\n      return this.drivetrain.dynamics(t, x, control, { grade });\n    };\n\n    // Set up output time points\n    const tEval = getOutputTimes(config);\n\n    // Run ODE integration with proper sub-stepping\n    const sol = solveIVP(\n      dynamicsWrapper,\n      [config.tStart, config.tEnd],\n      x0Arr,\n      {\n        method: config.method === 'RK45' ? 'RK45' : 'RK4',\n        tEval,\n        rtol: config.rtol,\n        atol: config.atol,\n        maxStep: config.maxStep ?? 0.005, // 5ms default for accuracy\n      }\n    );\n\n    if (!sol.success) {\n      throw new Error(`ODE integration failed: ${sol.message}`);\n    }\n\n    // Build result\n    return this._buildResult(sol, config);\n  }\n\n  /**\n   * Run simulation with progress callback (for UI updates).\n   * Uses internal sub-stepping for accuracy (similar to scipy's adaptive stepping).\n   */\n  async simulateWithProgress(\n    x0: Record<string, number>,\n    controller: ControlFunction | DrivetrainController,\n    gradeProfile: number | GradeFunction = 0.0,\n    config: SimulationConfig = DEFAULT_CONFIG,\n    onProgress?: (progress: number) => void\n  ): Promise<SimulationResult> {\n    this._controlLog = [];\n    this._gradeLog = [];\n\n    const x0Arr = this.drivetrain.stateToArray(x0);\n\n    const gradeFn: GradeFunction =\n      typeof gradeProfile === 'function'\n        ? gradeProfile\n        : () => gradeProfile as number;\n\n    const controlFn: ControlFunction =\n      'compute' in controller\n        ? (t, state, grade) => (controller as DrivetrainController).compute(state, grade)\n        : (controller as ControlFunction);\n\n    const tEval = getOutputTimes(config);\n    const totalSteps = tEval.length - 1;\n\n    // Internal step size for accuracy (similar to scipy's adaptive stepping)\n    const maxStep = config.maxStep ?? 0.005; // 5ms default for good accuracy\n\n    // Manual integration with progress updates\n    const yResult: number[][] = x0Arr.map(() => []);\n    let x = [...x0Arr];\n    let nfev = 0;\n\n    // Record initial state\n    for (let i = 0; i < x.length; i++) {\n      yResult[i].push(x[i]);\n    }\n\n    // Helper for a single RK4 step\n    const rk4Step = (t: number, state: number[], h: number, ctrl: Record<string, number>, grade: number): number[] => {\n      const k1 = this.drivetrain.dynamics(t, state, ctrl, { grade });\n      nfev++;\n      const k2 = this.drivetrain.dynamics(\n        t + h / 2,\n        state.map((xi, i) => xi + (h / 2) * k1[i]),\n        ctrl,\n        { grade }\n      );\n      nfev++;\n      const k3 = this.drivetrain.dynamics(\n        t + h / 2,\n        state.map((xi, i) => xi + (h / 2) * k2[i]),\n        ctrl,\n        { grade }\n      );\n      nfev++;\n      const k4 = this.drivetrain.dynamics(\n        t + h,\n        state.map((xi, i) => xi + h * k3[i]),\n        ctrl,\n        { grade }\n      );\n      nfev++;\n\n      return state.map(\n        (xi, i) => xi + (h / 6) * (k1[i] + 2 * k2[i] + 2 * k3[i] + k4[i])\n      );\n    };\n\n    for (let k = 1; k < tEval.length; k++) {\n      const tStart = tEval[k - 1];\n      const tEnd = tEval[k];\n\n      // Sub-step through this interval for accuracy\n      let t = tStart;\n      while (t < tEnd - 1e-12) {\n        // Determine step size (don't overshoot)\n        const h = Math.min(maxStep, tEnd - t);\n\n        // Get current state dict and control at this sub-step time\n        const stateDict = this.drivetrain.arrayToState(x);\n        const grade = gradeFn(t);\n        const control = controlFn(t, stateDict, grade);\n\n        // Only log at output interval boundaries (not every sub-step)\n        if (Math.abs(t - tStart) < 1e-12) {\n          this._controlLog.push([t, { ...control }]);\n          this._gradeLog.push([t, grade]);\n        }\n\n        // RK4 step\n        x = rk4Step(t, x, h, control, grade);\n        t += h;\n      }\n\n      // Record state at output time\n      for (let i = 0; i < x.length; i++) {\n        yResult[i].push(x[i]);\n      }\n\n      // Report progress\n      if (onProgress && k % 10 === 0) {\n        onProgress(k / totalSteps);\n        // Yield to allow UI updates\n        await new Promise((resolve) => setTimeout(resolve, 0));\n      }\n    }\n\n    if (onProgress) {\n      onProgress(1);\n    }\n\n    const sol = {\n      t: tEval,\n      y: yResult,\n      success: true,\n      nfev,\n    };\n\n    return this._buildResult(sol, config);\n  }\n\n  private _buildResult(\n    sol: { t: number[]; y: number[][]; nfev: number },\n    config: SimulationConfig\n  ): SimulationResult {\n    const time = sol.t;\n    const nPoints = time.length;\n\n    // Extract states\n    const states: Record<string, number[]> = {};\n    for (let i = 0; i < this.drivetrain.stateNames.length; i++) {\n      states[this.drivetrain.stateNames[i]] = sol.y[i];\n    }\n\n    // Interpolate control log to output times\n    const controls = this._interpolateControls(time);\n\n    // Compute derived outputs\n    const outputs = this._computeOutputs(time, sol.y, controls);\n\n    // Metadata\n    const metadata = {\n      solver_method: config.method,\n      n_function_evals: sol.nfev,\n      drivetrain_type: 'Drivetrain',\n      components: Array.from(this.drivetrain.topology.components.keys()),\n    };\n\n    return {\n      time,\n      states,\n      controls,\n      outputs,\n      metadata,\n    };\n  }\n\n  private _interpolateControls(time: number[]): Record<string, number[]> {\n    if (this._controlLog.length === 0) {\n      return {};\n    }\n\n    // Get all control keys\n    const allKeys = new Set<string>();\n    for (const [, ctrl] of this._controlLog) {\n      for (const key of Object.keys(ctrl)) {\n        allKeys.add(key);\n      }\n    }\n\n    // Build time series for each control\n    const logTimes = this._controlLog.map(([t]) => t);\n    const controls: Record<string, number[]> = {};\n\n    for (const key of allKeys) {\n      const values = this._controlLog.map(([, ctrl]) => ctrl[key] ?? 0);\n      controls[key] = time.map((t) => interp(t, logTimes, values));\n    }\n\n    return controls;\n  }\n\n  private _computeOutputs(\n    time: number[],\n    y: number[][],\n    controls: Record<string, number[]>\n  ): Record<string, number[]> {\n    const outputs: Record<string, number[]> = {};\n    const nPoints = time.length;\n\n    // Velocity\n    const velocities: number[] = [];\n    for (let i = 0; i < nPoints; i++) {\n      const state = y.map((arr) => arr[i]);\n      velocities.push(this.drivetrain.getVelocity(state));\n    }\n    outputs.velocity = velocities;\n\n    // Grade (from log)\n    if (this._gradeLog.length > 0) {\n      const logTimes = this._gradeLog.map(([t]) => t);\n      const grades = this._gradeLog.map(([, g]) => g);\n      outputs.grade = time.map((t) => interp(t, logTimes, grades));\n    }\n\n    // Power calculations\n    Object.assign(outputs, this._computePowerOutputs(time, y, controls));\n\n    return outputs;\n  }\n\n  private _computePowerOutputs(\n    time: number[],\n    y: number[][],\n    controls: Record<string, number[]>\n  ): Record<string, number[]> {\n    const outputs: Record<string, number[]> = {};\n    const nPoints = time.length;\n    const components = this.drivetrain.topology.components;\n\n    // Engine power\n    for (const [compName, component] of components) {\n      if (component.constructor.name.includes('Engine')) {\n        const tKey = `T_${compName}`;\n        if (tKey in controls) {\n          const speedKey = `${compName}.shaft`;\n          const omega: number[] = [];\n\n          for (let i = 0; i < nPoints; i++) {\n            const state = y.map((arr) => arr[i]);\n            const allSpeeds = this.drivetrain.getAllSpeeds(state);\n            omega.push(allSpeeds[speedKey] ?? 0);\n          }\n\n          const torque = controls[tKey];\n          const power = torque.map((t, i) => t * omega[i]);\n          outputs[`P_${compName}`] = power;\n\n          // Fuel rate\n          if ('getFuelRate' in component) {\n            const fuelRate: number[] = [];\n            for (let i = 0; i < nPoints; i++) {\n              fuelRate.push((component as any).getFuelRate(torque[i], omega[i]));\n            }\n            outputs.fuel_rate = fuelRate;\n          }\n        }\n      }\n    }\n\n    // Motor power\n    for (const [compName, component] of components) {\n      if (component.constructor.name.includes('Motor')) {\n        const tKey = `T_${compName}`;\n        if (tKey in controls) {\n          const speedKey = `${compName}.shaft`;\n          const omega: number[] = [];\n\n          for (let i = 0; i < nPoints; i++) {\n            const state = y.map((arr) => arr[i]);\n            const allSpeeds = this.drivetrain.getAllSpeeds(state);\n            omega.push(allSpeeds[speedKey] ?? 0);\n          }\n\n          const torque = controls[tKey];\n          const pMech = torque.map((t, i) => t * omega[i]);\n          outputs[`P_${compName}_mech`] = pMech;\n\n          // Electrical power\n          if ('getElectricalPower' in component) {\n            const pElec: number[] = [];\n            for (let i = 0; i < nPoints; i++) {\n              pElec.push((component as any).getElectricalPower(torque[i], omega[i]));\n            }\n            outputs[`P_${compName}_elec`] = pElec;\n          }\n        }\n      }\n    }\n\n    return outputs;\n  }\n}\n\n/**\n * Convenience function to run a simulation.\n */\nexport function simulate(\n  drivetrain: Drivetrain,\n  x0: Record<string, number>,\n  controller: ControlFunction | DrivetrainController,\n  gradeProfile: number | GradeFunction = 0.0,\n  config: SimulationConfig = DEFAULT_CONFIG\n): SimulationResult {\n  const simulator = new DrivetrainSimulator(drivetrain);\n  return simulator.simulate(x0, controller, gradeProfile, config);\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 5738, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/simulation/index.ts"],"sourcesContent":["/**\n * Simulation module exports.\n */\n\nexport type { SimulationConfig } from './config';\nexport {\n  DEFAULT_CONFIG,\n  SHORT_SIM,\n  MEDIUM_SIM,\n  LONG_SIM,\n  HIGH_FIDELITY_SIM,\n  getNumOutputPoints,\n  getOutputTimes,\n  createConfig,\n} from './config';\n\nexport type { SimulationResult } from './result';\nexport {\n  createResult,\n  getNumPoints,\n  getDuration,\n  getAverageDt,\n  getState,\n  getControl,\n  getOutput,\n  getVelocity,\n  getVelocityKmh,\n  getSoc,\n  getEnginePower,\n  getFuelRate,\n  getFuelTotal,\n  getFinalState,\n  getMax,\n  getMin,\n  getMean,\n  sliceResult,\n  resampleResult,\n  summarizeResult,\n} from './result';\n\nexport type { DynamicsFunction, IntegrationResult } from './integrator';\nexport {\n  eulerStep,\n  rk4Step,\n  rk45Step,\n  solveIVP,\n  integrateFixed,\n} from './integrator';\n\nexport type { ControlFunction, GradeFunction, DrivetrainController } from './simulator';\nexport {\n  DrivetrainSimulator,\n  simulate,\n} from './simulator';\n"],"names":[],"mappings":"AAAA;;CAEC;AAGD;AAYA;AAwBA;AASA","debugId":null}},
    {"offset": {"line": 5753, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/control/base.ts"],"sourcesContent":["/**\n * Base controller class for drivetrains.\n */\n\nimport { Drivetrain } from '../core/drivetrain';\n\n/**\n * Abstract base class for drivetrain controllers.\n *\n * Controllers compute control inputs (torques, gear selections) based\n * on the current state and desired behavior (speed target, power demand, etc.).\n */\nexport abstract class DrivetrainController {\n  readonly drivetrain: Drivetrain;\n  protected _targetVelocity: number | null = null;\n\n  constructor(drivetrain: Drivetrain) {\n    this.drivetrain = drivetrain;\n  }\n\n  /** Target velocity [m/s]. */\n  get targetVelocity(): number | null {\n    return this._targetVelocity;\n  }\n\n  set targetVelocity(value: number | null) {\n    this._targetVelocity = value;\n  }\n\n  /**\n   * Compute control inputs.\n   *\n   * @param state - Current state {state_name: value}\n   * @param grade - Current road grade [fraction]\n   * @returns Control inputs {control_name: value}\n   *   Typical keys: T_engine, T_MG1, T_MG2, gear_gearbox\n   */\n  abstract compute(state: Record<string, number>, grade: number): Record<string, number>;\n\n  /**\n   * Reset controller state (for stateful controllers).\n   */\n  reset(): void {\n    // Override in subclass if needed\n  }\n\n  /**\n   * Get current vehicle velocity from state.\n   *\n   * @param state - Current state dict\n   * @returns Velocity [m/s]\n   */\n  getVelocity(state: Record<string, number>): number {\n    const x = this.drivetrain.stateToArray(state);\n    return this.drivetrain.getVelocity(x);\n  }\n}\n"],"names":[],"mappings":"AAAA;;CAEC;;;;AAUM,MAAe;IACX,WAAuB;IACtB,kBAAiC,KAAK;IAEhD,YAAY,UAAsB,CAAE;QAClC,IAAI,CAAC,UAAU,GAAG;IACpB;IAEA,2BAA2B,GAC3B,IAAI,iBAAgC;QAClC,OAAO,IAAI,CAAC,eAAe;IAC7B;IAEA,IAAI,eAAe,KAAoB,EAAE;QACvC,IAAI,CAAC,eAAe,GAAG;IACzB;IAYA;;GAEC,GACD,QAAc;IACZ,iCAAiC;IACnC;IAEA;;;;;GAKC,GACD,YAAY,KAA6B,EAAU;QACjD,MAAM,IAAI,IAAI,CAAC,UAAU,CAAC,YAAY,CAAC;QACvC,OAAO,IAAI,CAAC,UAAU,CAAC,WAAW,CAAC;IACrC;AACF","debugId":null}},
    {"offset": {"line": 5790, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/control/conventional.ts"],"sourcesContent":["/**\n * Controller for conventional diesel drivetrains.\n */\n\nimport { Drivetrain } from '../core/drivetrain';\nimport { DrivetrainController } from './base';\n\n/**\n * Gear shift schedule based on vehicle speed.\n */\nexport interface GearShiftSchedule {\n  /** Speed thresholds for upshifting [m/s] */\n  upshiftSpeeds: number[];\n  /** Speed thresholds for downshifting [m/s] */\n  downshiftSpeeds: number[];\n  /** Speed hysteresis to prevent hunting [m/s] */\n  hysteresis: number;\n}\n\n/**\n * Create shift schedule from gear ratios.\n *\n * @param ratios - Gear ratios [K1, K2, ...]\n * @param engineRpmUpshift - Engine RPM to upshift at\n * @param engineRpmDownshift - Engine RPM to downshift at\n * @param wheelRadius - Wheel radius [m]\n * @param finalDrive - Final drive ratio\n */\nexport function createShiftSchedule(\n  ratios: number[],\n  engineRpmUpshift: number = 1500.0,\n  engineRpmDownshift: number = 1000.0,\n  wheelRadius: number = 1.78,\n  finalDrive: number = 16.0\n): GearShiftSchedule {\n  const omegaUp = (engineRpmUpshift * Math.PI) / 30.0;\n  const omegaDown = (engineRpmDownshift * Math.PI) / 30.0;\n\n  const upshiftSpeeds: number[] = [];\n  const downshiftSpeeds: number[] = [];\n\n  // Speed at which to upshift from gear i to i+1\n  for (let i = 0; i < ratios.length - 1; i++) {\n    const ratio = ratios[i];\n    const vUp = (omegaUp * wheelRadius) / (ratio * finalDrive);\n    upshiftSpeeds.push(vUp);\n  }\n\n  // Speed at which to downshift from gear i to i-1\n  for (let i = 1; i < ratios.length; i++) {\n    const ratio = ratios[i];\n    const vDown = (omegaDown * wheelRadius) / (ratio * finalDrive);\n    downshiftSpeeds.push(vDown);\n  }\n\n  return {\n    upshiftSpeeds,\n    downshiftSpeeds,\n    hysteresis: 1.0,\n  };\n}\n\n/**\n * Controller for conventional diesel drivetrain.\n *\n * Controls:\n * - Engine torque based on speed error (proportional control)\n * - Gear selection based on speed schedule\n *\n * Works with drivetrains that have:\n * - One engine component\n * - One multi-speed gearbox\n */\nexport class ConventionalDieselController extends DrivetrainController {\n  readonly engineName: string;\n  readonly gearboxName: string;\n  readonly Kp: number;\n  shiftSchedule: GearShiftSchedule;\n  private _currentGear: number = 0;\n  private _engine: any;\n  private _gearbox: any;\n\n  constructor(\n    drivetrain: Drivetrain,\n    engineName: string = 'engine',\n    gearboxName: string = 'gearbox',\n    Kp: number = 50000.0,\n    shiftSchedule?: GearShiftSchedule\n  ) {\n    super(drivetrain);\n    this.engineName = engineName;\n    this.gearboxName = gearboxName;\n    this.Kp = Kp;\n\n    // Get component references\n    this._engine = drivetrain.getComponent(engineName);\n    this._gearbox = drivetrain.getComponent(gearboxName);\n\n    // Create shift schedule if not provided\n    if (shiftSchedule) {\n      this.shiftSchedule = shiftSchedule;\n    } else {\n      this._createDefaultSchedule();\n    }\n  }\n\n  private _createDefaultSchedule(): void {\n    const ratios = this._gearbox.params.ratios;\n\n    // Find vehicle component for wheel radius\n    let wheelRadius = 1.78;\n    let finalDrive = 16.0;\n\n    for (const comp of this.drivetrain.topology.components.values()) {\n      if ('params' in comp && 'rWheel' in (comp as any).params) {\n        wheelRadius = (comp as any).params.rWheel;\n      }\n      if (\n        comp.name.toLowerCase().includes('final') &&\n        'currentRatio' in (comp as any)\n      ) {\n        finalDrive = (comp as any).currentRatio;\n      }\n    }\n\n    this.shiftSchedule = createShiftSchedule(\n      ratios,\n      1500.0,\n      1000.0,\n      wheelRadius,\n      finalDrive\n    );\n  }\n\n  compute(state: Record<string, number>, grade: number): Record<string, number> {\n    // Get current velocity\n    const velocity = this.getVelocity(state);\n\n    // Get target velocity\n    const vTarget = this._targetVelocity ?? 10.0;\n\n    // Gear selection\n    const gear = this._selectGear(velocity, grade);\n    this._currentGear = gear;\n\n    // Engine torque (proportional speed control)\n    const vError = vTarget - velocity;\n    const tDemand = this.Kp * vError;\n\n    // Get engine torque after clipping\n    const tEngine = this._computeEngineTorque(state, tDemand);\n\n    return {\n      [`T_${this.engineName}`]: tEngine,\n      [`gear_${this.gearboxName}`]: gear,\n    };\n  }\n\n  private _selectGear(velocity: number, grade: number): number {\n    let gear = this._currentGear;\n    const nGears = this._gearbox.nGears;\n\n    // Consider grade in shift decisions\n    const gradeFactor = 1.0 - grade * 5.0; // Lower shift points on grades\n\n    // Check for upshift\n    if (gear < nGears - 1) {\n      const upshiftSpeed =\n        this.shiftSchedule.upshiftSpeeds[gear] * gradeFactor;\n      if (velocity > upshiftSpeed + this.shiftSchedule.hysteresis) {\n        gear = gear + 1;\n      }\n    }\n\n    // Check for downshift\n    if (gear > 0) {\n      const downshiftSpeed =\n        this.shiftSchedule.downshiftSpeeds[gear - 1] * gradeFactor;\n      if (velocity < downshiftSpeed - this.shiftSchedule.hysteresis) {\n        gear = gear - 1;\n      }\n    }\n\n    return gear;\n  }\n\n  private _computeEngineTorque(\n    state: Record<string, number>,\n    tDemand: number\n  ): number {\n    // Get engine speed from state\n    const engineSpeedKey = `${this.engineName}.shaft`;\n    let omegaE = 0.0;\n\n    // Look for engine speed in state\n    for (const [key, value] of Object.entries(state)) {\n      if (key.includes(engineSpeedKey) || key.includes(this.engineName)) {\n        omegaE = Math.abs(value);\n        break;\n      }\n    }\n\n    // If not found, estimate from vehicle speed\n    if (omegaE < 1.0) {\n      const velocity = this.getVelocity(state);\n      const gearRatio = this._gearbox.getRatio(this._currentGear);\n      const finalDrive = 16.0;\n      const wheelRadius = 1.78;\n      const omegaWheel = velocity / wheelRadius;\n      omegaE = omegaWheel * gearRatio * finalDrive;\n    }\n\n    // Convert to RPM and clip\n    const rpm = (omegaE * 30.0) / Math.PI;\n    const tClipped = this._engine.clipTorque(rpm, Math.max(0.0, tDemand));\n\n    return tClipped;\n  }\n\n  reset(): void {\n    this._currentGear = 0;\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 5933, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/control/speed-controller.ts"],"sourcesContent":["/**\n * Generic speed controller for any drivetrain type.\n */\n\nimport { Drivetrain } from '../core/drivetrain';\nimport { DrivetrainController } from './base';\n\n/**\n * Describes how to allocate torque demand among actuators.\n */\nexport interface TorqueAllocation {\n  /** Component names */\n  actuators: string[];\n  /** Fraction of demand for each */\n  fractions: number[];\n  /** Whether each is an engine (non-negative torque only) */\n  isEngine: boolean[];\n}\n\n/**\n * Generic proportional-integral speed controller.\n *\n * Works with any drivetrain by discovering actuators (engines, motors)\n * and distributing torque demand among them.\n */\nexport class SpeedController extends DrivetrainController {\n  readonly Kp: number;\n  readonly Ki: number;\n  allocation: TorqueAllocation;\n  private _integral: number = 0;\n  private _gearboxName: string | null = null;\n  private _currentGear: number = 0;\n\n  constructor(\n    drivetrain: Drivetrain,\n    Kp: number = 50000.0,\n    Ki: number = 5000.0,\n    allocation?: TorqueAllocation\n  ) {\n    super(drivetrain);\n    this.Kp = Kp;\n    this.Ki = Ki;\n\n    // Discover actuators if not specified\n    if (allocation) {\n      this.allocation = allocation;\n    } else {\n      this._discoverActuators();\n    }\n\n    // Find gearbox for gear control\n    this._gearboxName = this._findGearbox();\n  }\n\n  private _discoverActuators(): void {\n    const actuators: string[] = [];\n    const fractions: number[] = [];\n    const isEngine: boolean[] = [];\n\n    const components = this.drivetrain.topology.components;\n\n    // Find all engines and motors\n    for (const [name, comp] of components) {\n      const compType = comp.constructor.name;\n      if (compType.includes('Engine')) {\n        actuators.push(name);\n        isEngine.push(true);\n      } else if (compType.includes('Motor')) {\n        actuators.push(name);\n        isEngine.push(false);\n      }\n    }\n\n    if (actuators.length === 0) {\n      throw new Error('No actuators (engines/motors) found in drivetrain');\n    }\n\n    // Simple equal allocation\n    const n = actuators.length;\n    for (let i = 0; i < n; i++) {\n      fractions.push(1.0 / n);\n    }\n\n    this.allocation = { actuators, fractions, isEngine };\n  }\n\n  private _findGearbox(): string | null {\n    for (const [name, comp] of this.drivetrain.topology.components) {\n      if (comp.constructor.name.includes('Gearbox') && 'nGears' in comp) {\n        if ((comp as any).nGears > 1) {\n          return name;\n        }\n      }\n    }\n    return null;\n  }\n\n  compute(state: Record<string, number>, grade: number): Record<string, number> {\n    // Get current velocity\n    const velocity = this.getVelocity(state);\n\n    // Get target velocity\n    const vTarget = this._targetVelocity ?? 10.0;\n\n    // Speed error\n    const vError = vTarget - velocity;\n\n    // PI control\n    const tDemand = this.Kp * vError + this.Ki * this._integral;\n\n    // Update integral (with anti-windup)\n    if (Math.abs(this._integral) < 100.0) {\n      this._integral += vError * 0.1; // Assuming ~0.1s between calls\n    }\n\n    // Allocate torque among actuators\n    const controls = this._allocateTorque(state, tDemand);\n\n    // Add gear control if gearbox exists\n    if (this._gearboxName) {\n      const gear = this._selectGear(velocity, grade);\n      controls[`gear_${this._gearboxName}`] = gear;\n      this._currentGear = gear;\n    }\n\n    return controls;\n  }\n\n  private _allocateTorque(\n    state: Record<string, number>,\n    tDemand: number\n  ): Record<string, number> {\n    const controls: Record<string, number> = {};\n\n    for (let i = 0; i < this.allocation.actuators.length; i++) {\n      const actuator = this.allocation.actuators[i];\n      let tAlloc = tDemand * this.allocation.fractions[i];\n\n      // Engines can only provide positive torque\n      if (this.allocation.isEngine[i]) {\n        tAlloc = Math.max(0.0, tAlloc);\n      }\n\n      // Clip to actuator limits\n      const component = this.drivetrain.getComponent(actuator);\n      if (component && 'clipTorque' in component) {\n        // Get actuator speed\n        let omega = 0;\n        for (const [key, value] of Object.entries(state)) {\n          if (key.includes(actuator)) {\n            omega = Math.abs(value);\n            break;\n          }\n        }\n\n        const rpm = (omega * 30.0) / Math.PI;\n        tAlloc = (component as any).clipTorque(rpm, tAlloc);\n      }\n\n      controls[`T_${actuator}`] = tAlloc;\n    }\n\n    return controls;\n  }\n\n  private _selectGear(velocity: number, grade: number): number {\n    if (this._gearboxName === null) {\n      return 0;\n    }\n\n    const gearbox = this.drivetrain.getComponent(this._gearboxName) as any;\n    const nGears = gearbox.nGears;\n\n    // Simple speed-based selection\n    const vMax = 15.0; // Assumed max speed\n    const gearWidth = vMax / nGears;\n\n    let gear = Math.floor(velocity / gearWidth);\n    gear = Math.max(0, Math.min(gear, nGears - 1));\n\n    // Stay in lower gear on steep grades\n    if (grade > 0.05) {\n      gear = Math.max(0, gear - 1);\n    }\n    if (grade > 0.1) {\n      gear = 0;\n    }\n\n    return gear;\n  }\n\n  reset(): void {\n    this._integral = 0;\n    this._currentGear = 0;\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 6080, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/control/index.ts"],"sourcesContent":["/**\n * Control module exports.\n */\n\nexport { DrivetrainController } from './base';\n\nexport { ConventionalDieselController, createShiftSchedule } from './conventional';\nexport type { GearShiftSchedule } from './conventional';\n\nexport { SpeedController } from './speed-controller';\nexport type { TorqueAllocation } from './speed-controller';\n"],"names":[],"mappings":"AAAA;;CAEC;AAED;AAEA;AAGA","debugId":null}},
    {"offset": {"line": 6093, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/packages/drivetrain-sim/src/index.ts"],"sourcesContent":["/**\n * Drivetrain Simulation Library\n *\n * A TypeScript library for simulating vehicle drivetrains including\n * conventional diesel, hybrid, and eCVT configurations.\n */\n\n// Core exports\nexport * from './core';\n\n// Component exports\nexport * from './components';\n\n// Math utilities\nexport * from './math';\n\n// Simulation exports\nexport * from './simulation';\n\n// Control exports\nexport * from './control';\n"],"names":[],"mappings":"AAAA;;;;;CAKC,GAED,eAAe;;AACf;AAEA,oBAAoB;AACpB;AAEA,iBAAiB;AACjB;AAEA,qBAAqB;AACrB;AAEA,kBAAkB;AAClB","debugId":null}},
    {"offset": {"line": 6312, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/hooks/useSimulation.ts"],"sourcesContent":["\"use client\";\n\nimport { useCallback } from \"react\";\nimport { type Node, type Edge } from \"@xyflow/react\";\nimport type { BaseNodeData } from \"@/stores/drivetrain-store\";\nimport { useSimulationStore, type SimResult, type RimpullCurve, type RimpullPoint } from \"@/stores/simulation-store\";\n\nimport {\n  DrivetrainTopology,\n  EngineComponent,\n  MotorComponent,\n  NSpeedGearboxComponent,\n  FinalDriveComponent,\n  PlanetaryGearComponent,\n  BatteryComponent,\n  VehicleComponent,\n  DrivetrainSimulator,\n  SpeedController,\n  type SimulationConfig,\n} from \"drivetrain-sim\";\n\n/**\n * Port name mapping from React Flow handles to simulation library ports.\n */\nconst HANDLE_TO_PORT: Record<string, Record<string, string>> = {\n  engine: { shaft: \"shaft\" },\n  motor: { shaft: \"shaft\", \"shaft-in\": \"shaft\", \"shaft-out\": \"shaft\", electrical: \"electrical\" },\n  gearbox: { input: \"input\", output: \"output\" },\n  planetary: { sun: \"sun\", carrier: \"carrier\", ring: \"ring\" },\n  battery: { electrical: \"electrical\" },\n  vehicle: { wheels: \"wheels\" },\n};\n\n/**\n * Create a component instance from node data.\n */\nfunction createComponent(\n  nodeData: BaseNodeData\n): import(\"drivetrain-sim\").DrivetrainComponent | null {\n  const { componentType, params } = nodeData;\n\n  try {\n    switch (componentType) {\n      case \"engine\": {\n        return new EngineComponent({\n          jEngine: 200,\n          rpmIdle: params.rpmIdle as number,\n          rpmMax: params.rpmMax as number,\n          pRated: params.pRated as number,\n          tPeak: params.tPeak as number,\n        });\n      }\n\n      case \"motor\": {\n        return new MotorComponent({\n          jRotor: 10,\n          pMax: params.pMax as number,\n          tMax: params.tMax as number,\n          rpmMax: params.rpmMax as number,\n          eta: params.eta as number,\n        });\n      }\n\n      case \"gearbox\": {\n        const ratios = params.ratios as number[];\n        const efficiencies = params.efficiencies as number[];\n        return new NSpeedGearboxComponent({\n          ratios: ratios,\n          efficiencies: efficiencies,\n          jInput: 50,\n          jOutput: 100,\n        });\n      }\n\n      case \"planetary\": {\n        return new PlanetaryGearComponent({\n          zSun: params.zSun as number,\n          zRing: params.zRing as number,\n          jSun: 5,\n          jCarrier: 150,\n          jRing: 10,\n        });\n      }\n\n      case \"battery\": {\n        return new BatteryComponent({\n          capacityKwh: params.capacityKwh as number,\n          vNom: params.vNom as number,\n          pMaxDischarge: params.pMaxDischarge as number,\n          pMaxCharge: params.pMaxCharge as number,\n          socInit: params.socInit as number,\n        });\n      }\n\n      case \"vehicle\": {\n        return new VehicleComponent({\n          mEmpty: params.mEmpty as number,\n          mPayload: params.mPayload as number,\n          rWheel: params.rWheel as number,\n          cR: params.cR as number,\n          rhoAir: 1.225,\n          cD: 0.8,\n          aFrontal: 50,\n        });\n      }\n\n      default:\n        console.warn(`Unknown component type: ${componentType}`);\n        return null;\n    }\n  } catch (error) {\n    console.error(`Error creating ${componentType} component:`, error);\n    return null;\n  }\n}\n\n/**\n * Convert React Flow nodes and edges to a DrivetrainTopology.\n */\nfunction buildTopology(\n  nodes: Node<BaseNodeData>[],\n  edges: Edge[]\n): DrivetrainTopology {\n  const topology = new DrivetrainTopology();\n\n  // Add all components\n  for (const node of nodes) {\n    const component = createComponent(node.data);\n    if (component) {\n      topology.addComponent(node.id, component);\n    }\n  }\n\n  // Add connections (only mechanical for now)\n  for (const edge of edges) {\n    if (edge.type === \"electrical\") {\n      // Electrical connections are handled via bus\n      continue;\n    }\n\n    const sourceNode = nodes.find((n) => n.id === edge.source);\n    const targetNode = nodes.find((n) => n.id === edge.target);\n\n    if (!sourceNode || !targetNode) continue;\n\n    const sourcePortMap = HANDLE_TO_PORT[sourceNode.data.componentType];\n    const targetPortMap = HANDLE_TO_PORT[targetNode.data.componentType];\n\n    if (!sourcePortMap || !targetPortMap) continue;\n\n    const sourcePort = sourcePortMap[edge.sourceHandle || \"\"] || edge.sourceHandle;\n    const targetPort = targetPortMap[edge.targetHandle || \"\"] || edge.targetHandle;\n\n    if (sourcePort && targetPort) {\n      try {\n        topology.connect(edge.source, sourcePort, edge.target, targetPort);\n      } catch (e) {\n        console.warn(`Connection failed: ${edge.source}.${sourcePort} -> ${edge.target}.${targetPort}`, e);\n      }\n    }\n  }\n\n  // Set output to vehicle.wheels\n  const vehicleNode = nodes.find((n) => n.data.componentType === \"vehicle\");\n  if (vehicleNode) {\n    topology.setOutput(vehicleNode.id, \"wheels\");\n  }\n\n  return topology;\n}\n\n/**\n * Compute rimpull curves for the drivetrain.\n *\n * Detects topology type and calculates appropriately:\n * - Diesel: Engine → Gearbox → Vehicle (conventional)\n * - eCVT: Engine + Motors + Planetary → Gearbox → Vehicle\n */\nfunction computeRimpull(\n  nodes: Node<BaseNodeData>[],\n  edges: Edge[]\n): RimpullCurve[] {\n  const curves: RimpullCurve[] = [];\n\n  // Find key components\n  const engineNode = nodes.find((n) => n.data.componentType === \"engine\");\n  const motorNodes = nodes.filter((n) => n.data.componentType === \"motor\");\n  const planetaryNode = nodes.find((n) => n.data.componentType === \"planetary\");\n  const gearboxNode = nodes.find((n) => n.data.componentType === \"gearbox\");\n  const vehicleNode = nodes.find((n) => n.data.componentType === \"vehicle\");\n\n  if (!vehicleNode) {\n    return curves;\n  }\n\n  const vehicleParams = vehicleNode.data.params;\n  const rWheel = (vehicleParams.rWheel as number) || 1.78;\n  const mTotal =\n    ((vehicleParams.mEmpty as number) || 159350) +\n    ((vehicleParams.mPayload as number) || 190000);\n  const cR = (vehicleParams.cR as number) || 0.025;\n\n  // Detect topology type\n  const isECVT = planetaryNode && motorNodes.length >= 1;\n\n  if (isECVT && engineNode) {\n    // eCVT topology: Engine + Planetary + Motors\n    curves.push(...computeECVTRimpull(\n      engineNode, motorNodes, planetaryNode!, gearboxNode, vehicleParams, rWheel\n    ));\n  } else if (engineNode) {\n    // Diesel topology: Engine → Gearbox → Vehicle\n    curves.push(...computeDieselRimpull(\n      engineNode, gearboxNode, vehicleParams, rWheel\n    ));\n  } else if (motorNodes.length > 0) {\n    // Pure electric: Motor → Gearbox → Vehicle\n    curves.push(...computeElectricRimpull(\n      motorNodes, gearboxNode, vehicleParams, rWheel\n    ));\n  }\n\n  // Add resistance curves\n  addResistanceCurves(curves, mTotal, cR);\n\n  return curves;\n}\n\n/**\n * Compute rimpull for conventional diesel drivetrain.\n */\nfunction computeDieselRimpull(\n  engineNode: Node<BaseNodeData>,\n  gearboxNode: Node<BaseNodeData> | undefined,\n  vehicleParams: Record<string, unknown>,\n  rWheel: number\n): RimpullCurve[] {\n  const curves: RimpullCurve[] = [];\n  const engineParams = engineNode.data.params;\n\n  // Engine parameters\n  const tPeak = (engineParams.tPeak as number) || 11220;\n  const pRated = (engineParams.pRated as number) || 1801000;\n  const rpmIdle = (engineParams.rpmIdle as number) || 700;\n  const rpmMax = (engineParams.rpmMax as number) || 1800;\n\n  // Base speed where power limiting begins\n  const omegaBase = pRated / tPeak;\n\n  // Final drive ratio (hardcoded for CAT 793D)\n  const finalDrive = 16.0;\n  const efficiency = 0.92;\n\n  // Get gear ratios\n  const gearRatios = gearboxNode\n    ? (gearboxNode.data.params.ratios as number[]) || [1.0]\n    : [1.0];\n\n  const gearColors = [\n    \"#ef4444\", \"#f97316\", \"#eab308\", \"#22c55e\",\n    \"#06b6d4\", \"#3b82f6\", \"#8b5cf6\"\n  ];\n\n  for (let g = 0; g < gearRatios.length; g++) {\n    const ratio = gearRatios[g];\n    const points: RimpullPoint[] = [];\n    const totalRatio = ratio * finalDrive;\n\n    const vMin = (rpmIdle * Math.PI / 30) / totalRatio * rWheel;\n    const vMax = (rpmMax * Math.PI / 30) / totalRatio * rWheel;\n\n    const numPoints = 50;\n    for (let i = 0; i <= numPoints; i++) {\n      const velocity = vMin + (vMax - vMin) * (i / numPoints);\n      const omegaWheel = velocity / rWheel;\n      const omegaEngine = omegaWheel * totalRatio;\n\n      let torque: number;\n      if (omegaEngine <= omegaBase) {\n        torque = tPeak;\n      } else {\n        torque = pRated / omegaEngine;\n      }\n\n      const force = (torque * totalRatio * efficiency) / rWheel;\n      points.push({ velocity, force, gear: g + 1 });\n    }\n\n    curves.push({\n      name: `Gear ${g + 1} (${ratio.toFixed(2)}:1)`,\n      points,\n      color: gearColors[g % gearColors.length],\n    });\n  }\n\n  return curves;\n}\n\n/**\n * Compute rimpull for eCVT (power-split hybrid) drivetrain.\n * Uses Willis equation: ω_sun = (1+ρ)·ω_carrier - ρ·ω_ring\n */\nfunction computeECVTRimpull(\n  engineNode: Node<BaseNodeData>,\n  motorNodes: Node<BaseNodeData>[],\n  planetaryNode: Node<BaseNodeData>,\n  gearboxNode: Node<BaseNodeData> | undefined,\n  vehicleParams: Record<string, unknown>,\n  rWheel: number\n): RimpullCurve[] {\n  const curves: RimpullCurve[] = [];\n\n  // Engine parameters\n  const engineParams = engineNode.data.params;\n  const rpmEngineMin = (engineParams.rpmIdle as number) || 700;\n  const rpmEngineMax = (engineParams.rpmMax as number) || 1800;\n  const tEngineMax = (engineParams.tPeak as number) || 11220;\n\n  // Planetary ratio: ρ = Z_ring / Z_sun\n  const planetaryParams = planetaryNode.data.params;\n  const zSun = (planetaryParams.zSun as number) || 30;\n  const zRing = (planetaryParams.zRing as number) || 90;\n  const rho = zRing / zSun; // typically 3.0\n\n  // Motor parameters (find MG1 and MG2)\n  // MG1 is typically lower power (reaction motor), MG2 is higher power (traction motor)\n  const sortedMotors = [...motorNodes].sort((a, b) =>\n    ((a.data.params.pMax as number) || 0) - ((b.data.params.pMax as number) || 0)\n  );\n\n  const mg1Params = sortedMotors[0]?.data.params || {};\n  const mg2Params = sortedMotors[1]?.data.params || sortedMotors[0]?.data.params || {};\n\n  const pMG1Max = (mg1Params.pMax as number) || 200000;\n  const tMG1Max = (mg1Params.tMax as number) || 3000;\n  const rpmMG1Max = (mg1Params.rpmMax as number) || 6000;\n\n  const pMG2Max = (mg2Params.pMax as number) || 350000;\n  const tMG2Max = (mg2Params.tMax as number) || 2000;\n  const rpmMG2Max = (mg2Params.rpmMax as number) || 6000;\n  const pMG2Boost = (mg2Params.pBoost as number) || pMG2Max;\n\n  // Gearbox ratios (2-speed for eCVT)\n  const gearRatios = gearboxNode\n    ? (gearboxNode.data.params.ratios as number[]) || [5.0, 0.67]\n    : [5.0, 0.67];\n  const gearEfficiencies = gearboxNode\n    ? (gearboxNode.data.params.efficiencies as number[]) || [0.97, 0.97]\n    : [0.97, 0.97];\n\n  // Final drive (typically included in gearbox total ratio for eCVT)\n  const finalDrive = 16.0;\n\n  // Speed range (0 to 60 km/h)\n  const numPoints = 200;\n  const vMax = 60 / 3.6; // 60 km/h in m/s\n\n  const gearColors = [\"#3b82f6\", \"#ef4444\"]; // Blue for low, red for high\n\n  for (let g = 0; g < Math.min(gearRatios.length, 2); g++) {\n    const gearRatio = gearRatios[g];\n    const eta = gearEfficiencies[g] || 0.97;\n    const kTotal = gearRatio * finalDrive;\n    const points: RimpullPoint[] = [];\n\n    for (let i = 1; i <= numPoints; i++) {\n      const velocity = (vMax * i) / numPoints;\n\n      // Ring speed from vehicle speed (ring connects to gearbox input)\n      const omegaRing = (velocity / rWheel) * kTotal;\n      const rpmRing = (omegaRing * 30) / Math.PI;\n\n      // Check MG2 speed limit (MG2 is on ring)\n      if (rpmRing > rpmMG2Max) {\n        points.push({ velocity, force: 0, gear: g + 1 });\n        continue;\n      }\n\n      // Optimal engine speed (near peak torque, ~1200 rpm)\n      let rpmEngine = 1200;\n      let omegaEngine = (rpmEngine * Math.PI) / 30;\n\n      // MG1 speed from Willis equation: ω_sun = (1+ρ)·ω_carrier - ρ·ω_ring\n      // Engine is on carrier, MG1 is on sun\n      let omegaMG1 = (1 + rho) * omegaEngine - rho * omegaRing;\n      let rpmMG1 = (omegaMG1 * 30) / Math.PI;\n\n      // Check MG1 speed limits and adjust engine speed if needed\n      if (Math.abs(rpmMG1) > rpmMG1Max) {\n        // Limit MG1 speed and recalculate engine speed\n        const omegaMG1Limit = (rpmMG1 > 0 ? rpmMG1Max : -rpmMG1Max) * Math.PI / 30;\n        omegaEngine = (omegaMG1Limit + rho * omegaRing) / (1 + rho);\n        rpmEngine = (omegaEngine * 30) / Math.PI;\n        omegaMG1 = omegaMG1Limit;\n        rpmMG1 = (omegaMG1 * 30) / Math.PI;\n      }\n\n      // Clamp engine to valid range\n      rpmEngine = Math.max(rpmEngineMin, Math.min(rpmEngineMax, rpmEngine));\n      omegaEngine = (rpmEngine * Math.PI) / 30;\n      omegaMG1 = (1 + rho) * omegaEngine - rho * omegaRing;\n      rpmMG1 = (omegaMG1 * 30) / Math.PI;\n\n      // Get max torques\n      // Engine max torque (could be power-limited)\n      const omegaBase = (1801000) / tEngineMax; // power/torque\n      let tEngineAvail = omegaEngine <= omegaBase\n        ? tEngineMax\n        : 1801000 / omegaEngine;\n\n      // MG1 max torque (power-limited at high speed)\n      const omegaMG1Base = pMG1Max / tMG1Max;\n      const tMG1MaxAtSpeed = Math.abs(omegaMG1) <= omegaMG1Base\n        ? tMG1Max\n        : pMG1Max / Math.abs(omegaMG1);\n\n      // MG2 max torque (with boost)\n      const omegaMG2Base = pMG2Boost / tMG2Max;\n      const tMG2MaxAtSpeed = omegaRing <= omegaMG2Base\n        ? tMG2Max\n        : pMG2Boost / omegaRing;\n\n      // MG1 must react engine torque: T_MG1 = -T_engine / (1+ρ)\n      // So max engine torque is limited by MG1 capacity\n      const tEngineLimited = Math.min(tEngineAvail, (1 + rho) * tMG1MaxAtSpeed);\n\n      // MG1 reaction torque\n      const tMG1 = -tEngineLimited / (1 + rho);\n\n      // Ring torque from engine path (through planetary)\n      // T_ring_from_engine = -ρ × T_MG1 = ρ/(1+ρ) × T_engine\n      const tRingFromEngine = -rho * tMG1;\n\n      // Total ring torque = engine contribution + MG2 contribution\n      const tRingTotal = tRingFromEngine + tMG2MaxAtSpeed;\n\n      // Wheel torque and rimpull\n      const tWheel = tRingTotal * kTotal * eta;\n      const force = tWheel / rWheel;\n\n      points.push({ velocity, force: Math.max(0, force), gear: g + 1 });\n    }\n\n    const gearName = g === 0 ? \"Low Gear\" : \"High Gear\";\n    curves.push({\n      name: `${gearName} (${gearRatio.toFixed(2)}:1)`,\n      points,\n      color: gearColors[g],\n    });\n  }\n\n  return curves;\n}\n\n/**\n * Compute rimpull for pure electric drivetrain.\n */\nfunction computeElectricRimpull(\n  motorNodes: Node<BaseNodeData>[],\n  gearboxNode: Node<BaseNodeData> | undefined,\n  vehicleParams: Record<string, unknown>,\n  rWheel: number\n): RimpullCurve[] {\n  const curves: RimpullCurve[] = [];\n\n  // Use the most powerful motor\n  const motorNode = motorNodes.reduce((a, b) =>\n    ((a.data.params.pMax as number) || 0) > ((b.data.params.pMax as number) || 0) ? a : b\n  );\n  const motorParams = motorNode.data.params;\n\n  const pMax = (motorParams.pMax as number) || 350000;\n  const tMax = (motorParams.tMax as number) || 3000;\n  const rpmMax = (motorParams.rpmMax as number) || 6000;\n  const eta = (motorParams.eta as number) || 0.92;\n\n  const omegaBase = pMax / tMax;\n  const finalDrive = 16.0;\n\n  const gearRatios = gearboxNode\n    ? (gearboxNode.data.params.ratios as number[]) || [1.0]\n    : [1.0];\n\n  const gearColors = [\"#3b82f6\", \"#22c55e\", \"#f97316\"];\n\n  for (let g = 0; g < gearRatios.length; g++) {\n    const ratio = gearRatios[g];\n    const totalRatio = ratio * finalDrive;\n    const points: RimpullPoint[] = [];\n\n    const vMax = (rpmMax * Math.PI / 30) / totalRatio * rWheel;\n    const numPoints = 50;\n\n    for (let i = 1; i <= numPoints; i++) {\n      const velocity = (vMax * i) / numPoints;\n      const omegaWheel = velocity / rWheel;\n      const omegaMotor = omegaWheel * totalRatio;\n\n      let torque: number;\n      if (omegaMotor <= omegaBase) {\n        torque = tMax;\n      } else {\n        torque = pMax / omegaMotor;\n      }\n\n      const force = (torque * totalRatio * eta) / rWheel;\n      points.push({ velocity, force, gear: g + 1 });\n    }\n\n    curves.push({\n      name: `Gear ${g + 1} (${ratio.toFixed(2)}:1)`,\n      points,\n      color: gearColors[g % gearColors.length],\n    });\n  }\n\n  return curves;\n}\n\n/**\n * Add resistance curves (rolling + grade) to the curves array.\n */\nfunction addResistanceCurves(\n  curves: RimpullCurve[],\n  mTotal: number,\n  cR: number\n): void {\n  const g_accel = 9.81;\n  const grades = [0, 0.05, 0.10, 0.15];\n  const gradeColors = [\"#555555\", \"#666666\", \"#888888\", \"#aaaaaa\"];\n  const maxSpeed = 60 / 3.6;\n\n  for (let gi = 0; gi < grades.length; gi++) {\n    const grade = grades[gi];\n    const gradePoints: RimpullPoint[] = [];\n\n    for (let i = 0; i <= 30; i++) {\n      const v = (maxSpeed * i) / 30;\n      const f_rolling = mTotal * g_accel * cR;\n      const f_grade = mTotal * g_accel * Math.sin(Math.atan(grade));\n      gradePoints.push({ velocity: v, force: f_rolling + f_grade });\n    }\n\n    const label = grade === 0\n      ? \"Rolling Resistance (0% grade)\"\n      : `Resistance (${(grade * 100).toFixed(0)}% grade)`;\n\n    curves.push({\n      name: label,\n      points: gradePoints,\n      color: gradeColors[gi],\n    });\n  }\n}\n\n/**\n * Hook for running drivetrain simulations.\n */\nexport function useSimulation() {\n  const setStatus = useSimulationStore((s) => s.setStatus);\n  const setProgress = useSimulationStore((s) => s.setProgress);\n  const setResult = useSimulationStore((s) => s.setResult);\n  const setRimpullCurves = useSimulationStore((s) => s.setRimpullCurves);\n  const setError = useSimulationStore((s) => s.setError);\n  const config = useSimulationStore((s) => s.config);\n\n  const runSimulation = useCallback(\n    async (nodes: Node<BaseNodeData>[], edges: Edge[]) => {\n      console.log(\"useSimulation: runSimulation called\");\n      setStatus(\"running\");\n      setProgress(0);\n      setError(null);\n\n      try {\n        // Build topology\n        console.log(\"Building topology...\");\n        const topology = buildTopology(nodes, edges);\n        console.log(\"Topology built:\", topology.toString());\n\n        // Compile drivetrain\n        console.log(\"Compiling drivetrain...\");\n        const drivetrain = topology.build();\n        console.log(\"Drivetrain compiled, states:\", drivetrain.stateNames);\n\n        // Create simulator\n        console.log(\"Creating simulator...\");\n        const simulator = new DrivetrainSimulator(drivetrain);\n\n        // Create controller\n        console.log(\"Creating controller...\");\n        const controller = new SpeedController(drivetrain, 50000, 5000);\n        controller.targetVelocity = config.targetVelocity;\n        console.log(\"Target velocity:\", config.targetVelocity);\n\n        // Initial state (zero velocities)\n        const x0: Record<string, number> = {};\n        for (const name of drivetrain.stateNames) {\n          x0[name] = 0;\n        }\n        console.log(\"Initial state:\", x0);\n\n        // Simulation config\n        const simConfig: SimulationConfig = {\n          tStart: 0,\n          tEnd: config.tEnd,\n          dtOutput: config.dtOutput,\n          method: \"RK4\",\n          rtol: 1e-6,\n          atol: 1e-8,\n          maxStep: 0.01,\n        };\n        console.log(\"Simulation config:\", simConfig);\n\n        // Run simulation with progress\n        console.log(\"Starting simulation...\");\n        const result = await simulator.simulateWithProgress(\n          x0,\n          controller,\n          config.grade,\n          simConfig,\n          (progress) => {\n            setProgress(progress);\n          }\n        );\n        console.log(\"Simulation complete, points:\", result.time.length);\n\n        // Convert to UI format\n        const simResult: SimResult = {\n          time: result.time,\n          velocity: result.outputs.velocity || [],\n          grade: result.outputs.grade || new Array(result.time.length).fill(config.grade),\n          fuelRate: result.outputs.fuel_rate,\n          enginePower: Object.entries(result.outputs)\n            .find(([k]) => k.startsWith(\"P_engine\"))?.[1],\n          motorPower: Object.entries(result.outputs)\n            .find(([k]) => k.startsWith(\"P_motor\"))?.[1],\n        };\n\n        // Check for SOC in states\n        for (const [key, values] of Object.entries(result.states)) {\n          if (key.toLowerCase().includes(\"soc\") || key.toLowerCase().includes(\"battery\")) {\n            simResult.soc = values;\n            break;\n          }\n        }\n\n        setResult(simResult);\n        setStatus(\"completed\");\n      } catch (error) {\n        console.error(\"Simulation failed:\", error);\n        setError(error instanceof Error ? error.message : \"Simulation failed\");\n        setStatus(\"error\");\n      }\n    },\n    [config, setStatus, setProgress, setResult, setError]\n  );\n\n  const calculateRimpull = useCallback(\n    (nodes: Node<BaseNodeData>[], edges: Edge[]) => {\n      try {\n        const curves = computeRimpull(nodes, edges);\n        setRimpullCurves(curves);\n      } catch (error) {\n        console.error(\"Rimpull calculation failed:\", error);\n      }\n    },\n    [setRimpullCurves]\n  );\n\n  return {\n    runSimulation,\n    calculateRimpull,\n  };\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 6900, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/components/charts/SimulationChart.tsx"],"sourcesContent":["\"use client\";\n\nimport dynamic from \"next/dynamic\";\n\n// Dynamically import Plotly to avoid SSR issues\nconst Plot = dynamic(() => import(\"react-plotly.js\"), { ssr: false });\n\ninterface SimulationChartProps {\n  time: number[];\n  velocity: number[];\n  grade?: number[];\n  fuelRate?: number[];\n  enginePower?: number[];\n  motorPower?: number[];\n}\n\nexport function SimulationChart({\n  time,\n  velocity,\n  grade,\n  fuelRate,\n  enginePower,\n  motorPower,\n}: SimulationChartProps) {\n  // Convert velocity to km/h\n  const velocityKmh = velocity.map((v) => v * 3.6);\n\n  // Build traces\n  const traces: Plotly.Data[] = [\n    {\n      x: time,\n      y: velocityKmh,\n      type: \"scatter\",\n      mode: \"lines\",\n      name: \"Velocity (km/h)\",\n      line: { color: \"#22c55e\", width: 2 },\n      yaxis: \"y\",\n    },\n  ];\n\n  // Add engine power if available\n  if (enginePower && enginePower.some((p) => p !== 0)) {\n    const powerKw = enginePower.map((p) => p / 1000);\n    traces.push({\n      x: time,\n      y: powerKw,\n      type: \"scatter\",\n      mode: \"lines\",\n      name: \"Engine Power (kW)\",\n      line: { color: \"#f97316\", width: 2 },\n      yaxis: \"y2\",\n    });\n  }\n\n  // Add motor power if available\n  if (motorPower && motorPower.some((p) => p !== 0)) {\n    const powerKw = motorPower.map((p) => p / 1000);\n    traces.push({\n      x: time,\n      y: powerKw,\n      type: \"scatter\",\n      mode: \"lines\",\n      name: \"Motor Power (kW)\",\n      line: { color: \"#3b82f6\", width: 2, dash: \"dash\" },\n      yaxis: \"y2\",\n    });\n  }\n\n  // Add fuel rate if available\n  if (fuelRate && fuelRate.some((f) => f !== 0)) {\n    const fuelKgH = fuelRate.map((f) => f * 3600);\n    traces.push({\n      x: time,\n      y: fuelKgH,\n      type: \"scatter\",\n      mode: \"lines\",\n      name: \"Fuel Rate (kg/h)\",\n      line: { color: \"#ef4444\", width: 1.5, dash: \"dot\" },\n      yaxis: \"y3\",\n    });\n  }\n\n  const layout: Partial<Plotly.Layout> = {\n    title: \"\",\n    autosize: true,\n    margin: { t: 20, r: 80, b: 50, l: 60 },\n    paper_bgcolor: \"transparent\",\n    plot_bgcolor: \"transparent\",\n    font: { color: \"#888\" },\n    xaxis: {\n      title: \"Time (s)\",\n      gridcolor: \"#333\",\n      zerolinecolor: \"#444\",\n    },\n    yaxis: {\n      title: \"Velocity (km/h)\",\n      titlefont: { color: \"#22c55e\" },\n      tickfont: { color: \"#22c55e\" },\n      gridcolor: \"#333\",\n      zerolinecolor: \"#444\",\n      side: \"left\",\n    },\n    yaxis2: {\n      title: \"Power (kW)\",\n      titlefont: { color: \"#f97316\" },\n      tickfont: { color: \"#f97316\" },\n      overlaying: \"y\",\n      side: \"right\",\n      showgrid: false,\n    },\n    yaxis3: {\n      title: \"Fuel (kg/h)\",\n      titlefont: { color: \"#ef4444\" },\n      tickfont: { color: \"#ef4444\" },\n      overlaying: \"y\",\n      side: \"right\",\n      position: 0.95,\n      showgrid: false,\n    },\n    legend: {\n      x: 0,\n      y: 1.1,\n      orientation: \"h\",\n      bgcolor: \"transparent\",\n    },\n    showlegend: true,\n  };\n\n  const config: Partial<Plotly.Config> = {\n    displayModeBar: false,\n    responsive: true,\n  };\n\n  return (\n    <div className=\"w-full h-full min-h-[180px]\">\n      <Plot\n        data={traces}\n        layout={layout}\n        config={config}\n        useResizeHandler\n        style={{ width: \"100%\", height: \"100%\" }}\n      />\n    </div>\n  );\n}\n"],"names":[],"mappings":";;;;;AAEA;;AAFA;;;AAIA,gDAAgD;AAChD,MAAM,OAAO,IAAA,0KAAO;;;;;;IAAoC,KAAK;;AAWtD,SAAS,gBAAgB,EAC9B,IAAI,EACJ,QAAQ,EACR,KAAK,EACL,QAAQ,EACR,WAAW,EACX,UAAU,EACW;IACrB,2BAA2B;IAC3B,MAAM,cAAc,SAAS,GAAG,CAAC,CAAC,IAAM,IAAI;IAE5C,eAAe;IACf,MAAM,SAAwB;QAC5B;YACE,GAAG;YACH,GAAG;YACH,MAAM;YACN,MAAM;YACN,MAAM;YACN,MAAM;gBAAE,OAAO;gBAAW,OAAO;YAAE;YACnC,OAAO;QACT;KACD;IAED,gCAAgC;IAChC,IAAI,eAAe,YAAY,IAAI,CAAC,CAAC,IAAM,MAAM,IAAI;QACnD,MAAM,UAAU,YAAY,GAAG,CAAC,CAAC,IAAM,IAAI;QAC3C,OAAO,IAAI,CAAC;YACV,GAAG;YACH,GAAG;YACH,MAAM;YACN,MAAM;YACN,MAAM;YACN,MAAM;gBAAE,OAAO;gBAAW,OAAO;YAAE;YACnC,OAAO;QACT;IACF;IAEA,+BAA+B;IAC/B,IAAI,cAAc,WAAW,IAAI,CAAC,CAAC,IAAM,MAAM,IAAI;QACjD,MAAM,UAAU,WAAW,GAAG,CAAC,CAAC,IAAM,IAAI;QAC1C,OAAO,IAAI,CAAC;YACV,GAAG;YACH,GAAG;YACH,MAAM;YACN,MAAM;YACN,MAAM;YACN,MAAM;gBAAE,OAAO;gBAAW,OAAO;gBAAG,MAAM;YAAO;YACjD,OAAO;QACT;IACF;IAEA,6BAA6B;IAC7B,IAAI,YAAY,SAAS,IAAI,CAAC,CAAC,IAAM,MAAM,IAAI;QAC7C,MAAM,UAAU,SAAS,GAAG,CAAC,CAAC,IAAM,IAAI;QACxC,OAAO,IAAI,CAAC;YACV,GAAG;YACH,GAAG;YACH,MAAM;YACN,MAAM;YACN,MAAM;YACN,MAAM;gBAAE,OAAO;gBAAW,OAAO;gBAAK,MAAM;YAAM;YAClD,OAAO;QACT;IACF;IAEA,MAAM,SAAiC;QACrC,OAAO;QACP,UAAU;QACV,QAAQ;YAAE,GAAG;YAAI,GAAG;YAAI,GAAG;YAAI,GAAG;QAAG;QACrC,eAAe;QACf,cAAc;QACd,MAAM;YAAE,OAAO;QAAO;QACtB,OAAO;YACL,OAAO;YACP,WAAW;YACX,eAAe;QACjB;QACA,OAAO;YACL,OAAO;YACP,WAAW;gBAAE,OAAO;YAAU;YAC9B,UAAU;gBAAE,OAAO;YAAU;YAC7B,WAAW;YACX,eAAe;YACf,MAAM;QACR;QACA,QAAQ;YACN,OAAO;YACP,WAAW;gBAAE,OAAO;YAAU;YAC9B,UAAU;gBAAE,OAAO;YAAU;YAC7B,YAAY;YACZ,MAAM;YACN,UAAU;QACZ;QACA,QAAQ;YACN,OAAO;YACP,WAAW;gBAAE,OAAO;YAAU;YAC9B,UAAU;gBAAE,OAAO;YAAU;YAC7B,YAAY;YACZ,MAAM;YACN,UAAU;YACV,UAAU;QACZ;QACA,QAAQ;YACN,GAAG;YACH,GAAG;YACH,aAAa;YACb,SAAS;QACX;QACA,YAAY;IACd;IAEA,MAAM,SAAiC;QACrC,gBAAgB;QAChB,YAAY;IACd;IAEA,qBACE,8OAAC;QAAI,WAAU;kBACb,cAAA,8OAAC;YACC,MAAM;YACN,QAAQ;YACR,QAAQ;YACR,gBAAgB;YAChB,OAAO;gBAAE,OAAO;gBAAQ,QAAQ;YAAO;;;;;;;;;;;AAI/C","debugId":null}},
    {"offset": {"line": 7081, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/components/charts/RimpullChart.tsx"],"sourcesContent":["\"use client\";\n\nimport dynamic from \"next/dynamic\";\nimport type { RimpullCurve } from \"@/stores/simulation-store\";\n\n// Dynamically import Plotly to avoid SSR issues\nconst Plot = dynamic(() => import(\"react-plotly.js\"), { ssr: false });\n\ninterface RimpullChartProps {\n  curves: RimpullCurve[];\n}\n\nexport function RimpullChart({ curves }: RimpullChartProps) {\n  if (curves.length === 0) {\n    return (\n      <div className=\"w-full h-full flex items-center justify-center text-muted\">\n        No rimpull data available\n      </div>\n    );\n  }\n\n  // Convert to Plotly traces\n  const traces: Plotly.Data[] = curves.map((curve) => ({\n    x: curve.points.map((p) => p.velocity * 3.6), // Convert to km/h\n    y: curve.points.map((p) => p.force / 1000), // Convert to kN\n    type: \"scatter\",\n    mode: \"lines\",\n    name: curve.name,\n    line: {\n      color: curve.color,\n      width: curve.name.includes(\"Resistance\") ? 1.5 : 2.5,\n      dash: curve.name.includes(\"Resistance\") ? \"dash\" : \"solid\",\n    },\n    fill: curve.name.includes(\"Resistance\") ? undefined : \"tozeroy\",\n    fillcolor: curve.name.includes(\"Resistance\")\n      ? undefined\n      : `${curve.color}15`,\n  }));\n\n  const layout: Partial<Plotly.Layout> = {\n    title: \"\",\n    autosize: true,\n    margin: { t: 20, r: 40, b: 50, l: 60 },\n    paper_bgcolor: \"transparent\",\n    plot_bgcolor: \"transparent\",\n    font: { color: \"#888\" },\n    xaxis: {\n      title: \"Speed (km/h)\",\n      gridcolor: \"#333\",\n      zerolinecolor: \"#444\",\n      range: [0, 60],\n    },\n    yaxis: {\n      title: \"Tractive Force (kN)\",\n      gridcolor: \"#333\",\n      zerolinecolor: \"#444\",\n      range: [0, null],\n    },\n    legend: {\n      x: 1,\n      xanchor: \"right\",\n      y: 1,\n      bgcolor: \"rgba(0,0,0,0.5)\",\n    },\n    showlegend: true,\n    hovermode: \"closest\",\n  };\n\n  const config: Partial<Plotly.Config> = {\n    displayModeBar: false,\n    responsive: true,\n  };\n\n  return (\n    <div className=\"w-full h-full min-h-[180px]\">\n      <Plot\n        data={traces}\n        layout={layout}\n        config={config}\n        useResizeHandler\n        style={{ width: \"100%\", height: \"100%\" }}\n      />\n    </div>\n  );\n}\n"],"names":[],"mappings":";;;;;AAEA;;AAFA;;;AAKA,gDAAgD;AAChD,MAAM,OAAO,IAAA,0KAAO;;;;;;IAAoC,KAAK;;AAMtD,SAAS,aAAa,EAAE,MAAM,EAAqB;IACxD,IAAI,OAAO,MAAM,KAAK,GAAG;QACvB,qBACE,8OAAC;YAAI,WAAU;sBAA4D;;;;;;IAI/E;IAEA,2BAA2B;IAC3B,MAAM,SAAwB,OAAO,GAAG,CAAC,CAAC,QAAU,CAAC;YACnD,GAAG,MAAM,MAAM,CAAC,GAAG,CAAC,CAAC,IAAM,EAAE,QAAQ,GAAG;YACxC,GAAG,MAAM,MAAM,CAAC,GAAG,CAAC,CAAC,IAAM,EAAE,KAAK,GAAG;YACrC,MAAM;YACN,MAAM;YACN,MAAM,MAAM,IAAI;YAChB,MAAM;gBACJ,OAAO,MAAM,KAAK;gBAClB,OAAO,MAAM,IAAI,CAAC,QAAQ,CAAC,gBAAgB,MAAM;gBACjD,MAAM,MAAM,IAAI,CAAC,QAAQ,CAAC,gBAAgB,SAAS;YACrD;YACA,MAAM,MAAM,IAAI,CAAC,QAAQ,CAAC,gBAAgB,YAAY;YACtD,WAAW,MAAM,IAAI,CAAC,QAAQ,CAAC,gBAC3B,YACA,GAAG,MAAM,KAAK,CAAC,EAAE,CAAC;QACxB,CAAC;IAED,MAAM,SAAiC;QACrC,OAAO;QACP,UAAU;QACV,QAAQ;YAAE,GAAG;YAAI,GAAG;YAAI,GAAG;YAAI,GAAG;QAAG;QACrC,eAAe;QACf,cAAc;QACd,MAAM;YAAE,OAAO;QAAO;QACtB,OAAO;YACL,OAAO;YACP,WAAW;YACX,eAAe;YACf,OAAO;gBAAC;gBAAG;aAAG;QAChB;QACA,OAAO;YACL,OAAO;YACP,WAAW;YACX,eAAe;YACf,OAAO;gBAAC;gBAAG;aAAK;QAClB;QACA,QAAQ;YACN,GAAG;YACH,SAAS;YACT,GAAG;YACH,SAAS;QACX;QACA,YAAY;QACZ,WAAW;IACb;IAEA,MAAM,SAAiC;QACrC,gBAAgB;QAChB,YAAY;IACd;IAEA,qBACE,8OAAC;QAAI,WAAU;kBACb,cAAA,8OAAC;YACC,MAAM;YACN,QAAQ;YACR,QAAQ;YACR,gBAAgB;YAChB,OAAO;gBAAE,OAAO;gBAAQ,QAAQ;YAAO;;;;;;;;;;;AAI/C","debugId":null}},
    {"offset": {"line": 7197, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/components/panels/SimulationPanel.tsx"],"sourcesContent":["\"use client\";\n\nimport { useEffect } from \"react\";\nimport { Play, Square, RotateCcw, AlertCircle, Loader2 } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { useDrivetrainStore } from \"@/stores/drivetrain-store\";\nimport { useSimulationStore } from \"@/stores/simulation-store\";\nimport { useSimulation } from \"@/hooks/useSimulation\";\nimport { SimulationChart } from \"@/components/charts/SimulationChart\";\nimport { RimpullChart } from \"@/components/charts/RimpullChart\";\n\nexport function SimulationPanel() {\n  const nodes = useDrivetrainStore((s) => s.nodes);\n  const edges = useDrivetrainStore((s) => s.edges);\n  const validateTopology = useDrivetrainStore((s) => s.validateTopology);\n\n  const config = useSimulationStore((s) => s.config);\n  const setConfig = useSimulationStore((s) => s.setConfig);\n  const status = useSimulationStore((s) => s.status);\n  const progress = useSimulationStore((s) => s.progress);\n  const result = useSimulationStore((s) => s.result);\n  const error = useSimulationStore((s) => s.error);\n  const rimpullCurves = useSimulationStore((s) => s.rimpullCurves);\n  const reset = useSimulationStore((s) => s.reset);\n\n  const { runSimulation, calculateRimpull } = useSimulation();\n\n  // Calculate rimpull when nodes/edges change\n  useEffect(() => {\n    if (nodes.length > 0) {\n      calculateRimpull(nodes, edges);\n    }\n  }, [nodes, edges, calculateRimpull]);\n\n  const handleRunSimulation = async () => {\n    console.log(\"Run simulation clicked, nodes:\", nodes.length, \"edges:\", edges.length);\n\n    if (nodes.length === 0) {\n      alert(\"No components in the topology. Load a preset or add components first.\");\n      return;\n    }\n\n    const validation = validateTopology();\n    console.log(\"Validation result:\", validation);\n\n    if (!validation.isValid) {\n      alert(\"Invalid topology:\\n\" + validation.errors.join(\"\\n\"));\n      return;\n    }\n\n    try {\n      console.log(\"Starting simulation...\");\n      await runSimulation(nodes, edges);\n      console.log(\"Simulation completed\");\n    } catch (error) {\n      console.error(\"Simulation error:\", error);\n      alert(\"Simulation failed: \" + (error instanceof Error ? error.message : \"Unknown error\"));\n    }\n  };\n\n  const handleStop = () => {\n    reset();\n  };\n\n  return (\n    <div className=\"h-64 bg-dark border-t border-subtle p-4 overflow-hidden\">\n      <Tabs defaultValue=\"config\" className=\"h-full flex flex-col\">\n        <div className=\"flex items-center justify-between mb-2\">\n          <TabsList>\n            <TabsTrigger value=\"config\">Configuration</TabsTrigger>\n            <TabsTrigger value=\"results\">Results</TabsTrigger>\n            <TabsTrigger value=\"rimpull\">Rimpull</TabsTrigger>\n          </TabsList>\n\n          <div className=\"flex items-center gap-2\">\n            {status === \"running\" && (\n              <div className=\"flex items-center gap-2 text-sm text-muted\">\n                <Loader2 className=\"h-4 w-4 animate-spin text-accent\" />\n                <div className=\"h-2 w-32 bg-subtle rounded-full overflow-hidden\">\n                  <div\n                    className=\"h-full bg-accent transition-all\"\n                    style={{ width: `${progress * 100}%` }}\n                  />\n                </div>\n                <span>{Math.round(progress * 100)}%</span>\n              </div>\n            )}\n\n            {status === \"error\" && (\n              <div className=\"flex items-center gap-1 text-sm text-red-500\">\n                <AlertCircle className=\"h-4 w-4\" />\n                <span>Error</span>\n              </div>\n            )}\n\n            {status !== \"running\" ? (\n              <Button\n                type=\"button\"\n                variant=\"accent\"\n                size=\"sm\"\n                onClick={handleRunSimulation}\n              >\n                <Play className=\"h-4 w-4 mr-1\" />\n                Run Simulation\n              </Button>\n            ) : (\n              <Button type=\"button\" variant=\"destructive\" size=\"sm\" onClick={handleStop}>\n                <Loader2 className=\"h-4 w-4 mr-1 animate-spin\" />\n                Running...\n              </Button>\n            )}\n\n            <Button type=\"button\" variant=\"outline\" size=\"sm\" onClick={reset} disabled={status === \"running\"}>\n              <RotateCcw className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </div>\n\n        <TabsContent value=\"config\" className=\"flex-1 overflow-auto\">\n          <div className=\"grid grid-cols-5 gap-4\">\n            <div className=\"space-y-1\">\n              <Label className=\"text-xs\">Duration (s)</Label>\n              <Input\n                type=\"number\"\n                value={config.tEnd}\n                onChange={(e) =>\n                  setConfig({ tEnd: parseFloat(e.target.value) || 60 })\n                }\n                className=\"h-8\"\n              />\n            </div>\n            <div className=\"space-y-1\">\n              <Label className=\"text-xs\">Target Speed (km/h)</Label>\n              <Input\n                type=\"number\"\n                value={(config.targetVelocity * 3.6).toFixed(1)}\n                onChange={(e) =>\n                  setConfig({\n                    targetVelocity: (parseFloat(e.target.value) || 0) / 3.6,\n                  })\n                }\n                className=\"h-8\"\n              />\n            </div>\n            <div className=\"space-y-1\">\n              <Label className=\"text-xs\">Grade (%)</Label>\n              <Input\n                type=\"number\"\n                value={(config.grade * 100).toFixed(1)}\n                onChange={(e) =>\n                  setConfig({ grade: (parseFloat(e.target.value) || 0) / 100 })\n                }\n                step={0.5}\n                className=\"h-8\"\n              />\n            </div>\n            <div className=\"space-y-1\">\n              <Label className=\"text-xs\">Payload (%)</Label>\n              <Input\n                type=\"number\"\n                value={(config.payloadFraction * 100).toFixed(0)}\n                onChange={(e) =>\n                  setConfig({\n                    payloadFraction: (parseFloat(e.target.value) || 100) / 100,\n                  })\n                }\n                className=\"h-8\"\n              />\n            </div>\n            <div className=\"space-y-1\">\n              <Label className=\"text-xs\">Output Step (s)</Label>\n              <Input\n                type=\"number\"\n                value={config.dtOutput}\n                onChange={(e) =>\n                  setConfig({ dtOutput: parseFloat(e.target.value) || 0.1 })\n                }\n                step={0.05}\n                className=\"h-8\"\n              />\n            </div>\n          </div>\n\n          {error && (\n            <div className=\"mt-4 p-3 bg-red-500/10 border border-red-500/30 rounded text-red-400 text-sm\">\n              <span className=\"font-semibold\">Simulation Error:</span> {error}\n            </div>\n          )}\n        </TabsContent>\n\n        <TabsContent value=\"results\" className=\"flex-1 overflow-hidden\">\n          {result ? (\n            <SimulationChart\n              time={result.time}\n              velocity={result.velocity}\n              grade={result.grade}\n              fuelRate={result.fuelRate}\n              enginePower={result.enginePower}\n              motorPower={result.motorPower}\n            />\n          ) : (\n            <div className=\"h-full flex items-center justify-center text-muted\">\n              {status === \"running\"\n                ? \"Simulation in progress...\"\n                : \"Run a simulation to see results\"}\n            </div>\n          )}\n        </TabsContent>\n\n        <TabsContent value=\"rimpull\" className=\"flex-1 overflow-hidden\">\n          <RimpullChart curves={rimpullCurves} />\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 7698, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/components/charts/ComparisonChart.tsx"],"sourcesContent":["\"use client\";\n\nimport dynamic from \"next/dynamic\";\nimport type { ComparisonResult } from \"@/stores/simulation-store\";\n\nconst Plot = dynamic(() => import(\"react-plotly.js\"), { ssr: false });\n\ninterface ComparisonChartProps {\n  results: ComparisonResult[];\n  metric: \"velocity\" | \"fuelRate\" | \"enginePower\" | \"motorPower\";\n}\n\nconst METRIC_CONFIG = {\n  velocity: {\n    label: \"Velocity\",\n    unit: \"km/h\",\n    transform: (v: number) => v * 3.6,\n  },\n  fuelRate: {\n    label: \"Fuel Rate\",\n    unit: \"kg/h\",\n    transform: (v: number) => v * 3600,\n  },\n  enginePower: {\n    label: \"Engine Power\",\n    unit: \"kW\",\n    transform: (v: number) => v / 1000,\n  },\n  motorPower: {\n    label: \"Motor Power\",\n    unit: \"kW\",\n    transform: (v: number) => v / 1000,\n  },\n};\n\nexport function ComparisonChart({ results, metric }: ComparisonChartProps) {\n  if (results.length === 0) {\n    return (\n      <div className=\"w-full h-full flex items-center justify-center text-muted\">\n        Run comparison to see results\n      </div>\n    );\n  }\n\n  const config = METRIC_CONFIG[metric];\n\n  const traces: Plotly.Data[] = results\n    .filter((r) => {\n      if (metric === \"velocity\") return true;\n      if (metric === \"fuelRate\") return r.result.fuelRate;\n      if (metric === \"enginePower\") return r.result.enginePower;\n      if (metric === \"motorPower\") return r.result.motorPower;\n      return false;\n    })\n    .map((r) => {\n      let yData: number[] = [];\n      switch (metric) {\n        case \"velocity\":\n          yData = r.result.velocity;\n          break;\n        case \"fuelRate\":\n          yData = r.result.fuelRate || [];\n          break;\n        case \"enginePower\":\n          yData = r.result.enginePower || [];\n          break;\n        case \"motorPower\":\n          yData = r.result.motorPower || [];\n          break;\n      }\n\n      return {\n        x: r.result.time,\n        y: yData.map(config.transform),\n        type: \"scatter\",\n        mode: \"lines\",\n        name: r.label,\n        line: { color: r.color, width: 2 },\n      };\n    });\n\n  const layout: Partial<Plotly.Layout> = {\n    autosize: true,\n    margin: { t: 30, r: 30, b: 50, l: 60 },\n    paper_bgcolor: \"transparent\",\n    plot_bgcolor: \"transparent\",\n    font: { color: \"#888\" },\n    xaxis: {\n      title: \"Time (s)\",\n      gridcolor: \"#333\",\n      zerolinecolor: \"#444\",\n    },\n    yaxis: {\n      title: `${config.label} (${config.unit})`,\n      gridcolor: \"#333\",\n      zerolinecolor: \"#444\",\n    },\n    legend: {\n      x: 0,\n      y: 1,\n      bgcolor: \"rgba(0,0,0,0.5)\",\n    },\n    showlegend: true,\n  };\n\n  return (\n    <div className=\"w-full h-full min-h-[300px]\">\n      <Plot\n        data={traces}\n        layout={layout}\n        config={{ displayModeBar: false, responsive: true }}\n        useResizeHandler\n        style={{ width: \"100%\", height: \"100%\" }}\n      />\n    </div>\n  );\n}\n"],"names":[],"mappings":";;;;;AAEA;;AAFA;;;AAKA,MAAM,OAAO,IAAA,0KAAO;;;;;;IAAoC,KAAK;;AAO7D,MAAM,gBAAgB;IACpB,UAAU;QACR,OAAO;QACP,MAAM;QACN,WAAW,CAAC,IAAc,IAAI;IAChC;IACA,UAAU;QACR,OAAO;QACP,MAAM;QACN,WAAW,CAAC,IAAc,IAAI;IAChC;IACA,aAAa;QACX,OAAO;QACP,MAAM;QACN,WAAW,CAAC,IAAc,IAAI;IAChC;IACA,YAAY;QACV,OAAO;QACP,MAAM;QACN,WAAW,CAAC,IAAc,IAAI;IAChC;AACF;AAEO,SAAS,gBAAgB,EAAE,OAAO,EAAE,MAAM,EAAwB;IACvE,IAAI,QAAQ,MAAM,KAAK,GAAG;QACxB,qBACE,8OAAC;YAAI,WAAU;sBAA4D;;;;;;IAI/E;IAEA,MAAM,SAAS,aAAa,CAAC,OAAO;IAEpC,MAAM,SAAwB,QAC3B,MAAM,CAAC,CAAC;QACP,IAAI,WAAW,YAAY,OAAO;QAClC,IAAI,WAAW,YAAY,OAAO,EAAE,MAAM,CAAC,QAAQ;QACnD,IAAI,WAAW,eAAe,OAAO,EAAE,MAAM,CAAC,WAAW;QACzD,IAAI,WAAW,cAAc,OAAO,EAAE,MAAM,CAAC,UAAU;QACvD,OAAO;IACT,GACC,GAAG,CAAC,CAAC;QACJ,IAAI,QAAkB,EAAE;QACxB,OAAQ;YACN,KAAK;gBACH,QAAQ,EAAE,MAAM,CAAC,QAAQ;gBACzB;YACF,KAAK;gBACH,QAAQ,EAAE,MAAM,CAAC,QAAQ,IAAI,EAAE;gBAC/B;YACF,KAAK;gBACH,QAAQ,EAAE,MAAM,CAAC,WAAW,IAAI,EAAE;gBAClC;YACF,KAAK;gBACH,QAAQ,EAAE,MAAM,CAAC,UAAU,IAAI,EAAE;gBACjC;QACJ;QAEA,OAAO;YACL,GAAG,EAAE,MAAM,CAAC,IAAI;YAChB,GAAG,MAAM,GAAG,CAAC,OAAO,SAAS;YAC7B,MAAM;YACN,MAAM;YACN,MAAM,EAAE,KAAK;YACb,MAAM;gBAAE,OAAO,EAAE,KAAK;gBAAE,OAAO;YAAE;QACnC;IACF;IAEF,MAAM,SAAiC;QACrC,UAAU;QACV,QAAQ;YAAE,GAAG;YAAI,GAAG;YAAI,GAAG;YAAI,GAAG;QAAG;QACrC,eAAe;QACf,cAAc;QACd,MAAM;YAAE,OAAO;QAAO;QACtB,OAAO;YACL,OAAO;YACP,WAAW;YACX,eAAe;QACjB;QACA,OAAO;YACL,OAAO,GAAG,OAAO,KAAK,CAAC,EAAE,EAAE,OAAO,IAAI,CAAC,CAAC,CAAC;YACzC,WAAW;YACX,eAAe;QACjB;QACA,QAAQ;YACN,GAAG;YACH,GAAG;YACH,SAAS;QACX;QACA,YAAY;IACd;IAEA,qBACE,8OAAC;QAAI,WAAU;kBACb,cAAA,8OAAC;YACC,MAAM;YACN,QAAQ;YACR,QAAQ;gBAAE,gBAAgB;gBAAO,YAAY;YAAK;YAClD,gBAAgB;YAChB,OAAO;gBAAE,OAAO;gBAAQ,QAAQ;YAAO;;;;;;;;;;;AAI/C","debugId":null}},
    {"offset": {"line": 7843, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/components/charts/ComparisonRimpullChart.tsx"],"sourcesContent":["\"use client\";\n\nimport dynamic from \"next/dynamic\";\nimport type { ComparisonResult, RimpullCurve, RimpullPoint } from \"@/stores/simulation-store\";\n\nconst Plot = dynamic(() => import(\"react-plotly.js\"), { ssr: false });\n\ninterface ComparisonRimpullChartProps {\n  results: ComparisonResult[];\n}\n\n/**\n * Interpolate force at a given velocity from a curve's points.\n */\nfunction interpolateForce(points: RimpullPoint[], velocity: number): number {\n  if (points.length === 0) return 0;\n\n  // Find surrounding points\n  let left = 0;\n  let right = points.length - 1;\n\n  // Check bounds\n  if (velocity <= points[0].velocity) return points[0].force;\n  if (velocity >= points[right].velocity) return points[right].force;\n\n  // Binary search for surrounding points\n  for (let i = 0; i < points.length - 1; i++) {\n    if (points[i].velocity <= velocity && points[i + 1].velocity >= velocity) {\n      left = i;\n      right = i + 1;\n      break;\n    }\n  }\n\n  // Linear interpolation\n  const v0 = points[left].velocity;\n  const v1 = points[right].velocity;\n  const f0 = points[left].force;\n  const f1 = points[right].force;\n\n  if (v1 === v0) return f0;\n\n  const t = (velocity - v0) / (v1 - v0);\n  return f0 + t * (f1 - f0);\n}\n\n/**\n * Compute the envelope (max force) across all gear curves at each velocity.\n */\nfunction computeEnvelope(\n  gearCurves: RimpullCurve[],\n  velocities: number[]\n): number[] {\n  return velocities.map((v) => {\n    let maxForce = 0;\n    for (const curve of gearCurves) {\n      const force = interpolateForce(curve.points, v);\n      maxForce = Math.max(maxForce, force);\n    }\n    return maxForce;\n  });\n}\n\nexport function ComparisonRimpullChart({ results }: ComparisonRimpullChartProps) {\n  if (results.length === 0) {\n    return (\n      <div className=\"w-full h-full flex items-center justify-center text-muted\">\n        Run comparison to see rimpull curves\n      </div>\n    );\n  }\n\n  const traces: Plotly.Data[] = [];\n\n  // Common velocity grid (0 to 60 km/h in m/s)\n  const numPoints = 200;\n  const maxSpeedMs = 60 / 3.6;\n  const commonVelocities: number[] = [];\n  for (let i = 0; i <= numPoints; i++) {\n    commonVelocities.push((maxSpeedMs * i) / numPoints);\n  }\n\n  // Add rimpull curves from each preset (only gear curves, not resistance)\n  for (const r of results) {\n    const gearCurves = r.rimpullCurves.filter(\n      (c) => !c.name.includes(\"Resistance\") && !c.name.includes(\"Rolling\")\n    );\n\n    // Compute envelope by interpolating all curves to common velocity grid\n    if (gearCurves.length > 0) {\n      const envelopeForces = computeEnvelope(gearCurves, commonVelocities);\n\n      traces.push({\n        x: commonVelocities.map((v) => v * 3.6),\n        y: envelopeForces.map((f) => f / 1000),\n        type: \"scatter\",\n        mode: \"lines\",\n        name: r.label,\n        line: { color: r.color, width: 3 },\n        fill: \"tozeroy\",\n        fillcolor: `${r.color}20`,\n      });\n    }\n  }\n\n  // Add resistance curves (from first result, since they should be the same)\n  if (results.length > 0) {\n    const resistanceCurves = results[0].rimpullCurves.filter(\n      (c) => c.name.includes(\"Resistance\") || c.name.includes(\"Rolling\")\n    );\n\n    for (const curve of resistanceCurves) {\n      traces.push({\n        x: curve.points.map((p) => p.velocity * 3.6),\n        y: curve.points.map((p) => p.force / 1000),\n        type: \"scatter\",\n        mode: \"lines\",\n        name: curve.name,\n        line: {\n          color: curve.color,\n          width: 1.5,\n          dash: \"dash\",\n        },\n      });\n    }\n  }\n\n  const layout: Partial<Plotly.Layout> = {\n    autosize: true,\n    margin: { t: 30, r: 30, b: 50, l: 60 },\n    paper_bgcolor: \"transparent\",\n    plot_bgcolor: \"transparent\",\n    font: { color: \"#888\" },\n    xaxis: {\n      title: \"Speed (km/h)\",\n      gridcolor: \"#333\",\n      zerolinecolor: \"#444\",\n      range: [0, 60],\n    },\n    yaxis: {\n      title: \"Tractive Force (kN)\",\n      gridcolor: \"#333\",\n      zerolinecolor: \"#444\",\n      range: [0, null],\n    },\n    legend: {\n      x: 1,\n      xanchor: \"right\",\n      y: 1,\n      bgcolor: \"rgba(0,0,0,0.5)\",\n    },\n    showlegend: true,\n  };\n\n  return (\n    <div className=\"w-full h-full min-h-[300px]\">\n      <Plot\n        data={traces}\n        layout={layout}\n        config={{ displayModeBar: false, responsive: true }}\n        useResizeHandler\n        style={{ width: \"100%\", height: \"100%\" }}\n      />\n    </div>\n  );\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 8026, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/components/panels/SimulationView.tsx"],"sourcesContent":["\"use client\";\n\nimport { useEffect, useState, useCallback } from \"react\";\nimport { Play, RotateCcw, AlertCircle, Loader2, X, GitCompare, Check } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { useDrivetrainStore, type PresetName } from \"@/stores/drivetrain-store\";\nimport {\n  useSimulationStore,\n  PRESET_COLORS,\n  PRESET_LABELS,\n  type ComparisonResult,\n} from \"@/stores/simulation-store\";\nimport { useSimulation } from \"@/hooks/useSimulation\";\nimport { SimulationChart } from \"@/components/charts/SimulationChart\";\nimport { RimpullChart } from \"@/components/charts/RimpullChart\";\nimport { ComparisonChart } from \"@/components/charts/ComparisonChart\";\nimport { ComparisonRimpullChart } from \"@/components/charts/ComparisonRimpullChart\";\n\ninterface SimulationViewProps {\n  onClose: () => void;\n}\n\nconst ALL_PRESETS: PresetName[] = [\"diesel-793d\", \"ecvt-split\", \"ecvt-locked\"];\n\nexport function SimulationView({ onClose }: SimulationViewProps) {\n  const nodes = useDrivetrainStore((s) => s.nodes);\n  const edges = useDrivetrainStore((s) => s.edges);\n  const validateTopology = useDrivetrainStore((s) => s.validateTopology);\n  const loadPreset = useDrivetrainStore((s) => s.loadPreset);\n\n  const config = useSimulationStore((s) => s.config);\n  const setConfig = useSimulationStore((s) => s.setConfig);\n  const status = useSimulationStore((s) => s.status);\n  const progress = useSimulationStore((s) => s.progress);\n  const result = useSimulationStore((s) => s.result);\n  const error = useSimulationStore((s) => s.error);\n  const rimpullCurves = useSimulationStore((s) => s.rimpullCurves);\n  const reset = useSimulationStore((s) => s.reset);\n\n  // Comparison state\n  const comparisonResults = useSimulationStore((s) => s.comparisonResults);\n  const addComparisonResult = useSimulationStore((s) => s.addComparisonResult);\n  const clearComparisonResults = useSimulationStore((s) => s.clearComparisonResults);\n  const runningPreset = useSimulationStore((s) => s.runningPreset);\n  const setRunningPreset = useSimulationStore((s) => s.setRunningPreset);\n\n  const [isComparing, setIsComparing] = useState(false);\n  const [completedPresets, setCompletedPresets] = useState<PresetName[]>([]);\n\n  const { runSimulation, calculateRimpull } = useSimulation();\n\n  // Calculate rimpull when nodes/edges change\n  useEffect(() => {\n    if (nodes.length > 0) {\n      calculateRimpull(nodes, edges);\n    }\n  }, [nodes, edges, calculateRimpull]);\n\n  const handleRunSimulation = async () => {\n    if (nodes.length === 0) {\n      alert(\"No components in the topology. Load a preset or add components first.\");\n      return;\n    }\n\n    const validation = validateTopology();\n    if (!validation.isValid) {\n      alert(\"Invalid topology:\\n\" + validation.errors.join(\"\\n\"));\n      return;\n    }\n\n    try {\n      await runSimulation(nodes, edges);\n    } catch (err) {\n      console.error(\"Simulation error:\", err);\n      alert(\"Simulation failed: \" + (err instanceof Error ? err.message : \"Unknown error\"));\n    }\n  };\n\n  const runComparisonForPreset = useCallback(\n    async (preset: PresetName): Promise<ComparisonResult | null> => {\n      try {\n        // Load the preset\n        loadPreset(preset);\n\n        // Wait a tick for state to update\n        await new Promise((resolve) => setTimeout(resolve, 50));\n\n        // Get the new nodes/edges from store\n        const state = useDrivetrainStore.getState();\n        const presetNodes = state.nodes;\n        const presetEdges = state.edges;\n\n        if (presetNodes.length === 0) {\n          console.error(`No nodes for preset ${preset}`);\n          return null;\n        }\n\n        // Calculate rimpull for this preset\n        calculateRimpull(presetNodes, presetEdges);\n        const presetRimpull = useSimulationStore.getState().rimpullCurves;\n\n        // Run simulation\n        await runSimulation(presetNodes, presetEdges);\n\n        // Get result\n        const simResult = useSimulationStore.getState().result;\n        if (!simResult) {\n          console.error(`No result for preset ${preset}`);\n          return null;\n        }\n\n        return {\n          preset,\n          label: PRESET_LABELS[preset],\n          color: PRESET_COLORS[preset],\n          result: simResult,\n          rimpullCurves: presetRimpull,\n        };\n      } catch (err) {\n        console.error(`Error running ${preset}:`, err);\n        return null;\n      }\n    },\n    [loadPreset, runSimulation, calculateRimpull]\n  );\n\n  const handleRunComparison = async () => {\n    setIsComparing(true);\n    setCompletedPresets([]);\n    clearComparisonResults();\n\n    for (const preset of ALL_PRESETS) {\n      setRunningPreset(preset);\n\n      const result = await runComparisonForPreset(preset);\n      if (result) {\n        addComparisonResult(result);\n        setCompletedPresets((prev) => [...prev, preset]);\n      }\n    }\n\n    setRunningPreset(null);\n    setIsComparing(false);\n  };\n\n  const handleClearComparison = () => {\n    clearComparisonResults();\n    setCompletedPresets([]);\n  };\n\n  return (\n    <div className=\"fixed inset-0 z-50 bg-black/90 flex flex-col\">\n      {/* Header */}\n      <div className=\"h-14 flex items-center justify-between px-6 border-b border-subtle bg-dark\">\n        <h2 className=\"text-lg font-semibold text-primary\">Simulation & Analysis</h2>\n\n        <div className=\"flex items-center gap-4\">\n          {/* Simulation Controls */}\n          <div className=\"flex items-center gap-3\">\n            {status === \"running\" && !isComparing && (\n              <div className=\"flex items-center gap-2 text-sm text-muted\">\n                <Loader2 className=\"h-4 w-4 animate-spin text-accent\" />\n                <div className=\"h-2 w-40 bg-subtle rounded-full overflow-hidden\">\n                  <div\n                    className=\"h-full bg-accent transition-all\"\n                    style={{ width: `${progress * 100}%` }}\n                  />\n                </div>\n                <span>{Math.round(progress * 100)}%</span>\n              </div>\n            )}\n\n            {status === \"error\" && (\n              <div className=\"flex items-center gap-1 text-sm text-red-500\">\n                <AlertCircle className=\"h-4 w-4\" />\n                <span>Error</span>\n              </div>\n            )}\n\n            {status !== \"running\" && !isComparing ? (\n              <Button type=\"button\" variant=\"accent\" size=\"sm\" onClick={handleRunSimulation}>\n                <Play className=\"h-4 w-4 mr-1\" />\n                Run Current\n              </Button>\n            ) : !isComparing ? (\n              <Button type=\"button\" variant=\"destructive\" size=\"sm\" onClick={reset}>\n                <Loader2 className=\"h-4 w-4 mr-1 animate-spin\" />\n                Running...\n              </Button>\n            ) : null}\n\n            <Button\n              type=\"button\"\n              variant={isComparing ? \"destructive\" : \"default\"}\n              size=\"sm\"\n              onClick={handleRunComparison}\n              disabled={isComparing}\n            >\n              {isComparing ? (\n                <>\n                  <Loader2 className=\"h-4 w-4 mr-1 animate-spin\" />\n                  Comparing...\n                </>\n              ) : (\n                <>\n                  <GitCompare className=\"h-4 w-4 mr-1\" />\n                  Compare All\n                </>\n              )}\n            </Button>\n\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => {\n                reset();\n                handleClearComparison();\n              }}\n              disabled={status === \"running\" || isComparing}\n            >\n              <RotateCcw className=\"h-4 w-4\" />\n            </Button>\n          </div>\n\n          <div className=\"w-px h-8 bg-subtle\" />\n\n          <Button type=\"button\" variant=\"ghost\" size=\"icon-sm\" onClick={onClose}>\n            <X className=\"h-5 w-5\" />\n          </Button>\n        </div>\n      </div>\n\n      {/* Main Content */}\n      <div className=\"flex-1 flex overflow-hidden\">\n        {/* Left: Configuration */}\n        <div className=\"w-72 border-r border-subtle bg-dark p-4 overflow-auto\">\n          <h3 className=\"text-sm font-medium text-primary mb-4\">Configuration</h3>\n\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label className=\"text-xs\">Duration (s)</Label>\n              <Input\n                type=\"number\"\n                value={config.tEnd}\n                onChange={(e) => setConfig({ tEnd: parseFloat(e.target.value) || 60 })}\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label className=\"text-xs\">Target Speed (km/h)</Label>\n              <Input\n                type=\"number\"\n                value={(config.targetVelocity * 3.6).toFixed(1)}\n                onChange={(e) => setConfig({ targetVelocity: (parseFloat(e.target.value) || 0) / 3.6 })}\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label className=\"text-xs\">Grade (%)</Label>\n              <Input\n                type=\"number\"\n                value={(config.grade * 100).toFixed(1)}\n                onChange={(e) => setConfig({ grade: (parseFloat(e.target.value) || 0) / 100 })}\n                step={0.5}\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label className=\"text-xs\">Payload (%)</Label>\n              <Input\n                type=\"number\"\n                value={(config.payloadFraction * 100).toFixed(0)}\n                onChange={(e) => setConfig({ payloadFraction: (parseFloat(e.target.value) || 100) / 100 })}\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label className=\"text-xs\">Output Step (s)</Label>\n              <Input\n                type=\"number\"\n                value={config.dtOutput}\n                onChange={(e) => setConfig({ dtOutput: parseFloat(e.target.value) || 0.1 })}\n                step={0.05}\n              />\n            </div>\n          </div>\n\n          {error && (\n            <div className=\"mt-4 p-3 bg-red-500/10 border border-red-500/30 rounded text-red-400 text-sm\">\n              <span className=\"font-semibold\">Error:</span> {error}\n            </div>\n          )}\n\n          {/* Comparison Progress */}\n          {(isComparing || comparisonResults.length > 0) && (\n            <div className=\"mt-6 pt-4 border-t border-subtle\">\n              <h3 className=\"text-sm font-medium text-primary mb-3\">Comparison Status</h3>\n              <div className=\"space-y-2\">\n                {ALL_PRESETS.map((preset) => {\n                  const isRunning = runningPreset === preset;\n                  const isComplete = completedPresets.includes(preset);\n                  const hasResult = comparisonResults.some((r) => r.preset === preset);\n\n                  return (\n                    <div\n                      key={preset}\n                      className=\"flex items-center gap-2 text-xs\"\n                    >\n                      <div\n                        className=\"w-3 h-3 rounded-full\"\n                        style={{ backgroundColor: PRESET_COLORS[preset] }}\n                      />\n                      <span className=\"flex-1 text-muted\">{PRESET_LABELS[preset]}</span>\n                      {isRunning && <Loader2 className=\"h-3 w-3 animate-spin text-accent\" />}\n                      {hasResult && <Check className=\"h-3 w-3 text-green-500\" />}\n                    </div>\n                  );\n                })}\n              </div>\n            </div>\n          )}\n\n          {/* Summary Stats */}\n          {result && !isComparing && comparisonResults.length === 0 && (\n            <div className=\"mt-6 pt-4 border-t border-subtle\">\n              <h3 className=\"text-sm font-medium text-primary mb-3\">Results Summary</h3>\n              <div className=\"space-y-2 text-xs\">\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted\">Final Speed:</span>\n                  <span className=\"text-primary\">\n                    {(result.velocity[result.velocity.length - 1] * 3.6).toFixed(1)} km/h\n                  </span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted\">Max Speed:</span>\n                  <span className=\"text-primary\">\n                    {(Math.max(...result.velocity) * 3.6).toFixed(1)} km/h\n                  </span>\n                </div>\n                {result.fuelRate && (\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted\">Avg Fuel Rate:</span>\n                    <span className=\"text-primary\">\n                      {((result.fuelRate.reduce((a, b) => a + b, 0) / result.fuelRate.length) * 3600).toFixed(1)} kg/h\n                    </span>\n                  </div>\n                )}\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted\">Sim Duration:</span>\n                  <span className=\"text-primary\">{result.time.length} points</span>\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* Comparison Summary */}\n          {comparisonResults.length > 0 && (\n            <div className=\"mt-6 pt-4 border-t border-subtle\">\n              <h3 className=\"text-sm font-medium text-primary mb-3\">Comparison Summary</h3>\n              <div className=\"space-y-3\">\n                {comparisonResults.map((r) => (\n                  <div key={r.preset} className=\"text-xs\">\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <div\n                        className=\"w-2 h-2 rounded-full\"\n                        style={{ backgroundColor: r.color }}\n                      />\n                      <span className=\"font-medium text-primary\">{r.label}</span>\n                    </div>\n                    <div className=\"pl-4 space-y-1 text-muted\">\n                      <div className=\"flex justify-between\">\n                        <span>Max Speed:</span>\n                        <span>{(Math.max(...r.result.velocity) * 3.6).toFixed(1)} km/h</span>\n                      </div>\n                      {r.result.fuelRate && (\n                        <div className=\"flex justify-between\">\n                          <span>Avg Fuel:</span>\n                          <span>\n                            {((r.result.fuelRate.reduce((a, b) => a + b, 0) / r.result.fuelRate.length) * 3600).toFixed(1)} kg/h\n                          </span>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </div>\n          )}\n        </div>\n\n        {/* Right: Charts */}\n        <div className=\"flex-1 p-6 overflow-auto\">\n          <Tabs defaultValue=\"comparison\" className=\"h-full flex flex-col\">\n            <TabsList className=\"mb-4\">\n              <TabsTrigger value=\"comparison\">Comparison</TabsTrigger>\n              <TabsTrigger value=\"results\">Current Topology</TabsTrigger>\n              <TabsTrigger value=\"rimpull\">Rimpull (Current)</TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"comparison\" className=\"flex-1\">\n              <div className=\"h-full grid grid-rows-2 gap-4\">\n                <div className=\"bg-surface rounded-lg border border-subtle p-4\">\n                  <h3 className=\"text-sm font-medium text-primary mb-2\">Velocity Comparison</h3>\n                  <div className=\"h-[calc(100%-2rem)]\">\n                    <ComparisonChart results={comparisonResults} metric=\"velocity\" />\n                  </div>\n                </div>\n                <div className=\"bg-surface rounded-lg border border-subtle p-4\">\n                  <h3 className=\"text-sm font-medium text-primary mb-2\">Rimpull Comparison</h3>\n                  <div className=\"h-[calc(100%-2rem)]\">\n                    <ComparisonRimpullChart results={comparisonResults} />\n                  </div>\n                </div>\n              </div>\n            </TabsContent>\n\n            <TabsContent value=\"results\" className=\"flex-1\">\n              <div className=\"h-full bg-surface rounded-lg border border-subtle p-4\">\n                {result ? (\n                  <SimulationChart\n                    time={result.time}\n                    velocity={result.velocity}\n                    grade={result.grade}\n                    fuelRate={result.fuelRate}\n                    enginePower={result.enginePower}\n                    motorPower={result.motorPower}\n                  />\n                ) : (\n                  <div className=\"h-full flex items-center justify-center text-muted\">\n                    {status === \"running\" ? (\n                      <div className=\"flex flex-col items-center gap-3\">\n                        <Loader2 className=\"h-8 w-8 animate-spin text-accent\" />\n                        <span>Simulation in progress...</span>\n                      </div>\n                    ) : (\n                      <span>Run a simulation to see results</span>\n                    )}\n                  </div>\n                )}\n              </div>\n            </TabsContent>\n\n            <TabsContent value=\"rimpull\" className=\"flex-1\">\n              <div className=\"h-full bg-surface rounded-lg border border-subtle p-4\">\n                <RimpullChart curves={rimpullCurves} />\n              </div>\n            </TabsContent>\n          </Tabs>\n        </div>\n      </div>\n    </div>\n  );\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 9154, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/components/DrivetrainEditor.tsx"],"sourcesContent":["\"use client\";\n\nimport { useCallback, useState } from \"react\";\nimport {\n  ReactFlow,\n  Background,\n  Controls,\n  MiniMap,\n  addEdge,\n  type Connection,\n  type Edge,\n  BackgroundVariant,\n} from \"@xyflow/react\";\nimport \"@xyflow/react/dist/style.css\";\nimport { BarChart3 } from \"lucide-react\";\n\nimport { useDrivetrainStore, type ComponentType } from \"@/stores/drivetrain-store\";\nimport { nodeTypes } from \"@/components/nodes\";\nimport { ComponentPalette } from \"@/components/panels/ComponentPalette\";\nimport { PropertiesPanel } from \"@/components/panels/PropertiesPanel\";\nimport { SimulationPanel } from \"@/components/panels/SimulationPanel\";\nimport { SimulationView } from \"@/components/panels/SimulationView\";\nimport { Button } from \"@/components/ui/button\";\n\n// Custom edge styles\nconst edgeTypes = {};\n\nconst defaultEdgeOptions = {\n  style: { strokeWidth: 2 },\n  animated: false,\n};\n\nexport function DrivetrainEditor() {\n  const [showSimulationView, setShowSimulationView] = useState(false);\n\n  const nodes = useDrivetrainStore((s) => s.nodes);\n  const edges = useDrivetrainStore((s) => s.edges);\n  const onNodesChange = useDrivetrainStore((s) => s.onNodesChange);\n  const onEdgesChange = useDrivetrainStore((s) => s.onEdgesChange);\n  const addNode = useDrivetrainStore((s) => s.addNode);\n  const addEdge_ = useDrivetrainStore((s) => s.addEdge);\n  const setSelectedNode = useDrivetrainStore((s) => s.setSelectedNode);\n\n  const onConnect = useCallback(\n    (connection: Connection) => {\n      // Determine edge type based on handle names\n      const edgeType =\n        connection.sourceHandle?.includes(\"electrical\") ||\n        connection.targetHandle?.includes(\"electrical\")\n          ? \"electrical\"\n          : \"mechanical\";\n\n      const newEdge: Edge = {\n        id: `e-${connection.source}-${connection.target}-${Date.now()}`,\n        source: connection.source!,\n        target: connection.target!,\n        sourceHandle: connection.sourceHandle,\n        targetHandle: connection.targetHandle,\n        style: {\n          stroke: edgeType === \"mechanical\" ? \"#10b981\" : \"#f59e0b\",\n          strokeWidth: 2,\n        },\n        animated: edgeType === \"electrical\",\n      };\n\n      addEdge_(newEdge);\n    },\n    [addEdge_]\n  );\n\n  const onDragOver = useCallback((event: React.DragEvent) => {\n    event.preventDefault();\n    event.dataTransfer.dropEffect = \"move\";\n  }, []);\n\n  const onDrop = useCallback(\n    (event: React.DragEvent) => {\n      event.preventDefault();\n\n      const type = event.dataTransfer.getData(\"application/reactflow\") as ComponentType;\n      if (!type) return;\n\n      // Get position from drop coordinates\n      const reactFlowBounds = event.currentTarget.getBoundingClientRect();\n      const position = {\n        x: event.clientX - reactFlowBounds.left - 70,\n        y: event.clientY - reactFlowBounds.top - 50,\n      };\n\n      addNode(type, position);\n    },\n    [addNode]\n  );\n\n  const onPaneClick = useCallback(() => {\n    setSelectedNode(null);\n  }, [setSelectedNode]);\n\n  return (\n    <div className=\"h-screen flex flex-col bg-black\">\n      {/* Header */}\n      <header className=\"h-14 flex items-center justify-between px-4 border-b border-subtle bg-dark\">\n        <div className=\"flex items-center\">\n          <h1 className=\"text-lg font-semibold text-primary\">Gearbox Analyzer</h1>\n          <span className=\"ml-4 text-sm text-muted\">\n            Visual Drivetrain Simulation Tool\n          </span>\n        </div>\n\n        <Button\n          type=\"button\"\n          variant=\"accent\"\n          onClick={() => setShowSimulationView(true)}\n        >\n          <BarChart3 className=\"h-4 w-4 mr-2\" />\n          Open Simulation\n        </Button>\n      </header>\n\n      {/* Main content */}\n      <div className=\"flex-1 flex overflow-hidden\">\n        {/* Left sidebar - Component Palette */}\n        <ComponentPalette />\n\n        {/* Center - React Flow canvas */}\n        <div className=\"flex-1 flex flex-col\">\n          <div className=\"flex-1\">\n            <ReactFlow\n              nodes={nodes}\n              edges={edges}\n              onNodesChange={onNodesChange}\n              onEdgesChange={onEdgesChange}\n              onConnect={onConnect}\n              onDragOver={onDragOver}\n              onDrop={onDrop}\n              onPaneClick={onPaneClick}\n              nodeTypes={nodeTypes}\n              edgeTypes={edgeTypes}\n              defaultEdgeOptions={defaultEdgeOptions}\n              fitView\n              proOptions={{ hideAttribution: true }}\n              className=\"bg-black\"\n            >\n              <Background\n                variant={BackgroundVariant.Dots}\n                gap={20}\n                size={1}\n                color=\"#2a2a2a\"\n              />\n              <Controls className=\"bg-surface border-subtle [&>button]:bg-surface [&>button]:border-subtle [&>button]:text-primary [&>button:hover]:bg-subtle\" />\n              <MiniMap\n                className=\"!bg-surface\"\n                nodeColor={(node) => {\n                  switch (node.data?.componentType) {\n                    case \"engine\":\n                      return \"#dc2626\";\n                    case \"motor\":\n                      return \"#2563eb\";\n                    case \"gearbox\":\n                      return \"#9333ea\";\n                    case \"planetary\":\n                      return \"#0d9488\";\n                    case \"battery\":\n                      return \"#d97706\";\n                    case \"vehicle\":\n                      return \"#16a34a\";\n                    default:\n                      return \"#6b7280\";\n                  }\n                }}\n              />\n            </ReactFlow>\n          </div>\n\n          {/* Bottom panel - Simulation */}\n          <SimulationPanel />\n        </div>\n\n        {/* Right sidebar - Properties */}\n        <PropertiesPanel />\n      </div>\n\n      {/* Full-screen Simulation View */}\n      {showSimulationView && (\n        <SimulationView onClose={() => setShowSimulationView(false)} />\n      )}\n    </div>\n  );\n}\n"],"names":[],"mappings":";;;;;AAEA;AACA;AAWA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAtBA;;;;;;;;;;;;;AAwBA,qBAAqB;AACrB,MAAM,YAAY,CAAC;AAEnB,MAAM,qBAAqB;IACzB,OAAO;QAAE,aAAa;IAAE;IACxB,UAAU;AACZ;AAEO,SAAS;IACd,MAAM,CAAC,oBAAoB,sBAAsB,GAAG,IAAA,iNAAQ,EAAC;IAE7D,MAAM,QAAQ,IAAA,kLAAkB,EAAC,CAAC,IAAM,EAAE,KAAK;IAC/C,MAAM,QAAQ,IAAA,kLAAkB,EAAC,CAAC,IAAM,EAAE,KAAK;IAC/C,MAAM,gBAAgB,IAAA,kLAAkB,EAAC,CAAC,IAAM,EAAE,aAAa;IAC/D,MAAM,gBAAgB,IAAA,kLAAkB,EAAC,CAAC,IAAM,EAAE,aAAa;IAC/D,MAAM,UAAU,IAAA,kLAAkB,EAAC,CAAC,IAAM,EAAE,OAAO;IACnD,MAAM,WAAW,IAAA,kLAAkB,EAAC,CAAC,IAAM,EAAE,OAAO;IACpD,MAAM,kBAAkB,IAAA,kLAAkB,EAAC,CAAC,IAAM,EAAE,eAAe;IAEnE,MAAM,YAAY,IAAA,oNAAW,EAC3B,CAAC;QACC,4CAA4C;QAC5C,MAAM,WACJ,WAAW,YAAY,EAAE,SAAS,iBAClC,WAAW,YAAY,EAAE,SAAS,gBAC9B,eACA;QAEN,MAAM,UAAgB;YACpB,IAAI,CAAC,EAAE,EAAE,WAAW,MAAM,CAAC,CAAC,EAAE,WAAW,MAAM,CAAC,CAAC,EAAE,KAAK,GAAG,IAAI;YAC/D,QAAQ,WAAW,MAAM;YACzB,QAAQ,WAAW,MAAM;YACzB,cAAc,WAAW,YAAY;YACrC,cAAc,WAAW,YAAY;YACrC,OAAO;gBACL,QAAQ,aAAa,eAAe,YAAY;gBAChD,aAAa;YACf;YACA,UAAU,aAAa;QACzB;QAEA,SAAS;IACX,GACA;QAAC;KAAS;IAGZ,MAAM,aAAa,IAAA,oNAAW,EAAC,CAAC;QAC9B,MAAM,cAAc;QACpB,MAAM,YAAY,CAAC,UAAU,GAAG;IAClC,GAAG,EAAE;IAEL,MAAM,SAAS,IAAA,oNAAW,EACxB,CAAC;QACC,MAAM,cAAc;QAEpB,MAAM,OAAO,MAAM,YAAY,CAAC,OAAO,CAAC;QACxC,IAAI,CAAC,MAAM;QAEX,qCAAqC;QACrC,MAAM,kBAAkB,MAAM,aAAa,CAAC,qBAAqB;QACjE,MAAM,WAAW;YACf,GAAG,MAAM,OAAO,GAAG,gBAAgB,IAAI,GAAG;YAC1C,GAAG,MAAM,OAAO,GAAG,gBAAgB,GAAG,GAAG;QAC3C;QAEA,QAAQ,MAAM;IAChB,GACA;QAAC;KAAQ;IAGX,MAAM,cAAc,IAAA,oNAAW,EAAC;QAC9B,gBAAgB;IAClB,GAAG;QAAC;KAAgB;IAEpB,qBACE,8OAAC;QAAI,WAAU;;0BAEb,8OAAC;gBAAO,WAAU;;kCAChB,8OAAC;wBAAI,WAAU;;0CACb,8OAAC;gCAAG,WAAU;0CAAqC;;;;;;0CACnD,8OAAC;gCAAK,WAAU;0CAA0B;;;;;;;;;;;;kCAK5C,8OAAC,oKAAM;wBACL,MAAK;wBACL,SAAQ;wBACR,SAAS,IAAM,sBAAsB;;0CAErC,8OAAC,+NAAS;gCAAC,WAAU;;;;;;4BAAiB;;;;;;;;;;;;;0BAM1C,8OAAC;gBAAI,WAAU;;kCAEb,8OAAC,4LAAgB;;;;;kCAGjB,8OAAC;wBAAI,WAAU;;0CACb,8OAAC;gCAAI,WAAU;0CACb,cAAA,8OAAC,sLAAS;oCACR,OAAO;oCACP,OAAO;oCACP,eAAe;oCACf,eAAe;oCACf,WAAW;oCACX,YAAY;oCACZ,QAAQ;oCACR,aAAa;oCACb,WAAW,wLAAS;oCACpB,WAAW;oCACX,oBAAoB;oCACpB,OAAO;oCACP,YAAY;wCAAE,iBAAiB;oCAAK;oCACpC,WAAU;;sDAEV,8OAAC,uLAAU;4CACT,SAAS,8LAAiB,CAAC,IAAI;4CAC/B,KAAK;4CACL,MAAM;4CACN,OAAM;;;;;;sDAER,8OAAC,qLAAQ;4CAAC,WAAU;;;;;;sDACpB,8OAAC,oLAAO;4CACN,WAAU;4CACV,WAAW,CAAC;gDACV,OAAQ,KAAK,IAAI,EAAE;oDACjB,KAAK;wDACH,OAAO;oDACT,KAAK;wDACH,OAAO;oDACT,KAAK;wDACH,OAAO;oDACT,KAAK;wDACH,OAAO;oDACT,KAAK;wDACH,OAAO;oDACT,KAAK;wDACH,OAAO;oDACT;wDACE,OAAO;gDACX;4CACF;;;;;;;;;;;;;;;;;0CAMN,8OAAC,0LAAe;;;;;;;;;;;kCAIlB,8OAAC,0LAAe;;;;;;;;;;;YAIjB,oCACC,8OAAC,wLAAc;gBAAC,SAAS,IAAM,sBAAsB;;;;;;;;;;;;AAI7D","debugId":null}},
    {"offset": {"line": 9421, "column": 0}, "map": {"version":3,"sources":["file:///home/john/p412/gearbox/web/apps/gearbox-analyzer/app/page.tsx"],"sourcesContent":["\"use client\";\n\nimport { DrivetrainEditor } from \"@/components/DrivetrainEditor\";\n\nexport default function Home() {\n  return <DrivetrainEditor />;\n}\n"],"names":[],"mappings":";;;;;AAEA;AAFA;;;AAIe,SAAS;IACtB,qBAAO,8OAAC,kLAAgB;;;;;AAC1B","debugId":null}}]
}